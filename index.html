<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Estructura de Nodos AR • A-Frame</title>
    <meta name="description" content="Visualización 3D/AR de estructura con nodos y elementos conectados">
    
    <!-- A-Frame core -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    
    <!-- A-Frame AR.js para realidad aumentada -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        overflow: hidden; /* Importante para AR */
      }
      
      .info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 11px;
        z-index: 1000;
        max-width: 250px;
        backdrop-filter: blur(5px);
      }
      
      .controls {
        position: absolute;
        bottom: 60px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px;
        border-radius: 5px;
        font-size: 10px;
        z-index: 1000;
        backdrop-filter: blur(5px);
      }
      
      .deformation-control {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 11px;
        z-index: 1000;
        text-align: center;
        backdrop-filter: blur(5px);
      }
      
      .deformation-control button {
        padding: 8px 16px;
        background: #4488ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.3s ease;
        touch-action: manipulation; /* Mejor para móviles */
      }
      
      .deformation-control button:hover,
      .deformation-control button:active {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
      
      .mode-selector {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 11px;
        z-index: 1000;
        text-align: center;
        backdrop-filter: blur(5px);
      }
      
      .mode-selector button {
        padding: 8px 12px;
        margin: 2px;
        background: #44ff44;
        color: black;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
        touch-action: manipulation;
      }
      
      .mode-selector button.active {
        background: #ffff44;
        color: black;
      }
      
      .debug-info {
        margin-top: 8px;
        font-size: 9px;
        color: #ccc;
        max-height: 120px;
        overflow-y: auto;
      }
      
      /* Ocultar elementos en modo AR para mejor experiencia */
      .ar-mode .info,
      .ar-mode .controls {
        opacity: 0.7;
        font-size: 10px;
      }
      
      /* Indicador de carga */
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 2000;
        text-align: center;
        display: none;
      }
      
      .loading.show {
        display: block;
      }
    </style>
  </head>
  <body>
    
    <div id="loading" class="loading">
      <h3>Iniciando cámara...</h3>
      <p>Permite el acceso a la cámara para AR</p>
    </div>
    
    <div class="info">
      <h3>Estructura de Nodos AR</h3>
      <p><strong>Nodos:</strong> 8 (esferas rojas)</p>
      <p><strong>Elementos:</strong> 8 (líneas azules)</p>
      <p><strong>Escala:</strong> 0.3 (30% del tamaño)</p>
      <p id="mode-info"><strong>Modo:</strong> 3D Normal</p>
      <div id="debug-info" class="debug-info">
        <strong>Debug:</strong> Presiona el botón para ver deformaciones...
      </div>
    </div>
    
    <div class="deformation-control">
      <button id="btn-deformacion">Mostrar Deformada</button>
      <p><small>Desplazamientos amplificados 5000x</small></p>
    </div>
    
    <div class="mode-selector">
      <p><strong>Modo de Vista:</strong></p>
      <button id="btn-3d" class="active">3D Normal</button>
      <button id="btn-ar">AR Cámara</button>
    </div>
    
    <div class="controls">
      <strong id="controls-text">Controles 3D:</strong><br>
      <span id="controls-desc">Toca y arrastra: Rotar | Pellizca: Zoom</span>
    </div>

    <!-- Escena A-Frame con soporte AR -->
    <a-scene 
      id="main-scene"
      embedded 
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
      background="color: #f0f0f0"
      cursor="rayOrigin: mouse"
      device-orientation-permission-ui="enabled: false"
      loading-screen="enabled: false"
      vr-mode-ui="enabled: false">
      
      <!-- Marker AR (solo visible en modo AR) -->
      <a-marker 
        id="ar-marker"
        preset="hiro" 
        smooth="true" 
        smoothCount="10" 
        smoothTolerance="0.01" 
        smoothThreshold="5"
        visible="false">
        
        <!-- La estructura se colocará aquí en modo AR -->
        <a-entity id="estructura-ar" visible="false"></a-entity>
        
      </a-marker>
      
      <!-- Iluminación -->
      <a-light type="ambient" color="#404040"></a-light>
      <a-light type="directional" position="2 4 2" color="#ffffff" intensity="0.8"></a-light>
      
      <!-- Entidad principal para modo 3D normal -->
      <a-entity id="estructura-principal">
        
        <!-- Plano de referencia (suelo) - Solo en modo 3D -->
        <a-plane id="suelo" 
                 position="4 -1 0" 
                 rotation="-90 0 0" 
                 width="12" 
                 height="8" 
                 color="#e8e8e8" 
                 opacity="0.7"
                 shadow="receive: true"></a-plane>
        
        <!-- Grid de referencia - Solo en modo 3D -->
        <a-entity id="grid">
          <!-- Líneas verticales -->
          <a-cylinder position="0 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="8 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <!-- Líneas horizontales -->
          <a-cylinder position="4 0 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 6 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
        </a-entity>

        <!-- NODOS (Esferas) -->
        <!-- Nodo 1: [0,0] -->
        <a-sphere id="nodo-1" position="0 0 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="1" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 2: [0,3] -->
        <a-sphere id="nodo-2" position="0 3 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="2" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 3: [0,6] -->
        <a-sphere id="nodo-3" position="0 6 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="3" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 4: [4,6] -->
        <a-sphere id="nodo-4" position="4 6 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="4" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 5: [4,3] -->
        <a-sphere id="nodo-5" position="4 3 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="5" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 6: [4,0] -->
        <a-sphere id="nodo-6" position="4 0 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="6" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 7: [8,3] -->
        <a-sphere id="nodo-7" position="8 3 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="7" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 8: [8,0] -->
        <a-sphere id="nodo-8" position="8 0 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="8" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>

        <!-- Texto informativo en 3D -->
        <a-text id="titulo-3d"
                position="4 8 0" 
                value="Estructura de Nodos y Elementos" 
                align="center" 
                color="#333333" 
                scale="6 6 6"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 20000"></a-text>
        
        <!-- Ejes de coordenadas -->
        <a-entity id="ejes" position="-2 -2 0">
          <!-- Eje X (rojo) -->
          <a-cylinder position="1 0 0" radius="0.1" height="2" rotation="0 0 90" color="#ff0000"></a-cylinder>
          <a-text value="X" position="2.5 0 0" color="#ff0000" scale="4 4 4"></a-text>
          
          <!-- Eje Y (verde) -->
          <a-cylinder position="0 1 0" radius="0.1" height="2" color="#00ff00"></a-cylinder>
          <a-text value="Y" position="0 2.5 0" color="#00ff00" scale="4 4 4"></a-text>
          
          <!-- Eje Z (azul) -->
          <a-cylinder position="0 0 1" radius="0.1" height="2" rotation="90 0 0" color="#0000ff"></a-cylinder>
          <a-text value="Z" position="0 0 2.5" color="#0000ff" scale="4 4 4"></a-text>
        </a-entity>
      </a-entity>
      
      <!-- Cámara para modo 3D normal -->
      <a-camera id="camara-principal" 
                wasd-controls="acceleration: 5"
                look-controls="enabled: true; touchEnabled: true"
                cursor="rayOrigin: mouse"></a-camera>
                
      <!-- Cámara AR (se activa automáticamente en modo AR) -->
      <a-entity id="camara-ar" camera visible="false"></a-entity>
    </a-scene>

    <script>
      // ESCALA DE LA ESTRUCTURA
      const ESCALA = 0.3;
      const ESCALA_AR = 0.05; // Escala más pequeña para AR
      
      // Estado de la aplicación
      let modoAR = false;
      let estructuraDeformada = false;
      let arInitialized = false;
      
      // Datos de desplazamientos idénticos al código original
      const desplazamientos = [
        {x: 0, y: 0, rot: 0},
        {x: -0.000214334467084222, y: -2.92585497916779e-05, rot: 0.000299282917049326},
        {x: -4.51228548254704e-05, y: -5.91445463001043e-05, rot: -0.00125414567113917},
        {x: -5.26077882706616e-05, y: -7.62472910434113e-05, rot: 0.00121519336768121},
        {x: -0.000205459371218351, y: -4.61332875518377e-05, rot: -0.000475039410395658},
        {x: 0, y: 0, rot: 0},
        {x: -0.000209509318349148, y: -1.46081626564844e-05, rot: 0.000595291931114151},
        {x: 0, y: 0, rot: 0}
      ];
      
      const FACTOR_AMPLIFICACION = 5000;
      
      // Conectividad de elementos
      const conectividad = [
        [0, 1], [1, 2], [2, 3], [3, 4], [1, 4], [4, 5], [4, 6], [6, 7]
      ];
      
      // Posiciones originales
      const posicionesOriginales = [
        [0, 0], [0, 3], [0, 6], [4, 6], [4, 3], [4, 0], [8, 3], [8, 0]
      ];
      
      let posicionesActuales = [];
      
      // Función para crear línea (igual que el original)
      function crearLinea(id, punto1, punto2, color = '#4488ff') {
        const lineaExistente = document.getElementById(id);
        if (lineaExistente) {
          lineaExistente.remove();
        }
        
        const linea = document.createElement('a-entity');
        linea.setAttribute('id', id);
        linea.setAttribute('line', {
          start: `${punto1.x} ${punto1.y} ${punto1.z || 0}`,
          end: `${punto2.x} ${punto2.y} ${punto2.z || 0}`,
          color: color,
          linewidth: 19,
          opacity: 0.8
        });
        
        const estructura = modoAR ? 
          document.getElementById('estructura-ar') : 
          document.getElementById('estructura-principal');
        estructura.appendChild(linea);
      }
      
      // Función para actualizar líneas
      function actualizarLineas() {
        for (let i = 0; i < conectividad.length; i++) {
          const nodo1Idx = conectividad[i][0];
          const nodo2Idx = conectividad[i][1];
          const lineaId = `linea-${i + 1}`;
          
          const nodo1 = document.getElementById(`nodo-${nodo1Idx + 1}`);
          const nodo2 = document.getElementById(`nodo-${nodo2Idx + 1}`);
          
          if (nodo1 && nodo2) {
            const pos1 = nodo1.getAttribute('position');
            const pos2 = nodo2.getAttribute('position');
            const color = estructuraDeformada ? '#ff8844' : '#4488ff';
            crearLinea(lineaId, pos1, pos2, color);
          }
        }
      }
      
      // Función para clonar estructura para AR
      function clonarEstructuraParaAR() {
        const estructuraPrincipal = document.getElementById('estructura-principal');
        const estructuraAR = document.getElementById('estructura-ar');
        
        // Limpiar estructura AR
        estructuraAR.innerHTML = '';
        
        // Clonar solo los nodos (sin grid ni suelo para AR)
        for (let i = 1; i <= 8; i++) {
          const nodoOriginal = document.getElementById(`nodo-${i}`);
          if (nodoOriginal) {
            const nodoClonado = nodoOriginal.cloneNode(true);
            nodoClonado.id = `nodo-ar-${i}`;
            estructuraAR.appendChild(nodoClonado);
          }
        }
        
        // Aplicar escala AR
        estructuraAR.setAttribute('scale', `${ESCALA_AR} ${ESCALA_AR} ${ESCALA_AR}`);
        estructuraAR.setAttribute('position', '0 0 0');
      }
      
      // Función para alternar deformación (adaptada para AR)
      function toggleDeformacion() {
        estructuraDeformada = !estructuraDeformada;
        const boton = document.getElementById('btn-deformacion');
        const debugInfo = document.getElementById('debug-info');
        
        let debugText = `<strong>Estado:</strong> ${estructuraDeformada ? 'DEFORMADA' : 'ORIGINAL'}<br>`;
        debugText += `<strong>Modo:</strong> ${modoAR ? 'AR' : '3D'}<br>`;
        debugText += `<strong>Amplificación:</strong> ${FACTOR_AMPLIFICACION}x<br><br>`;
        
        posicionesActuales = [];
        
        // Obtener prefijo según el modo
        const prefijo = modoAR ? 'nodo-ar-' : 'nodo-';
        
        for (let i = 0; i < 8; i++) {
          const nodo = document.getElementById(`${prefijo}${i + 1}`);
          
          if (nodo) {
            let x, y;
            
            if (estructuraDeformada) {
              const desplX = desplazamientos[i].x * FACTOR_AMPLIFICACION;
              const desplY = desplazamientos[i].y * FACTOR_AMPLIFICACION;
              x = posicionesOriginales[i][0] + desplX;
              y = posicionesOriginales[i][1] + desplY;
              const rotZ = desplazamientos[i].rot * (180 / Math.PI) * FACTOR_AMPLIFICACION;
              
              nodo.setAttribute('position', {x: x, y: y, z: 0});
              nodo.setAttribute('rotation', {x: 0, y: 0, z: rotZ});
              nodo.setAttribute('material', 'color', '#ff8844');
              
              if (desplX !== 0 || desplY !== 0 || rotZ !== 0) {
                debugText += `<span style="color: #ff8844;">N${i + 1}: [${x.toFixed(1)}, ${y.toFixed(1)}] rot:${rotZ.toFixed(0)}°</span><br>`;
              } else {
                debugText += `N${i + 1}: [${x}, ${y}] sin desplazamiento<br>`;
              }
            } else {
              x = posicionesOriginales[i][0];
              y = posicionesOriginales[i][1];
              
              nodo.setAttribute('position', {x: x, y: y, z: 0});
              nodo.setAttribute('rotation', {x: 0, y: 0, z: 0});
              nodo.setAttribute('material', 'color', '#ff4444');
              
              debugText += `N${i + 1}: [${x}, ${y}] original<br>`;
            }
            
            posicionesActuales[i] = {x: x, y: y};
          }
        }
        
        // Actualizar líneas
        setTimeout(() => {
          actualizarLineas();
        }, 150);
        
        if (debugInfo) {
          debugInfo.innerHTML = debugText;
        }
        
        if (boton) {
          boton.textContent = estructuraDeformada ? 'Mostrar Original' : 'Mostrar Deformada';
          boton.style.backgroundColor = estructuraDeformada ? '#ff6644' : '#4488ff';
        }
      }
      
      // Función para cambiar entre modo 3D y AR
      function cambiarModo(nuevoModoAR) {
        const loading = document.getElementById('loading');
        const scene = document.getElementById('main-scene');
        const btn3D = document.getElementById('btn-3d');
        const btnAR = document.getElementById('btn-ar');
        const modeInfo = document.getElementById('mode-info');
        const controlsText = document.getElementById('controls-text');
        const controlsDesc = document.getElementById('controls-desc');
        
        if (nuevoModoAR === modoAR) return; // Ya estamos en ese modo
        
        loading.classList.add('show');
        modoAR = nuevoModoAR;
        
        setTimeout(() => {
          if (modoAR) {
            // Activar modo AR
            scene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;');
            scene.setAttribute('embedded', true);
            scene.setAttribute('background', 'color: transparent');
            
            // Ocultar elementos 3D y mostrar AR
            document.getElementById('estructura-principal').setAttribute('visible', false);
            document.getElementById('camara-principal').setAttribute('visible', false);
            document.getElementById('ar-marker').setAttribute('visible', true);
            document.getElementById('estructura-ar').setAttribute('visible', true);
            
            // Clonar estructura para AR
            clonarEstructuraParaAR();
            
            // Actualizar UI
            document.body.classList.add('ar-mode');
            btn3D.classList.remove('active');
            btnAR.classList.add('active');
            modeInfo.innerHTML = '<strong>Modo:</strong> AR Cámara';
            controlsText.textContent = 'Controles AR:';
            controlsDesc.textContent = 'Apunta la cámara al marcador Hiro';
            
            console.log('✅ Modo AR activado');
            
          } else {
            // Activar modo 3D
            scene.removeAttribute('arjs');
            scene.setAttribute('embedded', false);
            scene.setAttribute('background', 'color: #f0f0f0');
            
            // Mostrar elementos 3D y ocultar AR
            document.getElementById('estructura-principal').setAttribute('visible', true);
            document.getElementById('camara-principal').setAttribute('visible', true);
            document.getElementById('ar-marker').setAttribute('visible', false);
            document.getElementById('estructura-ar').setAttribute('visible', false);
            
            // Actualizar UI
            document.body.classList.remove('ar-mode');
            btn3D.classList.add('active');
            btnAR.classList.remove('active');
            modeInfo.innerHTML = '<strong>Modo:</strong> 3D Normal';
            controlsText.textContent = 'Controles 3D:';
            controlsDesc.textContent = 'Toca y arrastra: Rotar | Pellizca: Zoom';
            
            console.log('✅ Modo 3D activado');
          }
          
          // Actualizar líneas para el nuevo modo
          setTimeout(() => {
            actualizarLineas();
            loading.classList.remove('show');
          }, 500);
          
        }, 100);
      }
      
      // Inicialización cuando se carga la página
      window.addEventListener('DOMContentLoaded', function() {
        const estructura = document.getElementById('estructura-principal');
        const camara = document.getElementById('camara-principal');
        const boton = document.getElementById('btn-deformacion');
        const btn3D = document.getElementById('btn-3d');
        const btnAR = document.getElementById('btn-ar');
        
        // Configurar event listeners
        if (boton) {
          boton.addEventListener('click', toggleDeformacion);
        }
        
        if (btn3D) {
          btn3D.addEventListener('click', () => cambiarModo(false));
        }
        
        if (btnAR) {
          btnAR.addEventListener('click', () => cambiarModo(true));
        }
        
        // Aplicar escala inicial
        estructura.setAttribute('scale', `${ESCALA} ${ESCALA} ${ESCALA}`);
        
        // Configurar cámara 3D
        const Lv1 = 3, Lh1 = 4;
        const dimensionX = Lh1 * 2 * ESCALA;
        const dimensionY = Lv1 * 2 * ESCALA;
        const centroX = dimensionX / 2;
        const centroY = dimensionY / 2;
        const distanciaOptima = Math.max(dimensionX, dimensionY) * 3;
        const alturaOptima = dimensionY * 1.5;
        
        camara.setAttribute('position', `${centroX} ${alturaOptima} ${distanciaOptima}`);
        camara.setAttribute('look-at', `${centroX} ${centroY} 0`);
        
        // Crear líneas iniciales
        setTimeout(() => {
          actualizarLineas();
        }, 500);
        
        console.log('🚀 Sistema AR/3D listo');
      });
      
      // Detectar cuando AR se inicializa
      document.addEventListener('DOMContentLoaded', function() {
        const scene = document.getElementById('main-scene');
        
        scene.addEventListener('arjs-video-loaded', function() {
          console.log('📹 Cámara AR cargada');
          arInitialized = true;
        });
        
        scene.addEventListener('markerFound', function() {
          console.log('🎯 Marcador AR detectado');
          document.getElementById('estructura-ar').setAttribute('visible', true);
        });
        
        scene.addEventListener('markerLost', function() {
          console.log('❌ Marcador AR perdido');
        });
      });
    </script>
  </body>
</html>
