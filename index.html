<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Estructura AR - Funcional</title>
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #000;
            touch-action: none;
        }
        
        .panel {
            position: fixed;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            border: 2px solid #00ff00;
        }
        
        .info {
            top: 10px;
            left: 10px;
            max-width: 250px;
            font-size: 14px;
        }
        
        .controls {
            bottom: 20px;
            right: 20px;
            text-align: center;
        }
        
        .controls button {
            display: block;
            width: 150px;
            margin: 8px 0;
            padding: 12px;
            background: #00aa00;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            touch-action: manipulation;
        }
        
        .controls button:hover {
            background: #00dd00;
        }
        
        .controls button:active {
            background: #008800;
            transform: scale(0.95);
        }
        
        .controls button.active {
            background: #ff6600;
        }
        
        .controls button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #camera-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            display: none;
        }
        
        #camera-video.show {
            display: block;
        }
        
        .touch-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 500;
            background: transparent;
            display: none;
        }
        
        .touch-area.active {
            display: block;
        }
        
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
            display: none;
            border: 2px solid #0088ff;
        }
        
        .modal.show {
            display: block;
        }
        
        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #0088ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            max-width: 250px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1500;
            display: none;
            border: 1px solid #00ff00;
        }
        
        .debug.show {
            display: block;
        }
        
        .debug-toggle {
            position: fixed;
            top: 10px;
            right: 280px;
            background: #00aa00;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1500;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Info Panel -->
    <div class="panel info">
        <h3>üèóÔ∏è Estructura AR</h3>
        <p><strong>Estado:</strong> <span id="status">Modo 3D Normal</span></p>
        <p><strong>Nodos:</strong> 8 esferas rojas</p>
        <p><strong>Elementos:</strong> 8 l√≠neas azules</p>
    </div>
    
    <!-- Controls Panel -->
    <div class="panel controls">
        <button id="btn-3d" class="active">üñ•Ô∏è Modo 3D</button>
        <button id="btn-ar">üì± Modo AR</button>
        <button id="btn-place" disabled>üéØ Colocar</button>
        <button id="btn-deform" disabled>üîß Deformar</button>
        <button id="btn-reset">üîÑ Reset</button>
    </div>
    
    <!-- Debug -->
    <button class="debug-toggle" onclick="toggleDebug()">üêõ</button>
    <div id="debug" class="debug">
        <strong>DEBUG:</strong><br>
        <div id="debug-log">Aplicaci√≥n iniciada</div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <h3 id="modal-title">Estado</h3>
        <p id="modal-message">Mensaje</p>
        <div id="modal-buttons"></div>
    </div>
    
    <!-- Touch Area -->
    <div id="touch-area" class="touch-area"></div>
    
    <!-- Camera Video -->
    <video id="camera-video" autoplay muted playsinline></video>
    
    <!-- A-Frame Scene -->
    <a-scene 
        id="scene"
        embedded 
        background="color: #f0f0f0"
        loading-screen="enabled: false"
        vr-mode-ui="enabled: false">
        
        <!-- Lights -->
        <a-light type="ambient" color="#666666"></a-light>
        <a-light type="directional" position="0 5 5" intensity="0.8"></a-light>
        
        <!-- Structure Container -->
        <a-entity id="structure" position="0 0 0" scale="1 1 1">
            
            <!-- Base Plane -->
            <a-plane 
                position="4 -0.5 0" 
                rotation="-90 0 0" 
                width="12" 
                height="8" 
                color="#ffffff" 
                opacity="0.3"></a-plane>
            
            <!-- Nodes -->
            <a-sphere id="node1" position="0 0 0" radius="0.3" color="#ff4444">
                <a-text value="1" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="node2" position="0 3 0" radius="0.3" color="#ff4444">
                <a-text value="2" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="node3" position="0 6 0" radius="0.3" color="#ff4444">
                <a-text value="3" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="node4" position="4 6 0" radius="0.3" color="#ff4444">
                <a-text value="4" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="node5" position="4 3 0" radius="0.3" color="#ff4444">
                <a-text value="5" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="node6" position="4 0 0" radius="0.3" color="#ff4444">
                <a-text value="6" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="node7" position="8 3 0" radius="0.3" color="#ff4444">
                <a-text value="7" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="node8" position="8 0 0" radius="0.3" color="#ff4444">
                <a-text value="8" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
        </a-entity>
        
        <!-- Camera -->
        <a-camera 
            id="camera" 
            position="12 9 18" 
            look-at="4 3 0"></a-camera>
    </a-scene>

    <script>
        // Global variables
        let isAR = false;
        let isPlaced = false;
        let isDeformed = false;
        let cameraStream = null;
        let debugVisible = false;
        let debugLog = ['Aplicaci√≥n iniciada'];
        
        // Original positions
        const originalPositions = [
            [0, 0], [0, 3], [0, 6], [4, 6], [4, 3], [4, 0], [8, 3], [8, 0]
        ];
        
        // Deformation data
        const deformations = [
            {x: 0, y: 0}, 
            {x: -0.000214334467084222, y: -2.92585497916779e-05}, 
            {x: -4.51228548254704e-05, y: -5.91445463001043e-05}, 
            {x: -5.26077882706616e-05, y: -7.62472910434113e-05}, 
            {x: -0.000205459371218351, y: -4.61332875518377e-05}, 
            {x: 0, y: 0}, 
            {x: -0.000209509318349148, y: -1.46081626564844e-05}, 
            {x: 0, y: 0}
        ];
        
        const AMPLIFICATION = 8000;
        
        // Debug system
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            debugLog.push(entry);
            
            if (debugLog.length > 20) debugLog.shift();
            
            console.log(entry);
            
            if (debugVisible) {
                document.getElementById('debug-log').innerHTML = debugLog.join('<br>');
            }
        }
        
        function toggleDebug() {
            debugVisible = !debugVisible;
            const panel = document.getElementById('debug');
            if (debugVisible) {
                panel.classList.add('show');
                document.getElementById('debug-log').innerHTML = debugLog.join('<br>');
            } else {
                panel.classList.remove('show');
            }
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            log(message);
        }
        
        function showModal(title, message, buttons = []) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const buttonsContainer = document.getElementById('modal-buttons');
            buttonsContainer.innerHTML = '';
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.textContent = btn.text;
                button.onclick = btn.action;
                buttonsContainer.appendChild(button);
            });
            
            modal.classList.add('show');
            
            if (buttons.length === 0) {
                setTimeout(() => {
                    modal.classList.remove('show');
                }, 3000);
            }
        }
        
        function hideModal() {
            document.getElementById('modal').classList.remove('show');
        }
        
        // Mode switching
        function switch3D() {
            log('Cambiando a modo 3D');
            
            // Stop camera if active
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Hide camera video
            document.getElementById('camera-video').classList.remove('show');
            document.getElementById('touch-area').classList.remove('active');
            
            // Remove AR structure if exists
            const arStructure = document.getElementById('ar-structure');
            if (arStructure) {
                arStructure.remove();
            }
            
            // Configure A-Frame scene
            const scene = document.getElementById('scene');
            scene.setAttribute('background', 'color: #f0f0f0');
            
            const camera = document.getElementById('camera');
            camera.setAttribute('position', '12 9 18');
            camera.setAttribute('look-at', '4 3 0');
            camera.setAttribute('wasd-controls', 'enabled: true');
            camera.setAttribute('look-controls', 'enabled: true');
            
            // Show structure
            const structure = document.getElementById('structure');
            structure.setAttribute('visible', 'true');
            structure.setAttribute('position', '0 0 0');
            structure.setAttribute('scale', '1 1 1');
            
            // Update state
            isAR = false;
            isPlaced = true;
            
            // Update UI
            document.getElementById('btn-3d').classList.add('active');
            document.getElementById('btn-ar').classList.remove('active');
            document.getElementById('btn-place').disabled = true;
            document.getElementById('btn-deform').disabled = false;
            
            updateStatus('Modo 3D - Estructura visible');
            createLines();
        }
        
        async function switchAR() {
            log('Iniciando modo AR');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showModal('Error', 'Tu dispositivo no soporta c√°mara', [
                    {text: 'OK', action: hideModal}
                ]);
                return;
            }
            
            try {
                showModal('C√°mara', 'Solicitando permisos de c√°mara...');
                
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                log('Permisos de c√°mara obtenidos');
                
                // Setup camera video
                const video = document.getElementById('camera-video');
                video.srcObject = cameraStream;
                video.classList.add('show');
                
                // Configure A-Frame for AR
                const scene = document.getElementById('scene');
                scene.setAttribute('background', 'color: transparent');
                
                const camera = document.getElementById('camera');
                camera.setAttribute('position', '0 0 0');
                camera.setAttribute('rotation', '0 0 0');
                camera.removeAttribute('look-at');
                camera.setAttribute('wasd-controls', 'enabled: false');
                camera.setAttribute('look-controls', 'enabled: false');
                
                // Hide A-Frame structure
                const structure = document.getElementById('structure');
                structure.setAttribute('visible', 'false');
                
                // Setup touch area
                const touchArea = document.getElementById('touch-area');
                touchArea.classList.add('active');
                touchArea.onclick = handleTouch;
                touchArea.ontouchstart = handleTouch;
                
                // Update state
                isAR = true;
                isPlaced = false;
                
                // Update UI
                document.getElementById('btn-ar').classList.add('active');
                document.getElementById('btn-3d').classList.remove('active');
                document.getElementById('btn-place').disabled = false;
                document.getElementById('btn-deform').disabled = true;
                
                hideModal();
                updateStatus('Modo AR - Toca la pantalla para colocar');
                
            } catch (error) {
                log(`Error: ${error.message}`);
                showModal('Error de C√°mara', `No se pudo acceder a la c√°mara: ${error.message}`, [
                    {text: 'Reintentar', action: switchAR},
                    {text: 'Cancelar', action: hideModal}
                ]);
            }
        }
        
        function handleTouch(event) {
            if (!isAR || isPlaced) return;
            
            event.preventDefault();
            log('Toque detectado - colocando estructura');
            
            placeStructure();
        }
        
        function placeStructure() {
            log('Colocando estructura');
            
            if (isAR) {
                createARStructure();
            } else {
                const structure = document.getElementById('structure');
                structure.setAttribute('visible', 'true');
            }
            
            isPlaced = true;
            
            document.getElementById('btn-place').disabled = true;
            document.getElementById('btn-deform').disabled = false;
            document.getElementById('touch-area').classList.remove('active');
            
            updateStatus('Estructura colocada - Usa deformar para ver cambios');
        }
        
        function createARStructure() {
            log('Creando estructura AR con HTML');
            
            // Remove existing AR structure
            const existing = document.getElementById('ar-structure');
            if (existing) existing.remove();
            
            // Create container
            const container = document.createElement('div');
            container.id = 'ar-structure';
            container.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 800;
                pointer-events: none;
                width: 400px;
                height: 300px;
            `;
            
            // Node positions for HTML layout
            const nodePositions = [
                {x: 0, y: 0}, {x: 0, y: 100}, {x: 0, y: 200},
                {x: 133, y: 200}, {x: 133, y: 100}, {x: 133, y: 0},
                {x: 266, y: 100}, {x: 266, y: 0}
            ];
            
            // Create nodes
            nodePositions.forEach((pos, i) => {
                const node = document.createElement('div');
                node.id = `ar-node-${i + 1}`;
                node.style.cssText = `
                    position: absolute;
                    left: ${pos.x}px;
                    top: ${pos.y}px;
                    width: 40px;
                    height: 40px;
                    background: radial-gradient(circle, #ff4444, #aa0000);
                    border-radius: 50%;
                    border: 3px solid #ffffff;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 16px;
                    box-shadow: 0 0 15px rgba(255,68,68,0.8);
                    transform: translate(-50%, -50%);
                    animation: glow 2s infinite alternate;
                `;
                node.textContent = i + 1;
                container.appendChild(node);
            });
            
            // Create connections
            const connections = [
                [0, 1], [1, 2], [2, 3], [3, 4], [1, 4], [4, 5], [4, 6], [6, 7]
            ];
            
            connections.forEach(([from, to]) => {
                const fromPos = nodePositions[from];
                const toPos = nodePositions[to];
                
                const dx = toPos.x - fromPos.x;
                const dy = toPos.y - fromPos.y;
                const length = Math.sqrt(dx*dx + dy*dy);
                const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                
                const line = document.createElement('div');
                line.style.cssText = `
                    position: absolute;
                    left: ${fromPos.x}px;
                    top: ${fromPos.y}px;
                    width: ${length}px;
                    height: 4px;
                    background: linear-gradient(90deg, #0088ff, #0066cc);
                    transform-origin: 0 50%;
                    transform: rotate(${angle}deg);
                    box-shadow: 0 0 8px rgba(0,136,255,0.6);
                    opacity: 0.9;
                `;
                container.appendChild(line);
            });
            
            // Add glow animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes glow {
                    0% { box-shadow: 0 0 15px rgba(255,68,68,0.8); }
                    100% { box-shadow: 0 0 25px rgba(255,68,68,1); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(container);
            
            log('Estructura AR creada');
        }
        
        function toggleDeformation() {
            if (!isPlaced) return;
            
            isDeformed = !isDeformed;
            log(`${isDeformed ? 'Aplicando' : 'Removiendo'} deformaci√≥n`);
            
            if (isAR) {
                // Deform AR structure
                const nodePositions = [
                    {x: 0, y: 0}, {x: 0, y: 100}, {x: 0, y: 200},
                    {x: 133, y: 200}, {x: 133, y: 100}, {x: 133, y: 0},
                    {x: 266, y: 100}, {x: 266, y: 0}
                ];
                
                for (let i = 0; i < 8; i++) {
                    const node = document.getElementById(`ar-node-${i + 1}`);
                    if (node) {
                        let x, y;
                        
                        if (isDeformed) {
                            const defX = deformations[i].x * AMPLIFICATION * 0.5;
                            const defY = deformations[i].y * AMPLIFICATION * 0.5;
                            x = nodePositions[i].x + defX;
                            y = nodePositions[i].y + defY;
                            node.style.background = 'radial-gradient(circle, #ff8844, #cc4400)';
                        } else {
                            x = nodePositions[i].x;
                            y = nodePositions[i].y;
                            node.style.background = 'radial-gradient(circle, #ff4444, #aa0000)';
                        }
                        
                        node.style.left = x + 'px';
                        node.style.top = y + 'px';
                    }
                }
            } else {
                // Deform A-Frame structure
                for (let i = 0; i < 8; i++) {
                    const node = document.getElementById(`node${i + 1}`);
                    if (node) {
                        let x, y;
                        
                        if (isDeformed) {
                            const defX = deformations[i].x * AMPLIFICATION;
                            const defY = deformations[i].y * AMPLIFICATION;
                            x = originalPositions[i][0] + defX;
                            y = originalPositions[i][1] + defY;
                            node.setAttribute('color', '#ff8844');
                        } else {
                            x = originalPositions[i][0];
                            y = originalPositions[i][1];
                            node.setAttribute('color', '#ff4444');
                        }
                        
                        node.setAttribute('position', `${x} ${y} 0`);
                    }
                }
                
                setTimeout(() => createLines(), 300);
            }
            
            const btn = document.getElementById('btn-deform');
            btn.textContent = isDeformed ? '‚Ü©Ô∏è Original' : 'üîß Deformar';
            btn.style.background = isDeformed ? '#ff6600' : '#00aa00';
            
            updateStatus(isDeformed ? 'Mostrando deformaciones' : 'Estructura original');
        }
        
        function createLines() {
            // Remove existing lines
            for (let i = 1; i <= 8; i++) {
                const line = document.getElementById(`line${i}`);
                if (line) line.remove();
            }
            
            const connections = [
                [0, 1], [1, 2], [2, 3], [3, 4], [1, 4], [4, 5], [4, 6], [6, 7]
            ];
            
            const structure = document.getElementById('structure');
            
            connections.forEach((conn, index) => {
                const node1 = document.getElementById(`node${conn[0] + 1}`);
                const node2 = document.getElementById(`node${conn[1] + 1}`);
                
                if (node1 && node2) {
                    const pos1 = node1.getAttribute('position');
                    const pos2 = node2.getAttribute('position');
                    
                    const dx = pos2.x - pos1.x;
                    const dy = pos2.y - pos1.y;
                    const dz = pos2.z - pos1.z;
                    const distance = Math.sqrt(dx*dx + dy*dy + dz*dz);
                    
                    const centerX = (pos1.x + pos2.x) / 2;
                    const centerY = (pos1.y + pos2.y) / 2;
                    const centerZ = (pos1.z + pos2.z) / 2;
                    
                    const rotY = Math.atan2(dx, dz) * (180 / Math.PI);
                    const rotZ = -Math.atan2(dy, Math.sqrt(dx*dx + dz*dz)) * (180 / Math.PI);
                    
                    const line = document.createElement('a-cylinder');
                    line.id = `line${index + 1}`;
                    line.setAttribute('position', `${centerX} ${centerY} ${centerZ}`);
                    line.setAttribute('rotation', `0 ${rotY} ${rotZ}`);
                    line.setAttribute('radius', '0.05');
                    line.setAttribute('height', distance);
                    line.setAttribute('color', isDeformed ? '#ff8844' : '#4488ff');
                    line.setAttribute('opacity', '0.8');
                    
                    structure.appendChild(line);
                }
            });
        }
        
        function reset() {
            log('Reseteando aplicaci√≥n');
            
            // Stop camera
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Hide video
            document.getElementById('camera-video').classList.remove('show');
            document.getElementById('touch-area').classList.remove('active');
            
            // Remove AR structure
            const arStructure = document.getElementById('ar-structure');
            if (arStructure) arStructure.remove();
            
            // Reset state
            isAR = false;
            isPlaced = false;
            isDeformed = false;
            
            // Remove lines
            for (let i = 1; i <= 8; i++) {
                const line = document.getElementById(`line${i}`);
                if (line) line.remove();
            }
            
            // Reset nodes
            for (let i = 0; i < 8; i++) {
                const node = document.getElementById(`node${i + 1}`);
                if (node) {
                    node.setAttribute('position', `${originalPositions[i][0]} ${originalPositions[i][1]} 0`);
                    node.setAttribute('color', '#ff4444');
                }
            }
            
            // Reset UI
            document.getElementById('btn-3d').classList.remove('active');
            document.getElementById('btn-ar').classList.remove('active');
            document.getElementById('btn-place').disabled = true;
            document.getElementById('btn-deform').disabled = true;
            document.getElementById('btn-deform').textContent = 'üîß Deformar';
            document.getElementById('btn-deform').style.background = '#00aa00';
            
            hideModal();
            switch3D();
        }
        
        // Event handlers - DIRECT ASSIGNMENT
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM cargado, configurando eventos');
            
            // Button event handlers
            document.getElementById('btn-3d').onclick = switch3D;
            document.getElementById('btn-ar').onclick = switchAR;
            document.getElementById('btn-place').onclick = placeStructure;
            document.getElementById('btn-deform').onclick = toggleDeformation;
            document.getElementById('btn-reset').onclick = reset;
            
            log('Eventos configurados');
            
            // Initialize in 3D mode
            switch3D();
        });
        
        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
