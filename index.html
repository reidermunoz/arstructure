<!DOCTYPE html>
<html>
<head>
    <title>WebXR AR - Detecci√≥n de Superficies</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <style>
        .info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            font-size: 12px;
            max-width: 300px;
            line-height: 1.4;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 15px;
            z-index: 100;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
            text-align: center;
            max-width: 280px;
        }
        .webxr-support {
            background: #28a745;
        }
        .webxr-unsupported {
            background: #dc3545;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    
    <div class="info">
        <strong>WebXR AR - DETECCI√ìN REAL:</strong><br>
        ‚Ä¢ Funciona solo en Chrome Android con ARCore<br>
        ‚Ä¢ Detecta superficies autom√°ticamente<br>
        ‚Ä¢ Toca las superficies para colocar objetos<br>
        ‚Ä¢ Los objetos se anclan f√≠sicamente
    </div>
    
    <div class="status" id="status">
        üîç Verificando soporte WebXR...
    </div>
    
    <div class="controls" style="display: none;" id="controls">
        <button onclick="enterAR()" id="ar-button">üöÄ Iniciar AR</button>
        <button onclick="placeObject()" id="place-button" style="display: none;">üìç Colocar</button>
        <button onclick="clearObjects()" id="clear-button" style="display: none;">üßπ Limpiar</button>
    </div>

    <a-scene 
        id="scene"
        embedded 
        webxr="requiredFeatures: hit-test,local-floor;"
        ar-hit-test="target: #reticle; type: footprint"
        cursor="rayOrigin: mouse"
        raycaster="objects: [ar-hit-test]">
        
        <!-- Assets -->
        <a-assets>
            <a-mixin id="cube" 
                     geometry="primitive: box; width: 0.3; height: 0.3; depth: 0.3"
                     material="color: #4CC3D9; roughness: 0.3; metalness: 0.2">
            </a-mixin>
            <a-mixin id="sphere" 
                     geometry="primitive: sphere; radius: 0.15"
                     material="color: #EF2D5E; roughness: 0.3; metalness: 0.2">
            </a-mixin>
        </a-assets>
        
        <!-- Reticle para mostrar donde se puede colocar -->
        <a-entity id="reticle" 
                  geometry="primitive: ring; radiusInner: 0.15; radiusOuter: 0.2" 
                  material="color: white; opacity: 0.8"
                  rotation="-90 0 0"
                  visible="false"
                  animation="property: rotation; to: -90 360 0; loop: true; dur: 2000">
        </a-entity>
        
        <!-- Contenedor para objetos AR -->
        <a-entity id="ar-objects"></a-entity>
        
        <!-- Luces para mejor visualizaci√≥n -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        <a-light type="directional" position="0 1 0" color="#ffffff" intensity="0.8"></a-light>
        
        <!-- C√°mara WebXR -->
        <a-entity id="cameraRig" position="0 1.6 3">
            <a-camera id="camera" 
                      look-controls="pointerLockEnabled: false"
                      wasd-controls="enabled: false"
                      cursor="rayOrigin: mouse">
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        let arSession = null;
        let hitTestSource = null;
        let objectCount = 0;
        let reticle, scene, camera;
        
        // Componente para hit testing WebXR
        AFRAME.registerComponent('ar-hit-test', {
            schema: {
                target: {type: 'selector'},
                type: {type: 'string', default: 'footprint'}
            },
            
            init: function() {
                this.scene = this.el.sceneEl;
                this.data.target = this.data.target || this.el;
                
                this.scene.addEventListener('enter-vr', () => {
                    this.onEnterVR();
                });
                
                this.scene.addEventListener('exit-vr', () => {
                    this.onExitVR();
                });
            },
            
            onEnterVR: function() {
                if (!this.scene.is('ar-mode')) return;
                
                const session = this.scene.renderer.xr.getSession();
                if (session) {
                    this.requestHitTestSource(session);
                }
            },
            
            onExitVR: function() {
                hitTestSource = null;
            },
            
            requestHitTestSource: async function(session) {
                try {
                    const referenceSpace = await session.requestReferenceSpace('viewer');
                    hitTestSource = await session.requestHitTestSource({ space: referenceSpace });
                    console.log('Hit test source creado');
                    
                    document.getElementById('place-button').style.display = 'inline-block';
                    document.getElementById('clear-button').style.display = 'inline-block';
                    
                } catch (error) {
                    console.warn('Error al crear hit test source:', error);
                }
            },
            
            tick: function() {
                if (!hitTestSource || !this.scene.is('ar-mode')) return;
                
                const frame = this.scene.renderer.xr.getFrame();
                const session = this.scene.renderer.xr.getSession();
                
                if (frame && session) {
                    const referenceSpace = this.scene.renderer.xr.getReferenceSpace();
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        const pose = hit.getPose(referenceSpace);
                        
                        if (pose) {
                            // Mostrar reticle en la superficie detectada
                            this.data.target.setAttribute('visible', true);
                            this.data.target.setAttribute('position', {
                                x: pose.transform.position.x,
                                y: pose.transform.position.y,
                                z: pose.transform.position.z
                            });
                            
                            // Guardar posici√≥n para colocar objetos
                            window.lastHitPosition = pose.transform.position;
                            window.lastHitRotation = pose.transform.orientation;
                        }
                    } else {
                        this.data.target.setAttribute('visible', false);
                    }
                }
            }
        });
        
        // Verificar soporte WebXR
        async function checkWebXRSupport() {
            const status = document.getElementById('status');
            const controls = document.getElementById('controls');
            
            if (!navigator.xr) {
                status.innerHTML = '‚ùå WebXR no soportado<br>Necesitas Chrome Android con ARCore';
                status.className = 'status webxr-unsupported';
                return;
            }
            
            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (supported) {
                    status.innerHTML = '‚úÖ WebXR AR soportado!<br>Toca "Iniciar AR" para comenzar';
                    status.className = 'status webxr-support';
                    controls.style.display = 'block';
                } else {
                    status.innerHTML = '‚ùå AR no soportado<br>Necesitas dispositivo con ARCore';
                    status.className = 'status webxr-unsupported';
                }
            } catch (error) {
                status.innerHTML = '‚ùå Error verificando WebXR<br>' + error.message;
                status.className = 'status webxr-unsupported';
            }
        }
        
        // Iniciar sesi√≥n AR
        async function enterAR() {
            const sceneEl = document.getElementById('scene');
            
            try {
                await sceneEl.enterVR();
                document.getElementById('status').style.display = 'none';
                document.getElementById('ar-button').textContent = 'üëÅÔ∏è AR Activo';
                console.log('Sesi√≥n AR iniciada');
            } catch (error) {
                console.error('Error al iniciar AR:', error);
                alert('Error al iniciar AR: ' + error.message);
            }
        }
        
        // Colocar objeto en superficie detectada
        function placeObject() {
            if (!window.lastHitPosition) {
                alert('Primero apunta a una superficie para detectarla');
                return;
            }
            
            const container = document.getElementById('ar-objects');
            const shapes = ['cube', 'sphere'];
            const colors = ['#4CC3D9', '#EF2D5E', '#FFC65D', '#7BC8A4', '#A55EEA'];
            
            const shape = shapes[Math.floor(Math.random() * shapes.length)];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            const entity = document.createElement('a-entity');
            entity.setAttribute('id', `ar-obj-${objectCount++}`);
            entity.setAttribute('mixin', shape);
            entity.setAttribute('material', 'color', color);
            
            // Posici√≥n exacta de la superficie detectada
            entity.setAttribute('position', {
                x: window.lastHitPosition.x + (Math.random() - 0.5) * 0.2,
                y: window.lastHitPosition.y + 0.15,
                z: window.lastHitPosition.z + (Math.random() - 0.5) * 0.2
            });
            
            entity.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 3000');
            container.appendChild(entity);
            
            console.log('Objeto colocado en superficie real:', entity.getAttribute('position'));
        }
        
        // Limpiar objetos
        function clearObjects() {
            const container = document.getElementById('ar-objects');
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            objectCount = 0;
        }
        
        // Inicializaci√≥n
        window.addEventListener('load', function() {
            scene = document.getElementById('scene');
            reticle = document.getElementById('reticle');
            camera = document.getElementById('camera');
            
            checkWebXRSupport();
            
            console.log('WebXR AR cargado - Detecta superficies autom√°ticamente');
        });
        
        // Manejo de errores
        window.addEventListener('error', function(e) {
            console.error('Error:', e.error);
        });
    </script>
</body>
</html>
