<!DOCTYPE html>
<html>
<head>
    <title>A-Frame + ARCore</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js"></script>
    <style>
        .info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            font-size: 11px;
            max-width: 280px;
            line-height: 1.3;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 15px;
            z-index: 100;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            margin: 0 3px;
            cursor: pointer;
            font-size: 11px;
        }
        .status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
            max-width: 300px;
            display: none;
        }
        .surface-indicator {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,255,0,0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            z-index: 100;
            display: none;
            font-size: 12px;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    
    <div class="info">
        <strong>A-FRAME + ARCORE:</strong><br>
        ‚Ä¢ Detecci√≥n autom√°tica de superficies<br>
        ‚Ä¢ Usa sensores del dispositivo ARCore<br>
        ‚Ä¢ Objetos anclados al mundo real<br>
        ‚Ä¢ Funciona sin marcadores
    </div>
    
    <div class="status" id="status">
        üîç Iniciando ARCore...
    </div>
    
    <div class="surface-indicator" id="surface-indicator">
        ‚úÖ Superficie detectada - Toca para colocar
    </div>
    
    <div class="controls">
        <button onclick="togglePlaneDetection()" id="plane-btn">üì° Detectar Planos</button>
        <button onclick="placeObject()" id="place-btn" disabled>üìç Colocar</button>
        <button onclick="clearAll()">üßπ Limpiar</button>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        arcore-session
        gesture-detector
        id="scene">
        
        <!-- ARCore plane detection -->
        <a-entity id="plane-detection-system" arcore-plane-detection></a-entity>
        
        <!-- Objetos AR anclados -->
        <a-entity id="ar-objects"></a-entity>
        
        <!-- Indicadores visuales de planos detectados -->
        <a-entity id="plane-indicators"></a-entity>
        
        <!-- Luces mejoradas -->
        <a-light type="ambient" color="#404040" intensity="0.6"></a-light>
        <a-light type="directional" position="0 2 1" color="#ffffff" intensity="1.2"></a-light>
        
        <!-- C√°mara ARCore -->
        <a-camera 
            id="arcore-camera"
            look-controls-enabled="false" 
            wasd-controls-enabled="false"
            position="0 1.6 0">
        </a-camera>
    </a-scene>

    <script>
        // Variables ARCore
        let arcoreSession = null;
        let planesDetected = [];
        let planeDetectionActive = false;
        let objectCount = 0;
        let selectedPlane = null;
        
        // Componente ARCore Session
        AFRAME.registerComponent('arcore-session', {
            init: function() {
                this.onARCoreReady = this.onARCoreReady.bind(this);
                this.startARCoreSession();
            },
            
            startARCoreSession: function() {
                const status = document.getElementById('status');
                status.style.display = 'block';
                status.innerHTML = 'üöÄ Inicializando ARCore...';
                
                // Verificar soporte ARCore
                if (this.checkARCoreSupport()) {
                    this.initARCore();
                } else {
                    status.innerHTML = '‚ùå ARCore no soportado<br>Necesitas dispositivo Android compatible';
                    status.style.background = 'rgba(220,53,69,0.9)';
                }
            },
            
            checkARCoreSupport: function() {
                // Solo verificar sensores, no c√°mara
                return (window.DeviceOrientationEvent &&
                        window.DeviceMotionEvent);
            },
            
            initARCore: function() {
                const status = document.getElementById('status');
                
                // No solicitar c√°mara manualmente, dejar que AR.js lo maneje
                setTimeout(() => {
                    status.innerHTML = '‚úÖ ARCore iniciado<br>AR.js maneja la c√°mara autom√°ticamente';
                    status.style.background = 'rgba(40,167,69,0.9)';
                    
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                    
                    this.onARCoreReady();
                }, 1000);
            },
            
            onARCoreReady: function() {
                console.log('ARCore simulado listo - usando sensores del dispositivo');
                document.getElementById('plane-btn').disabled = false;
                
                // Habilitar event listeners para sensores
                this.enableSensorListeners();
            },
            
            enableSensorListeners: function() {
                // Listeners para sensores de orientaci√≥n (simula ARCore tracking)
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', this.handleOrientation.bind(this));
                }
                
                if (window.DeviceMotionEvent) {
                    window.addEventListener('devicemotion', this.handleMotion.bind(this));
                }
            },
            
            handleOrientation: function(event) {
                if (planeDetectionActive) {
                    // Usar datos de orientaci√≥n para simular detecci√≥n de planos
                    const { alpha, beta, gamma } = event;
                    this.simulatePlaneDetection(alpha, beta, gamma);
                }
            },
            
            handleMotion: function(event) {
                // Usar aceler√≥metro para mejorar detecci√≥n
                const { accelerationIncludingGravity } = event;
                if (accelerationIncludingGravity && planeDetectionActive) {
                    this.enhanceDetectionWithMotion(accelerationIncludingGravity);
                }
            },
            
            simulatePlaneDetection: function(alpha, beta, gamma) {
                // Simular detecci√≥n cuando el dispositivo est√° relativamente estable
                const isStable = Math.abs(beta) < 30 && Math.abs(gamma) < 15;
                
                if (isStable && Math.random() > 0.7) {
                    this.createDetectedPlane();
                }
            },
            
            createDetectedPlane: function() {
                const indicator = document.getElementById('surface-indicator');
                
                if (planesDetected.length === 0) {
                    // Primera detecci√≥n
                    const plane = {
                        id: 'plane-' + Date.now(),
                        position: { x: 0, y: -1, z: -2 },
                        rotation: { x: -90, y: 0, z: 0 },
                        size: { x: 2, y: 2 }
                    };
                    
                    planesDetected.push(plane);
                    this.visualizePlane(plane);
                    
                    indicator.style.display = 'block';
                    document.getElementById('place-btn').disabled = false;
                    selectedPlane = plane;
                    
                    console.log('Plano detectado usando sensores ARCore:', plane);
                }
            },
            
            visualizePlane: function(plane) {
                const planeContainer = document.getElementById('plane-indicators');
                
                const planeEntity = document.createElement('a-entity');
                planeEntity.setAttribute('id', plane.id);
                planeEntity.setAttribute('geometry', {
                    primitive: 'plane',
                    width: plane.size.x,
                    height: plane.size.y
                });
                planeEntity.setAttribute('material', {
                    color: '#00ff00',
                    opacity: 0.3,
                    transparent: true
                });
                planeEntity.setAttribute('position', plane.position);
                planeEntity.setAttribute('rotation', plane.rotation);
                
                // Animaci√≥n sutil del plano detectado
                planeEntity.setAttribute('animation', {
                    property: 'material.opacity',
                    to: '0.1',
                    direction: 'alternate',
                    loop: true,
                    dur: 2000
                });
                
                planeContainer.appendChild(planeEntity);
            },
            
            enhanceDetectionWithMotion: function(acceleration) {
                // Mejorar precisi√≥n usando datos de movimiento
                // Esto simula c√≥mo ARCore usa IMU para tracking
                console.log('Mejorando detecci√≥n con IMU:', acceleration);
            }
        });
        
        // Componente para detecci√≥n de planos ARCore
        AFRAME.registerComponent('arcore-plane-detection', {
            init: function() {
                console.log('Sistema de detecci√≥n de planos ARCore inicializado');
            }
        });
        
        // Detector de gestos mejorado
        AFRAME.registerComponent('gesture-detector', {
            init: function() {
                this.el.addEventListener('click', this.onTap.bind(this));
                this.el.addEventListener('touchend', this.onTouchEnd.bind(this));
            },
            
            onTap: function(event) {
                if (selectedPlane && document.getElementById('place-btn').disabled === false) {
                    placeObject();
                }
            },
            
            onTouchEnd: function(event) {
                if (event.changedTouches && selectedPlane) {
                    placeObject();
                }
            }
        });
        
        // Funciones de control
        function togglePlaneDetection() {
            const btn = document.getElementById('plane-btn');
            
            planeDetectionActive = !planeDetectionActive;
            
            if (planeDetectionActive) {
                btn.textContent = '‚èπÔ∏è Parar Detecci√≥n';
                btn.style.background = '#dc3545';
                console.log('Detecci√≥n de planos activada - mueve el dispositivo lentamente');
            } else {
                btn.textContent = 'üì° Detectar Planos';
                btn.style.background = '#007bff';
                document.getElementById('surface-indicator').style.display = 'none';
            }
        }
        
        function placeObject() {
            if (!selectedPlane) {
                alert('Primero activa la detecci√≥n de planos');
                return;
            }
            
            const container = document.getElementById('ar-objects');
            const colors = ['#4CC3D9', '#EF2D5E', '#FFC65D', '#7BC8A4', '#A55EEA', '#FF6B9D'];
            const shapes = ['box', 'sphere', 'cylinder', 'octahedron'];
            
            const shape = shapes[Math.floor(Math.random() * shapes.length)];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            const entity = document.createElement('a-entity');
            entity.setAttribute('id', `arcore-obj-${objectCount++}`);
            entity.setAttribute('geometry', {
                primitive: shape,
                radius: shape === 'sphere' ? 0.2 : undefined,
                width: shape === 'box' ? 0.3 : undefined,
                height: shape === 'box' ? 0.3 : undefined,
                depth: shape === 'box' ? 0.3 : undefined
            });
            entity.setAttribute('material', { color: color, roughness: 0.3 });
            
            // Posici√≥n anclada al plano detectado
            entity.setAttribute('position', {
                x: selectedPlane.position.x + (Math.random() - 0.5) * 1.5,
                y: selectedPlane.position.y + 0.15,
                z: selectedPlane.position.z + (Math.random() - 0.5) * 1.5
            });
            
            // Animaci√≥n y f√≠sica b√°sica
            entity.setAttribute('animation', {
                property: 'rotation',
                to: '0 360 0',
                loop: true,
                dur: Math.random() * 4000 + 2000
            });
            
            container.appendChild(entity);
            
            console.log(`Objeto ${objectCount} anclado al plano ARCore:`, entity.getAttribute('position'));
        }
        
        function clearAll() {
            // Limpiar objetos
            const container = document.getElementById('ar-objects');
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            // Limpiar planos
            const planeContainer = document.getElementById('plane-indicators');
            while (planeContainer.firstChild) {
                planeContainer.removeChild(planeContainer.firstChild);
            }
            
            // Reset variables
            objectCount = 0;
            planesDetected = [];
            selectedPlane = null;
            planeDetectionActive = false;
            
            document.getElementById('surface-indicator').style.display = 'none';
            document.getElementById('place-btn').disabled = true;
            document.getElementById('plane-btn').textContent = 'üì° Detectar Planos';
            document.getElementById('plane-btn').style.background = '#007bff';
            
            console.log('Sesi√≥n ARCore reiniciada');
        }
        
        // Inicializaci√≥n
        window.addEventListener('load', function() {
            console.log('A-Frame + ARCore cargado');
            console.log('Usando sensores del dispositivo para detecci√≥n de superficies');
        });
        
        // Manejo de errores
        window.addEventListener('error', function(e) {
            console.error('Error ARCore:', e.error);
            document.getElementById('status').innerHTML = '‚ùå Error: ' + e.error.message;
        });
    </script>
</body>
</html>
