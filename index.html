<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Estructura AR - Versi√≥n Simplificada</title>
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #000;
            touch-action: none;
        }
        
        .ui-panel {
            position: fixed;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            border: 2px solid #00ff00;
        }
        
        .info-panel {
            top: 10px;
            left: 10px;
            max-width: 280px;
        }
        
        .controls-panel {
            bottom: 10px;
            right: 10px;
            text-align: center;
        }
        
        .controls-panel button {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 15px;
            background: #00aa00;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .controls-panel button:hover {
            background: #00dd00;
            transform: scale(1.05);
        }
        
        .controls-panel button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .controls-panel button.ar-active {
            background: #ff6600;
        }
        
        .status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
            display: none;
        }
        
        .status.show {
            display: block;
        }
        
        .status button {
            margin: 10px;
            padding: 10px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Overlay para capturar toques en AR */
        .touch-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 500;
            background: transparent;
            display: none;
        }
        
        .touch-overlay.active {
            display: block;
        }
        
        /* Feedback visual */
        .touch-feedback {
            position: fixed;
            width: 100px;
            height: 100px;
            border: 3px solid #00ff00;
            border-radius: 50%;
            background: rgba(0,255,0,0.2);
            pointer-events: none;
            z-index: 1500;
            display: none;
            transform: translate(-50%, -50%);
            animation: pulse 0.5s ease-out;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(2); }
        }
        
        /* Video de c√°mara para AR */
        #camera-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            display: none;
        }
        
        #camera-video.show {
            display: block;
        }
        
        .debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 2000;
            display: none;
        }
        
        .debug.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- UI Panels -->
    <div class="ui-panel info-panel">
        <h3>üèóÔ∏è Estructura AR</h3>
        <p><strong>Estado:</strong> <span id="status-text">Modo 3D Normal</span></p>
        <p><strong>Nodos:</strong> 8 esferas rojas</p>
        <p><strong>Elementos:</strong> 8 l√≠neas azules</p>
        <div style="margin-top: 10px; font-size: 11px; color: #ccc;">
            <strong>Controles 3D:</strong> Arrastra para rotar, pellizca para zoom
        </div>
    </div>
    
    <div class="ui-panel controls-panel">
        <button id="btn-3d" onclick="cambiarA3D()">üñ•Ô∏è Modo 3D</button>
        <button id="btn-ar" onclick="cambiarAR()">üì± Modo AR</button>
        <button id="btn-place" onclick="colocarEstructura()" disabled>üéØ Colocar</button>
        <button id="btn-deform" onclick="toggleDeformacion()" disabled>üîß Deformar</button>
        <button id="btn-reset" onclick="resetear()">üîÑ Reset</button>
        <button onclick="toggleDebug()">üêõ Debug</button>
    </div>
    
    <!-- Overlays -->
    <div id="touch-overlay" class="touch-overlay"></div>
    <div id="touch-feedback" class="touch-feedback"></div>
    
    <!-- Status Modal -->
    <div id="status-modal" class="status">
        <h3 id="status-title">Estado</h3>
        <p id="status-message">Mensaje</p>
        <div id="status-buttons"></div>
    </div>
    
    <!-- Camera Video -->
    <video id="camera-video" autoplay muted playsinline></video>
    
    <!-- Debug Panel -->
    <div id="debug-panel" class="debug">
        <strong>DEBUG LOG:</strong><br>
        <div id="debug-log"></div>
    </div>
    
    <!-- A-Frame Scene -->
    <a-scene 
        id="scene"
        embedded 
        background="color: #f0f0f0"
        loading-screen="enabled: false"
        vr-mode-ui="enabled: false">
        
        <!-- Luces -->
        <a-light type="ambient" color="#666666"></a-light>
        <a-light type="directional" position="0 5 5" intensity="0.8"></a-light>
        
        <!-- Contenedor principal de la estructura -->
        <a-entity id="estructura-container" position="0 0 0" scale="1 1 1">
            
            <!-- Plano base -->
            <a-plane id="base-plane" 
                position="4 -0.5 0" 
                rotation="-90 0 0" 
                width="12" 
                height="8" 
                color="#ffffff" 
                opacity="0.3"
                material="side: double"></a-plane>
            
            <!-- Nodos (Esferas) -->
            <a-sphere id="nodo-1" position="0 0 0" radius="0.3" color="#ff4444" 
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 20000">
                <a-text value="1" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="nodo-2" position="0 3 0" radius="0.3" color="#ff4444"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 20000">
                <a-text value="2" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="nodo-3" position="0 6 0" radius="0.3" color="#ff4444"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 20000">
                <a-text value="3" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="nodo-4" position="4 6 0" radius="0.3" color="#ff4444"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 20000">
                <a-text value="4" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="nodo-5" position="4 3 0" radius="0.3" color="#ff4444"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 20000">
                <a-text value="5" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="nodo-6" position="4 0 0" radius="0.3" color="#ff4444"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 20000">
                <a-text value="6" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="nodo-7" position="8 3 0" radius="0.3" color="#ff4444"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 20000">
                <a-text value="7" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
            
            <a-sphere id="nodo-8" position="8 0 0" radius="0.3" color="#ff4444"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 20000">
                <a-text value="8" position="0 0.8 0" align="center" color="#ffffff" scale="2 2 2"></a-text>
            </a-sphere>
        </a-entity>
        
        <!-- C√°mara -->
        <a-camera id="camera" 
                  position="12 9 18" 
                  look-at="4 3 0"
                  wasd-controls="enabled: true"
                  look-controls="enabled: true"></a-camera>
    </a-scene>

    <script>
        // Variables globales
        let modoAR = false;
        let estructuraColocada = false;
        let estructuraDeformada = false;
        let cameraStream = null;
        let debugVisible = false;
        let debugLog = [];
        
        // Posiciones originales de los nodos
        const posicionesOriginales = [
            [0, 0], [0, 3], [0, 6], [4, 6], [4, 3], [4, 0], [8, 3], [8, 0]
        ];
        
        // Conectividad (qu√© nodos est√°n conectados)
        const conectividad = [
            [0, 1], [1, 2], [2, 3], [3, 4], [1, 4], [4, 5], [4, 6], [6, 7]
        ];
        
        // Desplazamientos para deformaci√≥n
        const desplazamientos = [
            {x: 0, y: 0}, 
            {x: -0.000214334467084222, y: -2.92585497916779e-05}, 
            {x: -4.51228548254704e-05, y: -5.91445463001043e-05}, 
            {x: -5.26077882706616e-05, y: -7.62472910434113e-05}, 
            {x: -0.000205459371218351, y: -4.61332875518377e-05}, 
            {x: 0, y: 0}, 
            {x: -0.000209509318349148, y: -1.46081626564844e-05}, 
            {x: 0, y: 0}
        ];
        
        const FACTOR_AMPLIFICACION = 8000;
        
        // Sistema de debug
        function log(mensaje, tipo = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${mensaje}`;
            debugLog.push(entry);
            
            if (debugLog.length > 50) debugLog.shift();
            
            console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
            
            if (debugVisible) {
                actualizarDebugPanel();
            }
        }
        
        function actualizarDebugPanel() {
            const panel = document.getElementById('debug-log');
            if (panel) {
                panel.innerHTML = debugLog.join('<br>');
                panel.scrollTop = panel.scrollHeight;
            }
        }
        
        function toggleDebug() {
            debugVisible = !debugVisible;
            const panel = document.getElementById('debug-panel');
            if (debugVisible) {
                panel.classList.add('show');
                actualizarDebugPanel();
            } else {
                panel.classList.remove('show');
            }
        }
        
        // Actualizar estado
        function actualizarEstado(mensaje) {
            document.getElementById('status-text').textContent = mensaje;
            log(mensaje);
        }
        
        // Mostrar modal de estado
        function mostrarModal(titulo, mensaje, botones = []) {
            const modal = document.getElementById('status-modal');
            const titleEl = document.getElementById('status-title');
            const messageEl = document.getElementById('status-message');
            const buttonsEl = document.getElementById('status-buttons');
            
            titleEl.textContent = titulo;
            messageEl.textContent = mensaje;
            
            buttonsEl.innerHTML = '';
            botones.forEach(btn => {
                const button = document.createElement('button');
                button.textContent = btn.texto;
                button.onclick = btn.accion;
                buttonsEl.appendChild(button);
            });
            
            modal.classList.add('show');
            
            if (botones.length === 0) {
                setTimeout(() => {
                    modal.classList.remove('show');
                }, 3000);
            }
        }
        
        function cerrarModal() {
            document.getElementById('status-modal').classList.remove('show');
        }
        
        // Cambiar a modo 3D
        function cambiarA3D() {
            log('Cambiando a modo 3D');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            document.getElementById('camera-video').classList.remove('show');
            document.getElementById('touch-overlay').classList.remove('active');
            
            const scene = document.getElementById('scene');
            scene.setAttribute('background', 'color: #f0f0f0');
            
            const camera = document.getElementById('camera');
            camera.setAttribute('wasd-controls', 'enabled: true');
            camera.setAttribute('look-controls', 'enabled: true');
            camera.setAttribute('position', '12 9 18');
            camera.setAttribute('look-at', '4 3 0');
            
            const container = document.getElementById('estructura-container');
            container.setAttribute('position', '0 0 0');
            container.setAttribute('scale', '1 1 1');
            
            modoAR = false;
            estructuraColocada = true;
            
            document.getElementById('btn-3d').style.background = '#ff6600';
            document.getElementById('btn-ar').style.background = '#00aa00';
            document.getElementById('btn-place').disabled = true;
            document.getElementById('btn-deform').disabled = false;
            
            actualizarEstado('Modo 3D - Estructura visible');
            crearLineas();
        }
        
        // Cambiar a modo AR
        async function cambiarAR() {
            log('=== INICIANDO MODO AR ===');
            
            // Verificar soporte
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                mostrarModal('Error', 'Tu dispositivo no soporta acceso a c√°mara', [
                    {texto: 'OK', accion: cerrarModal}
                ]);
                return;
            }
            
            try {
                // Solicitar c√°mara
                mostrarModal('Solicitando C√°mara', 'Permite el acceso a la c√°mara para usar AR');
                
                log('Solicitando permisos de c√°mara...');
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                log('Permisos de c√°mara obtenidos');
                
                // Configurar video
                const video = document.getElementById('camera-video');
                video.srcObject = cameraStream;
                video.classList.add('show');
                log('Video de c√°mara configurado');
                
                // Configurar escena AR
                const scene = document.getElementById('scene');
                scene.setAttribute('background', 'color: transparent');
                log('Fondo de escena puesto transparente');
                
                // CONFIGURACI√ìN CR√çTICA DE C√ÅMARA AR
                const camera = document.getElementById('camera');
                camera.setAttribute('wasd-controls', 'enabled: false');
                camera.setAttribute('look-controls', 'enabled: false');
                camera.setAttribute('position', '0 0 0');  // Origen exacto
                camera.setAttribute('rotation', '0 0 0');  // Sin rotaci√≥n
                camera.removeAttribute('look-at');
                
                // ASEGURAR QUE LA C√ÅMARA EST√â EN LA ESCENA
                if (!camera.parentElement) {
                    scene.appendChild(camera);
                    log('C√°mara re-agregada a la escena');
                }
                
                log('C√°mara AR configurada en origen');
                
                // HACER LA ESTRUCTURA INVISIBLE INICIALMENTE PERO VERIFICAR QUE EXISTA
                const container = document.getElementById('estructura-container');
                if (container) {
                    container.setAttribute('visible', 'false');
                    log('Estructura ocultada inicialmente');
                    
                    // Verificar que todos los nodos existan
                    for (let i = 1; i <= 8; i++) {
                        const nodo = document.getElementById(`nodo-${i}`);
                        if (nodo) {
                            log(`Nodo ${i} encontrado`);
                        } else {
                            log(`ERROR: Nodo ${i} no encontrado`);
                        }
                    }
                } else {
                    log('ERROR CR√çTICO: No se encontr√≥ estructura-container');
                }
                
                // Configurar overlay de toque
                const overlay = document.getElementById('touch-overlay');
                overlay.classList.add('active');
                
                // CONFIGURAR EVENTOS M√ÅS AGRESIVAMENTE
                overlay.onclick = function(e) {
                    log('EVENTO: Click detectado en overlay');
                    manejarToque(e);
                };
                
                overlay.ontouchstart = function(e) {
                    log('EVENTO: Touch detectado en overlay');
                    manejarToque(e);
                };
                
                overlay.onpointerdown = function(e) {
                    log('EVENTO: Pointer detectado en overlay');
                    manejarToque(e);
                };
                
                // Tambi√©n agregar listener directo al documento para mayor compatibilidad
                document.addEventListener('click', function(e) {
                    if (modoAR && !estructuraColocada && overlay.classList.contains('active')) {
                        log('EVENTO: Click alternativo detectado en documento');
                        manejarToque(e);
                    }
                });
                
                // AGREGAR LISTENER AL VIDEO TAMBI√âN
                video.addEventListener('click', function(e) {
                    if (modoAR && !estructuraColocada) {
                        log('EVENTO: Click detectado en video de c√°mara');
                        manejarToque(e);
                    }
                });
                
                log('Eventos de toque configurados en m√∫ltiples elementos');
                
                // Configurar estado
                modoAR = true;
                estructuraColocada = false;
                
                document.getElementById('btn-ar').style.background = '#ff6600';
                document.getElementById('btn-3d').style.background = '#00aa00';
                document.getElementById('btn-place').disabled = false;
                document.getElementById('btn-deform').disabled = true;
                
                cerrarModal();
                actualizarEstado('Modo AR - Toca CUALQUIER PARTE de la pantalla (incluso el video)');
                
                // VERIFICACIONES PERI√ìDICAS DEL ESTADO AR
                let contadorVerificacion = 0;
                const verificarAR = setInterval(() => {
                    contadorVerificacion++;
                    log(`Verificaci√≥n AR ${contadorVerificacion}: modoAR=${modoAR}, estructuraColocada=${estructuraColocada}`);
                    log(`Overlay activo: ${overlay.classList.contains('active')}`);
                    
                    if (contadorVerificacion >= 3) {
                        clearInterval(verificarAR);
                        log('SISTEMA AR LISTO - Esperando interacci√≥n del usuario');
                    }
                }, 1000);
                
                log('=== MODO AR ACTIVADO CORRECTAMENTE ===');
                
            } catch (error) {
                log(`ERROR activando AR: ${error.message}`, 'error');
                mostrarModal('Error de C√°mara', `No se pudo acceder a la c√°mara: ${error.message}`, [
                    {texto: 'Reintentar', accion: cambiarAR},
                    {texto: 'Cancelar', accion: cerrarModal}
                ]);
            }
        }
        
        // Manejar toque en AR
        function manejarToque(event) {
            log('Funci√≥n manejarToque llamada');
            log(`Estado: modoAR=${modoAR}, estructuraColocada=${estructuraColocada}`);
            
            if (!modoAR) {
                log('ERROR: No estamos en modo AR');
                return;
            }
            
            if (estructuraColocada) {
                log('AVISO: Estructura ya colocada');
                return;
            }
            
            event.preventDefault();
            
            let x = event.clientX || (event.touches && event.touches[0].clientX) || window.innerWidth / 2;
            let y = event.clientY || (event.touches && event.touches[0].clientY) || window.innerHeight / 2;
            
            // Mostrar feedback
            const feedback = document.getElementById('touch-feedback');
            feedback.style.left = x + 'px';
            feedback.style.top = y + 'px';
            feedback.style.display = 'block';
            
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 500);
            
            log(`Toque detectado en (${x}, ${y}) - Procediendo a colocar estructura`);
            
            // Colocar estructura inmediatamente
            colocarEstructura();
        }
        
        // Colocar estructura
        function colocarEstructura() {
            log('=== INICIANDO COLOCACI√ìN DE ESTRUCTURA ===');
            log(`Estado inicial: modoAR=${modoAR}, estructuraColocada=${estructuraColocada}`);
            
            // Permitir colocaci√≥n tanto en AR como en 3D para testing
            const container = document.getElementById('estructura-container');
            
            if (!container) {
                log('ERROR CR√çTICO: No se encontr√≥ estructura-container');
                return;
            }
            
            log('Container encontrado, configurando posici√≥n...');
            
            // FORZAR VISIBILIDAD ABSOLUTA
            container.setAttribute('visible', 'true');
            log('Visibilidad forzada a true');
            
            if (modoAR) {
                // POSICI√ìN AR: DIRECTAMENTE FRENTE A LA C√ÅMARA
                log('Configurando para modo AR - posici√≥n muy cercana');
                container.setAttribute('position', '0 0 -0.8');  // MUY cerca
                container.setAttribute('scale', '0.15 0.15 0.15');    // Muy peque√±o pero visible
                
                // Verificar que la posici√≥n se aplic√≥
                setTimeout(() => {
                    const pos = container.getAttribute('position');
                    const scale = container.getAttribute('scale');
                    log(`Posici√≥n aplicada: ${JSON.stringify(pos)}`);
                    log(`Escala aplicada: ${JSON.stringify(scale)}`);
                }, 100);
                
                // HACER PLANO BASE MUY VISIBLE
                const basePlane = document.getElementById('base-plane');
                if (basePlane) {
                    basePlane.setAttribute('visible', 'true');
                    basePlane.setAttribute('opacity', '0.8');
                    basePlane.setAttribute('color', '#00ff00');
                    basePlane.setAttribute('material', 'side: double; transparent: true');
                    log('Plano base configurado como verde brillante');
                }
                
                // HACER NODOS MUY VISIBLES Y GRANDES
                for (let i = 1; i <= 8; i++) {
                    const nodo = document.getElementById(`nodo-${i}`);
                    if (nodo) {
                        nodo.setAttribute('visible', 'true');
                        nodo.setAttribute('material', 'color: #ff0000; metalness: 0; roughness: 0; emissive: #440000');
                        nodo.setAttribute('radius', '0.6');  // M√ÅS GRANDE
                        nodo.setAttribute('geometry', 'primitive: sphere; radius: 0.6');
                        
                        // Verificar posici√≥n del nodo
                        const nodoPos = nodo.getAttribute('position');
                        log(`Nodo ${i} posici√≥n: ${JSON.stringify(nodoPos)}`);
                        
                        // Hacer texto m√°s visible
                        const texto = nodo.querySelector('a-text');
                        if (texto) {
                            texto.setAttribute('visible', 'true');
                            texto.setAttribute('color', '#ffffff');
                            texto.setAttribute('scale', '4 4 4');
                            texto.setAttribute('material', 'color: #ffffff; shader: msdf');
                        }
                    }
                }
                
                // AGREGAR OBJETO DE PRUEBA ADICIONAL PARA VERIFICAR VISIBILIDAD
                const testBox = document.createElement('a-box');
                testBox.id = 'test-visibility-box';
                testBox.setAttribute('position', '0 0 0');  // En el centro
                testBox.setAttribute('scale', '1 1 1');
                testBox.setAttribute('color', '#ffff00');   // Amarillo brillante
                testBox.setAttribute('material', 'emissive: #ffff00; metalness: 0');
                container.appendChild(testBox);
                log('Caja de prueba amarilla agregada en el centro');
                
            } else {
                log('Configurando para modo 3D');
                container.setAttribute('position', '0 0 0');
                container.setAttribute('scale', '1 1 1');
            }
            
            // VERIFICAR JERARQU√çA DE ELEMENTOS
            log('=== VERIFICACI√ìN DE JERARQU√çA ===');
            const scene = document.getElementById('scene');
            log(`Escena existe: ${!!scene}`);
            log(`Container padre: ${container.parentElement ? container.parentElement.tagName : 'ninguno'}`);
            log(`Hijos del container: ${container.children.length}`);
            
            // VERIFICAR C√ÅMARA
            const camera = document.getElementById('camera');
            if (camera) {
                const camPos = camera.getAttribute('position');
                const camRot = camera.getAttribute('rotation');
                log(`C√°mara posici√≥n: ${JSON.stringify(camPos)}`);
                log(`C√°mara rotaci√≥n: ${JSON.stringify(camRot)}`);
            }
            
            // MARCAR COMO COLOCADA INMEDIATAMENTE
            estructuraColocada = true;
            log('estructuraColocada = true');
            
            // Actualizar UI
            document.getElementById('btn-place').disabled = true;
            document.getElementById('btn-deform').disabled = false;
            document.getElementById('touch-overlay').classList.remove('active');
            
            actualizarEstado('Estructura colocada - Si no la ves, usa Reset y prueba modo 3D');
            log('UI actualizada');
            
            // Crear l√≠neas despu√©s de un peque√±o delay
            setTimeout(() => {
                log('Creando l√≠neas...');
                crearLineas();
            }, 100);
            
            // ANIMACI√ìN M√ÅS VISIBLE
            const escala = modoAR ? '0.15' : '1';
            container.removeAttribute('animation');  // Limpiar animaci√≥n anterior
            setTimeout(() => {
                container.setAttribute('animation', 
                    `property: scale; from: 0.01 0.01 0.01; to: ${escala} ${escala} ${escala}; dur: 2000; easing: easeOutBounce`);
                log('Animaci√≥n de escala iniciada');
            }, 200);
            
            // VERIFICACI√ìN CONTINUA
            let verificaciones = 0;
            const intervalo = setInterval(() => {
                verificaciones++;
                const visible = container.getAttribute('visible');
                const pos = container.getAttribute('position');
                const scale = container.getAttribute('scale');
                
                log(`Verificaci√≥n ${verificaciones}: visible=${visible}, pos=${JSON.stringify(pos)}, scale=${JSON.stringify(scale)}`);
                
                if (verificaciones >= 5) {
                    clearInterval(intervalo);
                    log('=== VERIFICACIONES COMPLETADAS ===');
                    
                    // Si sigue invisible, probar posici√≥n diferente
                    if (!visible || visible === 'false') {
                        log('PROBLEMA: Estructura no visible, intentando posici√≥n alternativa');
                        container.setAttribute('position', '0 1 -0.5');
                        container.setAttribute('scale', '0.2 0.2 0.2');
                        container.setAttribute('visible', 'true');
                    }
                }
            }, 500);
            
            log('=== COLOCACI√ìN COMPLETADA ===');
        }
        
        // Crear l√≠neas entre nodos
        function crearLineas() {
            log('Creando l√≠neas de conexi√≥n');
            
            // Limpiar l√≠neas existentes
            for (let i = 1; i <= 8; i++) {
                const linea = document.getElementById(`linea-${i}`);
                if (linea) linea.remove();
            }
            
            const container = document.getElementById('estructura-container');
            
            conectividad.forEach((conexion, index) => {
                const [nodo1Idx, nodo2Idx] = conexion;
                const nodo1 = document.getElementById(`nodo-${nodo1Idx + 1}`);
                const nodo2 = document.getElementById(`nodo-${nodo2Idx + 1}`);
                
                if (nodo1 && nodo2) {
                    const pos1 = nodo1.getAttribute('position');
                    const pos2 = nodo2.getAttribute('position');
                    
                    // Calcular posici√≥n y rotaci√≥n de la l√≠nea
                    const dx = pos2.x - pos1.x;
                    const dy = pos2.y - pos1.y;
                    const dz = pos2.z - pos1.z;
                    const distancia = Math.sqrt(dx*dx + dy*dy + dz*dz);
                    
                    const centroX = (pos1.x + pos2.x) / 2;
                    const centroY = (pos1.y + pos2.y) / 2;
                    const centroZ = (pos1.z + pos2.z) / 2;
                    
                    const rotY = Math.atan2(dx, dz) * (180 / Math.PI);
                    const rotZ = -Math.atan2(dy, Math.sqrt(dx*dx + dz*dz)) * (180 / Math.PI);
                    
                    // Crear l√≠nea como cilindro
                    const linea = document.createElement('a-cylinder');
                    linea.id = `linea-${index + 1}`;
                    linea.setAttribute('position', `${centroX} ${centroY} ${centroZ}`);
                    linea.setAttribute('rotation', `0 ${rotY} ${rotZ}`);
                    linea.setAttribute('radius', '0.05');
                    linea.setAttribute('height', distancia);
                    linea.setAttribute('color', estructuraDeformada ? '#ff8844' : '#4488ff');
                    linea.setAttribute('opacity', '0.8');
                    
                    container.appendChild(linea);
                }
            });
        }
        
        // Toggle deformaci√≥n
        function toggleDeformacion() {
            if (!estructuraColocada) return;
            
            estructuraDeformada = !estructuraDeformada;
            
            log(`${estructuraDeformada ? 'Aplicando' : 'Removiendo'} deformaci√≥n`);
            
            for (let i = 0; i < 8; i++) {
                const nodo = document.getElementById(`nodo-${i + 1}`);
                if (nodo) {
                    let x, y;
                    
                    if (estructuraDeformada) {
                        const desplX = desplazamientos[i].x * FACTOR_AMPLIFICACION;
                        const desplY = desplazamientos[i].y * FACTOR_AMPLIFICACION;
                        x = posicionesOriginales[i][0] + desplX;
                        y = posicionesOriginales[i][1] + desplY;
                        
                        nodo.setAttribute('position', `${x} ${y} 0`);
                        nodo.setAttribute('color', '#ff8844');
                    } else {
                        x = posicionesOriginales[i][0];
                        y = posicionesOriginales[i][1];
                        
                        nodo.setAttribute('position', `${x} ${y} 0`);
                        nodo.setAttribute('color', '#ff4444');
                    }
                }
            }
            
            // Recrear l√≠neas con nuevo color
            setTimeout(() => crearLineas(), 300);
            
            const btn = document.getElementById('btn-deform');
            btn.textContent = estructuraDeformada ? '‚Ü©Ô∏è Original' : 'üîß Deformar';
            btn.style.background = estructuraDeformada ? '#ff6600' : '#00aa00';
            
            actualizarEstado(estructuraDeformada ? 'Mostrando deformaciones amplificadas' : 'Estructura en estado original');
        }
        
        // Resetear
        function resetear() {
            log('=== RESETEANDO APLICACI√ìN ===');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                log('Stream de c√°mara detenido');
            }
            
            document.getElementById('camera-video').classList.remove('show');
            document.getElementById('touch-overlay').classList.remove('active');
            
            modoAR = false;
            estructuraColocada = false;
            estructuraDeformada = false;
            
            log('Variables de estado reseteadas');
            
            // Limpiar l√≠neas
            for (let i = 1; i <= 8; i++) {
                const linea = document.getElementById(`linea-${i}`);
                if (linea) linea.remove();
            }
            log('L√≠neas eliminadas');
            
            // Resetear nodos a posiciones originales
            for (let i = 0; i < 8; i++) {
                const nodo = document.getElementById(`nodo-${i + 1}`);
                if (nodo) {
                    nodo.setAttribute('position', `${posicionesOriginales[i][0]} ${posicionesOriginales[i][1]} 0`);
                    nodo.setAttribute('color', '#ff4444');
                    nodo.setAttribute('radius', '0.3');
                    nodo.removeAttribute('material');
                }
            }
            log('Nodos reseteados');
            
            // Resetear plano base
            const basePlane = document.getElementById('base-plane');
            if (basePlane) {
                basePlane.setAttribute('color', '#ffffff');
                basePlane.setAttribute('opacity', '0.3');
            }
            
            // Resetear botones
            document.getElementById('btn-3d').style.background = '#00aa00';
            document.getElementById('btn-ar').style.background = '#00aa00';
            document.getElementById('btn-place').disabled = true;
            document.getElementById('btn-deform').disabled = true;
            document.getElementById('btn-deform').textContent = 'üîß Deformar';
            document.getElementById('btn-deform').style.background = '#00aa00';
            
            cerrarModal();
            cambiarA3D();
            
            log('=== RESET COMPLETADO ===');
        }
        
        // Inicializaci√≥n
        window.addEventListener('DOMContentLoaded', function() {
            log('Aplicaci√≥n iniciada');
            cambiarA3D();
        });
        
        // Limpieza
        window.addEventListener('beforeunload', function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });
        
        // Exponer funciones globalmente
        window.cambiarA3D = cambiarA3D;
        window.cambiarAR = cambiarAR;
        window.colocarEstructura = colocarEstructura;
        window.toggleDeformacion = toggleDeformacion;
        window.resetear = resetear;
        window.toggleDebug = toggleDebug;
    </script>
</body>
</html>
