<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Estructura de Nodos AR • A-Frame</title>
    <meta name="description" content="Visualización 3D/AR de estructura con nodos y elementos conectados">
    
    <!-- A-Frame core -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- A-Frame AR.js para realidad aumentada -->
    <script src="https://cdn.jsdelivr.net/npm/ar.js@2.2.2/aframe/build/aframe-ar.min.js"></script>
    
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        overflow: hidden;
      }
      
      .info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 11px;
        z-index: 1000;
        max-width: 250px;
        backdrop-filter: blur(5px);
      }
      
      .controls {
        position: absolute;
        bottom: 60px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px;
        border-radius: 5px;
        font-size: 10px;
        z-index: 1000;
        backdrop-filter: blur(5px);
      }
      
      .deformation-control {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 11px;
        z-index: 1000;
        text-align: center;
        backdrop-filter: blur(5px);
      }
      
      .deformation-control button {
        padding: 8px 16px;
        background: #4488ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.3s ease;
        touch-action: manipulation;
      }
      
      .deformation-control button:hover,
      .deformation-control button:active {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
      
      .mode-selector {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 11px;
        z-index: 1000;
        text-align: center;
        backdrop-filter: blur(5px);
      }
      
      .mode-selector button {
        padding: 8px 12px;
        margin: 2px;
        background: #44ff44;
        color: black;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
        touch-action: manipulation;
      }
      
      .mode-selector button.active {
        background: #ffff44;
        color: black;
      }
      
      .debug-info {
        margin-top: 8px;
        font-size: 9px;
        color: #ccc;
        max-height: 120px;
        overflow-y: auto;
      }
      
      .ar-mode .info,
      .ar-mode .controls {
        opacity: 0.7;
        font-size: 10px;
      }
      
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 2000;
        text-align: center;
        display: none;
      }
      
      .loading.show {
        display: block;
      }
      
      .error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,0,0,0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 2001;
        text-align: center;
        display: none;
        max-width: 80%;
      }
      
      .error-message.show {
        display: block;
      }
      
      .permission-request {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,100,200,0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 2002;
        text-align: center;
        display: none;
      }
      
      .permission-request.show {
        display: block;
      }
      
      .permission-request button {
        padding: 10px 20px;
        background: white;
        color: #0064c8;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    
    <div id="loading" class="loading">
      <h3>Iniciando cámara...</h3>
      <p>Permitiendo acceso a la cámara para AR</p>
    </div>
    
    <div id="error-message" class="error-message">
      <h3>Error de cámara</h3>
      <p id="error-text">No se pudo acceder a la cámara</p>
      <button onclick="reintentar()">Reintentar</button>
      <button onclick="cambiarModo(false)">Usar modo 3D</button>
    </div>
    
    <div id="permission-request" class="permission-request">
      <h3>Permisos de Cámara</h3>
      <p>Esta aplicación necesita acceso a la cámara para funcionar en modo AR</p>
      <button onclick="solicitarPermisos()">Permitir Cámara</button>
      <button onclick="cambiarModo(false)">Solo modo 3D</button>
    </div>
    
    <div class="info">
      <h3>Estructura de Nodos AR</h3>
      <p><strong>Nodos:</strong> 8 (esferas rojas)</p>
      <p><strong>Elementos:</strong> 8 (líneas azules)</p>
      <p><strong>Escala:</strong> 0.3 (30% del tamaño)</p>
      <p id="mode-info"><strong>Modo:</strong> 3D Normal</p>
      <div id="debug-info" class="debug-info">
        <strong>Debug:</strong> Presiona el botón para ver deformaciones...
      </div>
    </div>
    
    <div class="deformation-control">
      <button id="btn-deformacion">Mostrar Deformada</button>
      <p><small>Desplazamientos amplificados 5000x</small></p>
    </div>
    
    <div class="mode-selector">
      <p><strong>Modo de Vista:</strong></p>
      <button id="btn-3d" class="active">3D Normal</button>
      <button id="btn-ar">AR Cámara</button>
    </div>
    
    <div class="controls">
      <strong id="controls-text">Controles 3D:</strong><br>
      <span id="controls-desc">Toca y arrastra: Rotar | Pellizca: Zoom</span>
    </div>

    <!-- Escena A-Frame -->
    <a-scene 
      id="main-scene"
      embedded 
      background="color: #f0f0f0"
      cursor="rayOrigin: mouse"
      loading-screen="enabled: false"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false">
      
      <!-- Iluminación -->
      <a-light type="ambient" color="#404040"></a-light>
      <a-light type="directional" position="2 4 2" color="#ffffff" intensity="0.8"></a-light>
      
      <!-- Entidad principal para modo 3D normal -->
      <a-entity id="estructura-principal">
        
        <!-- Plano de referencia (suelo) -->
        <a-plane id="suelo" 
                 position="4 -1 0" 
                 rotation="-90 0 0" 
                 width="12" 
                 height="8" 
                 color="#e8e8e8" 
                 opacity="0.7"
                 shadow="receive: true"></a-plane>
        
        <!-- Grid de referencia -->
        <a-entity id="grid">
          <!-- Líneas verticales -->
          <a-cylinder position="0 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="8 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <!-- Líneas horizontales -->
          <a-cylinder position="4 0 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 6 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
        </a-entity>

        <!-- NODOS (Esferas) -->
        <a-sphere id="nodo-1" position="0 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="1" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-2" position="0 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="2" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-3" position="0 6 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="3" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-4" position="4 6 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="4" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-5" position="4 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="5" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-6" position="4 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="6" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-7" position="8 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="7" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-8" position="8 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="8" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>

        <!-- Título informativo en 3D -->
        <a-text id="titulo-3d"
                position="4 8 0" 
                value="Estructura de Nodos y Elementos" 
                align="center" 
                color="#333333" 
                scale="6 6 6"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 20000"></a-text>
        
        <!-- Ejes de coordenadas -->
        <a-entity id="ejes" position="-2 -2 0">
          <a-cylinder position="1 0 0" radius="0.1" height="2" rotation="0 0 90" color="#ff0000"></a-cylinder>
          <a-text value="X" position="2.5 0 0" color="#ff0000" scale="4 4 4"></a-text>
          <a-cylinder position="0 1 0" radius="0.1" height="2" color="#00ff00"></a-cylinder>
          <a-text value="Y" position="0 2.5 0" color="#00ff00" scale="4 4 4"></a-text>
          <a-cylinder position="0 0 1" radius="0.1" height="2" rotation="90 0 0" color="#0000ff"></a-cylinder>
          <a-text value="Z" position="0 0 2.5" color="#0000ff" scale="4 4 4"></a-text>
        </a-entity>
      </a-entity>
      
      <!-- Cámara para modo 3D normal -->
      <a-camera id="camara-principal" 
                wasd-controls="acceleration: 5"
                look-controls="enabled: true; touchEnabled: true"
                cursor="rayOrigin: mouse"></a-camera>
    </a-scene>

    <script>
      // ESCALA DE LA ESTRUCTURA
      const ESCALA = 0.3;
      const ESCALA_AR = 0.1;
      
      // Estado de la aplicación
      let modoAR = false;
      let estructuraDeformada = false;
      let arInitialized = false;
      let cameraStream = null;
      
      // Datos de desplazamientos
      const desplazamientos = [
        {x: 0, y: 0, rot: 0},
        {x: -0.000214334467084222, y: -2.92585497916779e-05, rot: 0.000299282917049326},
        {x: -4.51228548254704e-05, y: -5.91445463001043e-05, rot: -0.00125414567113917},
        {x: -5.26077882706616e-05, y: -7.62472910434113e-05, rot: 0.00121519336768121},
        {x: -0.000205459371218351, y: -4.61332875518377e-05, rot: -0.000475039410395658},
        {x: 0, y: 0, rot: 0},
        {x: -0.000209509318349148, y: -1.46081626564844e-05, rot: 0.000595291931114151},
        {x: 0, y: 0, rot: 0}
      ];
      
      const FACTOR_AMPLIFICACION = 5000;
      
      // Conectividad de elementos
      const conectividad = [
        [0, 1], [1, 2], [2, 3], [3, 4], [1, 4], [4, 5], [4, 6], [6, 7]
      ];
      
      // Posiciones originales
      const posicionesOriginales = [
        [0, 0], [0, 3], [0, 6], [4, 6], [4, 3], [4, 0], [8, 3], [8, 0]
      ];
      
      let posicionesActuales = [];
      
      // Función para verificar si estamos en HTTPS
      function verificarHTTPS() {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          mostrarError('HTTPS requerido para AR', 'La realidad aumentada requiere HTTPS. Por favor, usa una conexión segura.');
          return false;
        }
        return true;
      }
      
      // Función para solicitar permisos de cámara
      async function solicitarPermisos() {
        const permissionRequest = document.getElementById('permission-request');
        const loading = document.getElementById('loading');
        
        permissionRequest.classList.remove('show');
        loading.classList.add('show');
        
        try {
          // Solicitar permisos de cámara
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: 'environment', // Cámara trasera preferida
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });
          
          cameraStream = stream;
          console.log('✅ Permisos de cámara obtenidos');
          
          // Inicializar AR ahora que tenemos permisos
          inicializarAR();
          
        } catch (error) {
          console.error('❌ Error al solicitar permisos:', error);
          loading.classList.remove('show');
          
          let mensaje = 'No se pudieron obtener los permisos de cámara.';
          if (error.name === 'NotAllowedError') {
            mensaje = 'Permisos de cámara denegados. Por favor, permite el acceso y recarga la página.';
          } else if (error.name === 'NotFoundError') {
            mensaje = 'No se encontró una cámara en este dispositivo.';
          } else if (error.name === 'NotSupportedError') {
            mensaje = 'Tu navegador no soporta acceso a cámara.';
          }
          
          mostrarError('Error de permisos', mensaje);
        }
      }
      
      // Función para mostrar errores
      function mostrarError(titulo, mensaje) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        document.getElementById('loading').classList.remove('show');
        errorText.textContent = mensaje;
        errorDiv.classList.add('show');
      }
      
      // Función para reintentar
      function reintentar() {
        document.getElementById('error-message').classList.remove('show');
        if (modoAR) {
          solicitarPermisos();
        }
      }
      
      // Función para crear línea
      function crearLinea(id, punto1, punto2, color = '#4488ff') {
        const lineaExistente = document.getElementById(id);
        if (lineaExistente) {
          lineaExistente.remove();
        }
        
        const linea = document.createElement('a-entity');
        linea.setAttribute('id', id);
        linea.setAttribute('line', {
          start: `${punto1.x} ${punto1.y} ${punto1.z || 0}`,
          end: `${punto2.x} ${punto2.y} ${punto2.z || 0}`,
          color: color,
          linewidth: 19,
          opacity: 0.8
        });
        
        const estructura = modoAR ? 
          (document.getElementById('estructura-ar') || document.getElementById('estructura-principal')) : 
          document.getElementById('estructura-principal');
        estructura.appendChild(linea);
      }
      
      // Función para actualizar líneas
      function actualizarLineas() {
        for (let i = 0; i < conectividad.length; i++) {
          const nodo1Idx = conectividad[i][0];
          const nodo2Idx = conectividad[i][1];
          const lineaId = `linea-${i + 1}`;
          
          const prefijo = modoAR ? 'nodo-ar-' : 'nodo-';
          const nodo1 = document.getElementById(`${prefijo}${nodo1Idx + 1}`);
          const nodo2 = document.getElementById(`${prefijo}${nodo2Idx + 1}`);
          
          if (nodo1 && nodo2) {
            const pos1 = nodo1.getAttribute('position');
            const pos2 = nodo2.getAttribute('position');
            const color = estructuraDeformada ? '#ff8844' : '#4488ff';
            crearLinea(lineaId, pos1, pos2, color);
          }
        }
      }
      
      // Función para inicializar AR
      async function inicializarAR() {
        const scene = document.getElementById('main-scene');
        const loading = document.getElementById('loading');
        
        try {
          // Crear nueva escena AR
          const arScene = document.createElement('a-scene');
          arScene.id = 'ar-scene';
          arScene.setAttribute('embedded', true);
          arScene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;');
          arScene.setAttribute('background', 'color: transparent');
          arScene.setAttribute('loading-screen', 'enabled: false');
          arScene.setAttribute('vr-mode-ui', 'enabled: false');
          
          // Crear marcador
          const marker = document.createElement('a-marker');
          marker.setAttribute('preset', 'hiro');
          marker.setAttribute('smooth', true);
          marker.setAttribute('smoothCount', 10);
          
          // Crear estructura AR
          const estructuraAR = document.createElement('a-entity');
          estructuraAR.id = 'estructura-ar';
          estructuraAR.setAttribute('scale', `${ESCALA_AR} ${ESCALA_AR} ${ESCALA_AR}`);
          
          // Clonar nodos para AR
          for (let i = 1; i <= 8; i++) {
            const nodoOriginal = document.getElementById(`nodo-${i}`);
            if (nodoOriginal) {
              const nodoAR = nodoOriginal.cloneNode(true);
              nodoAR.id = `nodo-ar-${i}`;
              estructuraAR.appendChild(nodoAR);
            }
          }
          
          marker.appendChild(estructuraAR);
          arScene.appendChild(marker);
          
          // Agregar iluminación
          const ambientLight = document.createElement('a-light');
          ambientLight.setAttribute('type', 'ambient');
          ambientLight.setAttribute('color', '#404040');
          arScene.appendChild(ambientLight);
          
          const directionalLight = document.createElement('a-light');
          directionalLight.setAttribute('type', 'directional');
          directionalLight.setAttribute('position', '2 4 2');
          arScene.appendChild(directionalLight);
          
          // Crear cámara AR
          const cameraAR = document.createElement('a-entity');
          cameraAR.setAttribute('camera', '');
          arScene.appendChild(cameraAR);
          
          // Reemplazar escena
          const oldScene = document.getElementById('main-scene');
          oldScene.parentNode.replaceChild(arScene, oldScene);
          
          // Event listeners para AR
          arScene.addEventListener('arjs-video-loaded', function() {
            console.log('📹 Cámara AR inicializada correctamente');
            loading.classList.remove('show');
            arInitialized = true;
            
            // Actualizar líneas después de un momento
            setTimeout(() => {
              actualizarLineas();
            }, 1000);
          });
          
          marker.addEventListener('markerFound', function() {
            console.log('🎯 Marcador encontrado');
            estructuraAR.setAttribute('visible', true);
          });
          
          marker.addEventListener('markerLost', function() {
            console.log('❌ Marcador perdido');
          });
          
          // Timeout por si AR no se inicializa
          setTimeout(() => {
            if (!arInitialized) {
              loading.classList.remove('show');
              mostrarError('Timeout AR', 'AR tardó demasiado en inicializar. Verifica tu cámara.');
            }
          }, 10000);
          
        } catch (error) {
          console.error('❌ Error inicializando AR:', error);
          loading.classList.remove('show');
          mostrarError('Error AR', 'No se pudo inicializar la realidad aumentada: ' + error.message);
        }
      }
      
      // Función para alternar deformación
      function toggleDeformacion() {
        estructuraDeformada = !estructuraDeformada;
        const boton = document.getElementById('btn-deformacion');
        const debugInfo = document.getElementById('debug-info');
        
        let debugText = `<strong>Estado:</strong> ${estructuraDeformada ? 'DEFORMADA' : 'ORIGINAL'}<br>`;
        debugText += `<strong>Modo:</strong> ${modoAR ? 'AR' : '3D'}<br>`;
        debugText += `<strong>Amplificación:</strong> ${FACTOR_AMPLIFICACION}x<br><br>`;
        
        posicionesActuales = [];
        
        const prefijo = modoAR ? 'nodo-ar-' : 'nodo-';
        
        for (let i = 0; i < 8; i++) {
          const nodo = document.getElementById(`${prefijo}${i + 1}`);
          
          if (nodo) {
            let x, y;
            
            if (estructuraDeformada) {
              const desplX = desplazamientos[i].x * FACTOR_AMPLIFICACION;
              const desplY = desplazamientos[i].y * FACTOR_AMPLIFICACION;
              x = posicionesOriginales[i][0] + desplX;
              y = posicionesOriginales[i][1] + desplY;
              const rotZ = desplazamientos[i].rot * (180 / Math.PI) * FACTOR_AMPLIFICACION;
              
              nodo.setAttribute('position', {x: x, y: y, z: 0});
              nodo.setAttribute('rotation', {x: 0, y: 0, z: rotZ});
              nodo.setAttribute('material', 'color', '#ff8844');
              
              if (desplX !== 0 || desplY !== 0 || rotZ !== 0) {
                debugText += `<span style="color: #ff8844;">N${i + 1}: [${x.toFixed(1)}, ${y.toFixed(1)}] rot:${rotZ.toFixed(0)}°</span><br>`;
              } else {
                debugText += `N${i + 1}: [${x}, ${y}] sin desplazamiento<br>`;
              }
            } else {
              x = posicionesOriginales[i][0];
              y = posicionesOriginales[i][1];
              
              nodo.setAttribute('position', {x: x, y: y, z: 0});
              nodo.setAttribute('rotation', {x: 0, y: 0, z: 0});
              nodo.setAttribute('material', 'color', '#ff4444');
              
              debugText += `N${i + 1}: [${x}, ${y}] original<br>`;
            }
            
            posicionesActuales[i] = {x: x, y: y};
          }
        }
        
        setTimeout(() => {
          actualizarLineas();
        }, 150);
        
        if (debugInfo) {
          debugInfo.innerHTML = debugText;
        }
        
        if (boton) {
          boton.textContent = estructuraDeformada ? 'Mostrar Original' : 'Mostrar Deformada';
          boton.style.backgroundColor = estructuraDeformada ? '#ff6644' : '#4488ff';
        }
      }
      
      // Función para cambiar entre modo 3D y AR
      function cambiarModo(nuevoModoAR) {
        const btn3D = document.getElementById('btn-3d');
        const btnAR = document.getElementById('btn-ar');
        const modeInfo = document.getElementById('mode-info');
        const controlsText = document.getElementById('controls-text');
        const controlsDesc = document.getElementById('controls-desc');
        
        if (nuevoModoAR === modoAR) return; // Ya estamos en ese modo
        
        modoAR = nuevoModoAR;
        
        if (modoAR) {
          // Cambiar a modo AR
          if (!verificarHTTPS()) {
            modoAR = false;
            return;
          }
          
          // Mostrar solicitud de permisos
          document.getElementById('permission-request').classList.add('show');
          
          // Actualizar UI
          document.body.classList.add('ar-mode');
          btn3D.classList.remove('active');
          btnAR.classList.add('active');
          modeInfo.innerHTML = '<strong>Modo:</strong> AR Cámara';
          controlsText.textContent = 'Controles AR:';
          controlsDesc.textContent = 'Apunta la cámara al marcador Hiro';
          
        } else {
          // Cambiar a modo 3D
          if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
          }
          
          // Restaurar escena 3D original si estamos en AR
          if (document.getElementById('ar-scene')) {
            location.reload(); // Manera más simple de restaurar
            return;
          }
          
          // Actualizar UI
          document.body.classList.remove('ar-mode');
          btn3D.classList.add('active');
          btnAR.classList.remove('active');
          modeInfo.innerHTML = '<strong>Modo:</strong> 3D Normal';
          controlsText.textContent = 'Controles 3D:';
          controlsDesc.textContent = 'Toca y arrastra: Rotar | Pellizca: Zoom';
          
          // Ocultar todos los popups
          document.getElementById('permission-request').classList.remove('show');
          document.getElementById('error-message').classList.remove('show');
          document.getElementById('loading').classList.remove('show');
          
          console.log('✅ Modo 3D activado');
        }
      }
      
      // Función para verificar soporte de AR
      function verificarSoporteAR() {
        // Verificar si el navegador soporta getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          console.warn('⚠️ getUserMedia no soportado');
          return false;
        }
        
        // Verificar si estamos en un contexto seguro
        if (!window.isSecureContext) {
          console.warn('⚠️ Contexto no seguro');
          return false;
        }
        
        return true;
      }
      
      // Inicialización cuando se carga la página
      window.addEventListener('DOMContentLoaded', function() {
        const estructura = document.getElementById('estructura-principal');
        const camara = document.getElementById('camara-principal');
        const boton = document.getElementById('btn-deformacion');
        const btn3D = document.getElementById('btn-3d');
        const btnAR = document.getElementById('btn-ar');
        
        // Verificar soporte AR
        if (!verificarSoporteAR()) {
          btnAR.disabled = true;
          btnAR.textContent = 'AR No Disponible';
          btnAR.style.background = '#666';
        }
        
        // Configurar event listeners
        if (boton) {
          boton.addEventListener('click', toggleDeformacion);
        }
        
        if (btn3D) {
          btn3D.addEventListener('click', () => cambiarModo(false));
        }
        
        if (btnAR && !btnAR.disabled) {
          btnAR.addEventListener('click', () => cambiarModo(true));
        }
        
        // Aplicar escala inicial
        estructura.setAttribute('scale', `${ESCALA} ${ESCALA} ${ESCALA}`);
        
        // Configurar cámara 3D
        const Lv1 = 3, Lh1 = 4;
        const dimensionX = Lh1 * 2 * ESCALA;
        const dimensionY = Lv1 * 2 * ESCALA;
        const centroX = dimensionX / 2;
        const centroY = dimensionY / 2;
        const distanciaOptima = Math.max(dimensionX, dimensionY) * 3;
        const alturaOptima = dimensionY * 1.5;
        
        camara.setAttribute('position', `${centroX} ${alturaOptima} ${distanciaOptima}`);
        camara.setAttribute('look-at', `${centroX} ${centroY} 0`);
        
        // Crear líneas iniciales después de que la escena esté lista
        setTimeout(() => {
          actualizarLineas();
        }, 500);
        
        console.log('🚀 Sistema 3D/AR inicializado');
        console.log('🔒 HTTPS:', location.protocol === 'https:');
        console.log('📱 Dispositivo móvil:', /Mobi|Android/i.test(navigator.userAgent));
        console.log('🎥 getUserMedia:', !!navigator.mediaDevices?.getUserMedia);
      });
      
      // Event listeners globales
      window.addEventListener('beforeunload', function() {
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
        }
      });
      
      // Función global para reintentar (llamada desde HTML)
      window.reintentar = reintentar;
      window.solicitarPermisos = solicitarPermisos;
      window.cambiarModo = cambiarModo;
      
      // Debug: Mostrar información del navegador
      console.log('🌐 Navegador:', navigator.userAgent);
      console.log('🔐 Contexto seguro:', window.isSecureContext);
      console.log('📍 Protocolo:', location.protocol);
      console.log('🏠 Host:', location.hostname);
    </script>
  </body>
</html>
