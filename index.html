<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Estructura AR - Detección de Superficies</title>
    <meta name="description" content="AR con detección de planos usando WebXR y fallback a AR.js">
    
    <!-- A-Frame core -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        overflow: hidden;
        background: #000;
      }
      
      .info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 1000;
        max-width: 280px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }
      
      .controls {
        position: absolute;
        bottom: 80px;
        left: 10px;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-size: 11px;
        z-index: 1000;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      .deformation-control {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 1000;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      .deformation-control button {
        padding: 10px 18px;
        background: #4488ff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: bold;
        transition: all 0.3s ease;
        touch-action: manipulation;
        min-width: 140px;
      }
      
      .deformation-control button:hover:not(:disabled),
      .deformation-control button:active:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(68,136,255,0.4);
      }
      
      .deformation-control button:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
        opacity: 0.6;
      }
      
      .mode-selector {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 1000;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      .mode-selector button {
        padding: 10px 14px;
        margin: 3px;
        background: #44ff44;
        color: black;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        touch-action: manipulation;
        transition: all 0.3s ease;
        min-width: 100px;
      }
      
      .mode-selector button.active {
        background: #ffff44;
        color: black;
        transform: scale(1.05);
      }
      
      .mode-selector button:disabled {
        background: #666;
        color: #ccc;
        cursor: not-allowed;
      }
      
      .ar-instructions {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,50,100,0.95);
        color: white;
        padding: 25px;
        border-radius: 12px;
        z-index: 1500;
        text-align: center;
        max-width: 85%;
        display: none;
        border: 2px solid #00aaff;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      }
      
      .ar-instructions.show {
        display: block;
        animation: slideIn 0.5s ease-out;
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translate(-50%, -60%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
      }
      
      .ar-instructions h3 {
        color: #00ddff;
        margin-top: 0;
        font-size: 18px;
      }
      
      .ar-instructions button {
        padding: 12px 24px;
        background: #00aaff;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 15px;
        font-size: 14px;
        transition: all 0.3s ease;
      }
      
      .ar-instructions button:hover {
        background: #0088cc;
        transform: translateY(-2px);
      }
      
      .debug-info {
        margin-top: 8px;
        font-size: 10px;
        color: #bbb;
        max-height: 140px;
        overflow-y: auto;
        background: rgba(0,0,0,0.3);
        padding: 8px;
        border-radius: 4px;
        border-left: 3px solid #4488ff;
      }
      
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.95);
        color: white;
        padding: 30px;
        border-radius: 12px;
        z-index: 2000;
        text-align: center;
        display: none;
        border: 1px solid #666;
        box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      }
      
      .loading.show {
        display: block;
      }
      
      .loading .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #333;
        border-top: 4px solid #00aaff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(150,0,0,0.95);
        color: white;
        padding: 25px;
        border-radius: 12px;
        z-index: 2001;
        text-align: center;
        display: none;
        max-width: 85%;
        border: 2px solid #ff4444;
        box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      }
      
      .error-message.show {
        display: block;
      }
      
      .error-message button {
        padding: 10px 20px;
        background: #ff6666;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        margin: 8px;
        transition: all 0.3s ease;
      }
      
      .error-message button:hover {
        background: #ff4444;
        transform: translateY(-2px);
      }
      
      .permission-request {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,100,200,0.95);
        color: white;
        padding: 25px;
        border-radius: 12px;
        z-index: 2002;
        text-align: center;
        display: none;
        border: 2px solid #00aaff;
        box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      }
      
      .permission-request.show {
        display: block;
      }
      
      .permission-request button {
        padding: 12px 24px;
        background: white;
        color: #0064c8;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        margin: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
      }
      
      .permission-request button:hover {
        background: #f0f0f0;
        transform: translateY(-2px);
      }
      
      .reset-button {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255,100,0,0.9);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1000;
        display: none;
        font-size: 14px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(255,100,0,0.3);
      }
      
      .reset-button.show {
        display: block;
      }
      
      .reset-button:hover {
        background: rgba(255,80,0,0.95);
        transform: translateX(-50%) translateY(-2px);
      }
      
      .ar-mode .info,
      .ar-mode .controls {
        opacity: 0.9;
        font-size: 10px;
      }
      
      .ar-cursor {
        width: 60px;
        height: 60px;
        border: 3px solid #00ff00;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 1001;
        display: none;
        background: rgba(0,255,0,0.1);
        animation: pulse 2s infinite;
      }
      
      .ar-cursor.show {
        display: block;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
        50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
      }
      
      .debug-panel {
        position: absolute;
        top: 200px;
        left: 10px;
        background: rgba(0,0,0,0.9);
        color: #00ff00;
        padding: 10px;
        border-radius: 5px;
        font-size: 10px;
        z-index: 1200;
        max-width: 280px;
        font-family: monospace;
        border: 1px solid #00ff00;
        display: none;
        max-height: 200px;
        overflow-y: auto;
      }
      
      .debug-panel.show {
        display: block;
      }
      
      .debug-panel .log-entry {
        margin: 2px 0;
        padding: 2px;
        border-left: 2px solid #00ff00;
        padding-left: 5px;
      }
      
      .debug-panel .log-error {
        color: #ff4444;
        border-left-color: #ff4444;
      }
      
      .debug-panel .log-success {
        color: #44ff44;
        border-left-color: #44ff44;
      }
      
      .debug-panel .log-info {
        color: #4444ff;
        border-left-color: #4444ff;
      }
      
      .debug-toggle {
        position: absolute;
        top: 120px;
        right: 10px;
        background: rgba(0,255,0,0.8);
        color: black;
        padding: 8px 12px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        z-index: 1300;
        width: 50px;
        height: 50px;
      }
    </style>
  </head>
  <body>
    
    <div id="loading" class="loading">
      <h3>🚀 Iniciando AR</h3>
      <div class="spinner"></div>
      <p id="loading-text">Preparando cámara y detección de superficies...</p>
      <p><small>Esto puede tomar hasta 30 segundos</small></p>
    </div>
    
    <div id="error-message" class="error-message">
      <h3>❌ Error de AR</h3>
      <p id="error-text">No se pudo inicializar AR</p>
      <div id="error-details"></div>
      <button onclick="reintentar()">🔄 Reintentar</button>
      <button onclick="cambiarModo(false)">🖥️ Usar modo 3D</button>
    </div>
    
    <div id="permission-request" class="permission-request">
      <h3>🎥 Permisos de Cámara</h3>
      <p>Necesitamos acceso a tu cámara para AR</p>
      <p><small>Se usará para detectar superficies y colocar la estructura 3D</small></p>
      <button onclick="solicitarPermisos()">✅ Permitir Cámara</button>
      <button onclick="cambiarModo(false)">❌ Solo modo 3D</button>
    </div>
    
    <div id="ar-instructions" class="ar-instructions">
      <h3>🎯 AR Activado</h3>
      <p><strong>¡Listo para colocar estructura!</strong></p>
      <div style="text-align: left; margin: 15px 0;">
        <p>📱 <strong>Paso 1:</strong> Mantén el dispositivo estable</p>
        <p>👆 <strong>Paso 2:</strong> Toca CUALQUIER PARTE de la pantalla</p>
        <p>🏗️ <strong>Paso 3:</strong> La estructura aparecerá frente a ti</p>
      </div>
      <p><small><strong>Nota:</strong> Toca fuera de estos botones azules</small></p>
      <button onclick="cerrarInstrucciones()">¡Entendido!</button>
      <button onclick="colocarEstructuraManual()" style="background: #ff6600; margin-left: 10px;">🎯 Colocar Ahora</button>
    </div>
    
    <button id="debug-toggle" class="debug-toggle" onclick="toggleDebug()">🐛</button>
    
    <div id="debug-panel" class="debug-panel">
      <div style="border-bottom: 1px solid #00ff00; margin-bottom: 5px; padding-bottom: 3px;">
        <strong>🐛 DEBUG PANEL</strong>
        <button onclick="clearDebugLog()" style="float: right; background: #ff4444; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 9px;">Limpiar</button>
      </div>
      <div id="debug-log"></div>
    </div>
    
    <div id="ar-cursor" class="ar-cursor"></div>
    
    <div class="info">
      <h3>🏗️ Estructura de Nodos AR</h3>
      <p><strong>Nodos:</strong> 8 (esferas rojas)</p>
      <p><strong>Elementos:</strong> 8 (líneas azules)</p>
      <p id="mode-info"><strong>Modo:</strong> 3D Normal</p>
      <p id="ar-status"><strong>Estado:</strong> Esperando...</p>
      <div id="debug-info" class="debug-info">
        <strong>Sistema:</strong> Listo para usar
      </div>
    </div>
    
    <div class="deformation-control">
      <button id="btn-deformacion" disabled>Mostrar Deformada</button>
      <p><small>Desplazamientos amplificados 5000x</small></p>
      <p><small id="deform-status">Primero coloca la estructura</small></p>
    </div>
    
    <div class="mode-selector">
      <p><strong>Modo de Vista:</strong></p>
      <button id="btn-3d" class="active">🖥️ 3D Normal</button>
      <button id="btn-ar">📱 AR Superficie</button>
    </div>
    
    <div class="controls">
      <strong id="controls-text">Controles 3D:</strong><br>
      <span id="controls-desc">Arrastra: Rotar • Pellizca: Zoom</span>
    </div>
    
    <button id="reset-button" class="reset-button" onclick="resetearEstructura()">
      🔄 Recolocar Estructura
    </button>

    <!-- Escena A-Frame -->
    <a-scene 
      id="main-scene"
      embedded 
      background="color: #f0f0f0"
      cursor="rayOrigin: mouse"
      loading-screen="enabled: false"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false">
      
      <!-- Iluminación -->
      <a-light type="ambient" color="#404040"></a-light>
      <a-light type="directional" position="2 4 2" color="#ffffff" intensity="0.8"></a-light>
      
      <!-- Entidad principal para modo 3D normal -->
      <a-entity id="estructura-principal">
        
        <!-- Plano de referencia (suelo) -->
        <a-plane id="suelo" 
                 position="4 -1 0" 
                 rotation="-90 0 0" 
                 width="12" 
                 height="8" 
                 color="#e8e8e8" 
                 opacity="0.7"
                 shadow="receive: true"></a-plane>
        
        <!-- Grid de referencia -->
        <a-entity id="grid">
          <a-cylinder position="0 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="8 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 0 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 6 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
        </a-entity>

        <!-- NODOS (Esferas) -->
        <a-sphere id="nodo-1" position="0 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="1" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-2" position="0 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="2" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-3" position="0 6 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="3" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-4" position="4 6 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="4" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-5" position="4 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="5" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-6" position="4 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="6" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-7" position="8 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="7" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-8" position="8 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="8" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>

        <!-- Título informativo en 3D -->
        <a-text id="titulo-3d"
                position="4 8 0" 
                value="Estructura de Nodos y Elementos" 
                align="center" 
                color="#333333" 
                scale="6 6 6"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 20000"></a-text>
        
        <!-- Ejes de coordenadas -->
        <a-entity id="ejes" position="-2 -2 0">
          <a-cylinder position="1 0 0" radius="0.1" height="2" rotation="0 0 90" color="#ff0000"></a-cylinder>
          <a-text value="X" position="2.5 0 0" color="#ff0000" scale="4 4 4"></a-text>
          <a-cylinder position="0 1 0" radius="0.1" height="2" color="#00ff00"></a-cylinder>
          <a-text value="Y" position="0 2.5 0" color="#00ff00" scale="4 4 4"></a-text>
          <a-cylinder position="0 0 1" radius="0.1" height="2" rotation="90 0 0" color="#0000ff"></a-cylinder>
          <a-text value="Z" position="0 0 2.5" color="#0000ff" scale="4 4 4"></a-text>
        </a-entity>
      </a-entity>
      
      <!-- Cámara para modo 3D normal -->
      <a-camera id="camara-principal" 
                wasd-controls="acceleration: 5"
                look-controls="enabled: true; touchEnabled: true"
                cursor="rayOrigin: mouse"></a-camera>
    </a-scene>

    <script>
      // CONFIGURACIÓN
      const ESCALA = 3;
      const ESCALA_AR = 1;
      
      // Sistema de debug visual
      let debugLog = [];
      let debugVisible = false;
      
      function logDebug(mensaje, tipo = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const entry = `[${timestamp}] ${mensaje}`;
        debugLog.push({ entry, tipo });
        
        // Limitar a 50 entradas
        if (debugLog.length > 50) {
          debugLog.shift();
        }
        
        // También log normal para consola
        console.log(entry);
        
        // Actualizar panel visual si está visible
        if (debugVisible) {
          actualizarDebugPanel();
        }
      }
      
      function actualizarDebugPanel() {
        const debugLogDiv = document.getElementById('debug-log');
        if (!debugLogDiv) return;
        
        debugLogDiv.innerHTML = debugLog.map(item => 
          `<div class="log-entry log-${item.tipo}">${item.entry}</div>`
        ).join('');
        
        // Scroll al final
        debugLogDiv.scrollTop = debugLogDiv.scrollHeight;
      }
      
      function toggleDebug() {
        debugVisible = !debugVisible;
        const panel = document.getElementById('debug-panel');
        const button = document.getElementById('debug-toggle');
        
        if (debugVisible) {
          panel.classList.add('show');
          button.textContent = '❌';
          button.style.background = 'rgba(255,0,0,0.8)';
          actualizarDebugPanel();
          logDebug('Debug panel activado', 'success');
        } else {
          panel.classList.remove('show');
          button.textContent = '🐛';
          button.style.background = 'rgba(0,255,0,0.8)';
        }
      }
      
      function clearDebugLog() {
        debugLog = [];
        actualizarDebugPanel();
        logDebug('Log limpiado', 'info');
      }
      
      // Datos de desplazamientos
      const desplazamientos = [
        {x: 0, y: 0, rot: 0},
        {x: -0.000214334467084222, y: -2.92585497916779e-05, rot: 0.000299282917049326},
        {x: -4.51228548254704e-05, y: -5.91445463001043e-05, rot: -0.00125414567113917},
        {x: -5.26077882706616e-05, y: -7.62472910434113e-05, rot: 0.00121519336768121},
        {x: -0.000205459371218351, y: -4.61332875518377e-05, rot: -0.000475039410395658},
        {x: 0, y: 0, rot: 0},
        {x: -0.000209509318349148, y: -1.46081626564844e-05, rot: 0.000595291931114151},
        {x: 0, y: 0, rot: 0}
      ];
      
      const FACTOR_AMPLIFICACION = 500;
      
      // Conectividad de elementos
      const conectividad = [
        [0, 1], [1, 2], [2, 3], [3, 4], [1, 4], [4, 5], [4, 6], [6, 7]
      ];
      
      // Posiciones originales
      const posicionesOriginales = [
        [0, 0], [0, 3], [0, 6], [4, 6], [4, 3], [4, 0], [8, 3], [8, 0]
      ];
      
      let posicionesActuales = [];
      
      // Función para verificar HTTPS
      function verificarHTTPS() {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
          mostrarError('HTTPS requerido', 'AR requiere HTTPS o localhost para acceder a la cámara');
          return false;
        }
        return true;
      }
      
      // Función para detectar capacidades del dispositivo
      function detectarCapacidades() {
        const capacidades = {
          getUserMedia: !!(navigator.mediaDevices?.getUserMedia),
          webxr: !!(navigator.xr),
          https: window.isSecureContext,
          mobile: /Mobi|Android/i.test(navigator.userAgent),
          iOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
          chrome: /Chrome/.test(navigator.userAgent),
          safari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)
        };
        
        console.log('📊 Capacidades del dispositivo:', capacidades);
        return capacidades;
      }
      
      // Función para actualizar texto de carga
      function actualizarCarga(mensaje) {
        const loadingText = document.getElementById('loading-text');
        if (loadingText) {
          loadingText.textContent = mensaje;
        }
        console.log('⏳', mensaje);
      }
      
      // Función para solicitar permisos de cámara
      async function solicitarPermisos() {
        const permissionRequest = document.getElementById('permission-request');
        const loading = document.getElementById('loading');
        
        permissionRequest.classList.remove('show');
        loading.classList.add('show');
        
        try {
          actualizarCarga('Solicitando permisos de cámara...');
          
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280, min: 640 },
              height: { ideal: 720, min: 480 }
            }
          });
          
          cameraStream = stream;
          console.log('✅ Permisos de cámara obtenidos');
          
          // Intentar método simple primero
          inicializarARSimple();
          
        } catch (error) {
          console.error('❌ Error al solicitar permisos:', error);
          loading.classList.remove('show');
          
          let mensaje = 'No se pudieron obtener los permisos de cámara.';
          let detalles = '';
          
          if (error.name === 'NotAllowedError') {
            mensaje = 'Permisos de cámara denegados.';
            detalles = 'Por favor, permite el acceso a la cámara y recarga la página.';
          } else if (error.name === 'NotFoundError') {
            mensaje = 'No se encontró una cámara en este dispositivo.';
            detalles = 'Verifica que tu dispositivo tenga una cámara disponible.';
          } else if (error.name === 'NotSupportedError') {
            mensaje = 'Tu navegador no soporta acceso a cámara.';
            detalles = 'Prueba con Chrome o Safari en un dispositivo móvil.';
          }
          
          mostrarError(mensaje, detalles);
        }
      }
      
      // Función para mostrar errores
      function mostrarError(titulo, detalles = '') {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const errorDetails = document.getElementById('error-details');
        
        document.getElementById('loading').classList.remove('show');
        errorText.textContent = titulo;
        errorDetails.innerHTML = detalles ? `<p><small>${detalles}</small></p>` : '';
        errorDiv.classList.add('show');
      }
      
      // Función para reintentar
      function reintentar() {
        document.getElementById('error-message').classList.remove('show');
        if (modoAR) {
          // Limpiar estado anterior
          if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
          }
          arInitialized = false;
          solicitarPermisos();
        }
      }
      
      // Función para cerrar instrucciones
      function cerrarInstrucciones() {
        document.getElementById('ar-instructions').classList.remove('show');
        document.getElementById('ar-cursor').classList.add('show');
      }
      
      // Función para inicializar AR simple (sin librerías externas)
      function inicializarARSimple() {
        const loading = document.getElementById('loading');
        
        try {
          actualizarCarga('Configurando AR nativo...');
          
          // Crear escena AR básica con A-Frame
          const arScene = document.createElement('a-scene');
          arScene.id = 'ar-scene';
          arScene.setAttribute('embedded', true);
          arScene.setAttribute('background', 'color: transparent');
          arScene.setAttribute('loading-screen', 'enabled: false');
          arScene.setAttribute('vr-mode-ui', 'enabled: false');
          arScene.setAttribute('device-orientation-permission-ui', 'enabled: false');
          
          // Configurar video de cámara como fondo
          const video = document.createElement('video');
          video.id = 'camera-feed';
          video.setAttribute('autoplay', '');
          video.setAttribute('muted', '');
          video.setAttribute('playsinline', '');
          video.style.position = 'fixed';
          video.style.top = '0';
          video.style.left = '0';
          video.style.width = '100%';
          video.style.height = '100%';
          video.style.objectFit = 'cover';
          video.style.zIndex = '-1';
          
          // Configurar stream de cámara
          if (cameraStream) {
            video.srcObject = cameraStream;
            video.play().then(() => {
              console.log('📹 Video de cámara iniciado');
            }).catch(e => {
              console.error('❌ Error reproduciendo video:', e);
            });
          }
          
          // Agregar video al DOM
          document.body.appendChild(video);
          
          // Crear overlay transparente para capturar eventos
          const overlay = document.createElement('div');
          overlay.id = 'ar-overlay';
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100%';
          overlay.style.height = '100%';
          overlay.style.zIndex = '500';
          overlay.style.background = 'transparent';
          overlay.style.cursor = 'crosshair';
          
          // Event listeners para el overlay (más confiable)
          overlay.addEventListener('click', manejarToqueAR, { passive: false });
          overlay.addEventListener('touchstart', manejarToqueAR, { passive: false });
          
          document.body.appendChild(overlay);
          
          // Crear cámara AR
          const cameraAR = document.createElement('a-entity');
          cameraAR.setAttribute('camera', 'active: true; fov: 70;');
          cameraAR.setAttribute('position', '0 1.6 0');
          arScene.appendChild(cameraAR);
          
          // Agregar iluminación
          const ambientLight = document.createElement('a-light');
          ambientLight.setAttribute('type', 'ambient');
          ambientLight.setAttribute('color', '#777777');
          arScene.appendChild(ambientLight);
          
          const directionalLight = document.createElement('a-light');
          directionalLight.setAttribute('type', 'directional');
          directionalLight.setAttribute('position', '0 5 5');
          directionalLight.setAttribute('color', '#ffffff');
          directionalLight.setAttribute('intensity', '0.8');
          arScene.appendChild(directionalLight);
          
          // Reemplazar escena
          const oldScene = document.getElementById('main-scene');
          oldScene.parentNode.replaceChild(arScene, oldScene);
          
          // Simular inicialización exitosa después de un breve delay
          setTimeout(() => {
            console.log('✅ AR simple inicializado');
            loading.classList.remove('show');
            document.getElementById('ar-instructions').classList.add('show');
            arInitialized = true;
            actualizarEstadoAR('✅ Listo - Toca la pantalla para colocar');
          }, 2000);
          
        } catch (error) {
          console.error('❌ Error inicializando AR simple:', error);
          loading.classList.remove('show');
          mostrarError('Error AR Simple', 'No se pudo configurar la cámara AR: ' + error.message);
        }
      }
      
      // Estado de la aplicación
      let modoAR = false;
      let estructuraDeformada = false;
      let estructuraColocada = false;
      let arInitialized = false;
      let cameraStream = null;
      let estructuraAR = null;
      let arMethod = 'simple'; // 'simple' o 'webxr'
      
      // Función para manejar toques en AR
      function manejarToqueAR(event) {
        logDebug(`🎯 Evento recibido: ${event.type}`, 'info');
        logDebug(`📊 Estados: AR=${modoAR}, Colocada=${estructuraColocada}, Init=${arInitialized}`, 'info');
        
        if (!modoAR || estructuraColocada || !arInitialized) {
          logDebug(`❌ Toque ignorado - AR:${modoAR} Colocada:${estructuraColocada} Init:${arInitialized}`, 'error');
          return;
        }
        
        event.preventDefault();
        event.stopPropagation();
        
        logDebug('👆 Procesando toque válido...', 'success');
        
        // Calcular posición del toque
        let clientX, clientY;
        if (event.type === 'touchstart' && event.touches && event.touches.length > 0) {
          clientX = event.touches[0].clientX;
          clientY = event.touches[0].clientY;
          logDebug(`📱 Toque táctil: (${clientX}, ${clientY})`, 'info');
        } else if (event.type === 'click') {
          clientX = event.clientX;
          clientY = event.clientY;
          logDebug(`🖱️ Click: (${clientX}, ${clientY})`, 'info');
        } else {
          logDebug(`❓ Tipo evento desconocido: ${event.type}`, 'error');
          return;
        }
        
        // Convertir coordenadas de pantalla a posición 3D
        const rect = { left: 0, top: 0, width: window.innerWidth, height: window.innerHeight };
        const x = ((clientX - rect.left) / rect.width) * 2 - 1;
        const y = -((clientY - rect.top) / rect.height) * 2 + 1;
        
        logDebug(`📍 Coords normalizadas: x=${x.toFixed(2)}, y=${y.toFixed(2)}`, 'info');
        
        // Colocar estructura con desplazamiento basado en el toque
        const position = {
          x: x * 0.8, // Más rango de movimiento lateral
          y: -0.2,     // Altura ajustada
          z: -1.2      // Un poco más lejos para mejor visualización
        };
        
        logDebug(`🎯 Posición calculada: (${position.x.toFixed(2)}, ${position.y.toFixed(2)}, ${position.z.toFixed(2)})`, 'success');
        colocarEstructura(position);
      }
      
      // Función global para colocación manual (botón de emergencia)
      function colocarEstructuraManual() {
        logDebug('🔧 Colocación manual iniciada', 'info');
        
        if (!modoAR || estructuraColocada) {
          logDebug(`❌ Colocación manual bloqueada - AR:${modoAR}, Colocada:${estructuraColocada}`, 'error');
          return;
        }
        
        logDebug('✅ Ejecutando colocación manual...', 'success');
        const position = { x: 0, y: -0.2, z: -1.2 };
        colocarEstructura(position);
      }
      
      // Función para crear línea
      function crearLinea(id, punto1, punto2, color = '#4488ff') {
        const lineaExistente = document.getElementById(id);
        if (lineaExistente) {
          lineaExistente.remove();
        }
        
        const linea = document.createElement('a-entity');
        linea.setAttribute('id', id);
        linea.setAttribute('line', {
          start: `${punto1.x} ${punto1.y} ${punto1.z || 0}`,
          end: `${punto2.x} ${punto2.y} ${punto2.z || 0}`,
          color: color,
          linewidth: 12,
          opacity: 0.9
        });
        
        // Agregar a la estructura AR si existe, sino a la escena
        const contenedor = estructuraAR || document.querySelector('a-scene');
        if (contenedor) {
          contenedor.appendChild(linea);
        }
      }
      
      // Función para actualizar líneas
      function actualizarLineas() {
        for (let i = 0; i < conectividad.length; i++) {
          const nodo1Idx = conectividad[i][0];
          const nodo2Idx = conectividad[i][1];
          const lineaId = `linea-${i + 1}`;
          
          const prefijo = modoAR ? 'nodo-ar-' : 'nodo-';
          const nodo1 = document.getElementById(`${prefijo}${nodo1Idx + 1}`);
          const nodo2 = document.getElementById(`${prefijo}${nodo2Idx + 1}`);
          
          if (nodo1 && nodo2) {
            const pos1 = nodo1.getAttribute('position');
            const pos2 = nodo2.getAttribute('position');
            const color = estructuraDeformada ? '#ff8844' : '#4488ff';
            crearLinea(lineaId, pos1, pos2, color);
          }
        }
      }
      
      // Función para colocar estructura en posición específica
      function colocarEstructura(position) {
        logDebug('🏗️ Iniciando colocación de estructura...', 'info');
        
        if (estructuraColocada) {
          logDebug('❌ Estructura ya colocada, ignorando', 'error');
          return;
        }
        
        logDebug(`📍 Colocando en posición: (${position.x.toFixed(2)}, ${position.y.toFixed(2)}, ${position.z.toFixed(2)})`, 'info');
        
        // Crear contenedor de estructura AR
        estructuraAR = document.createElement('a-entity');
        estructuraAR.id = 'estructura-ar';
        estructuraAR.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
        estructuraAR.setAttribute('scale', `${ESCALA_AR} ${ESCALA_AR} ${ESCALA_AR}`);
        
        logDebug('📦 Contenedor de estructura creado', 'success');
        
        // Crear plano base semitransparente
        const planoBase = document.createElement('a-plane');
        planoBase.setAttribute('position', '4 -0.2 0');
        planoBase.setAttribute('rotation', '-90 0 0');
        planoBase.setAttribute('width', '10');
        planoBase.setAttribute('height', '6');
        planoBase.setAttribute('color', '#ffffff');
        planoBase.setAttribute('opacity', '0.2');
        planoBase.setAttribute('transparent', true);
        estructuraAR.appendChild(planoBase);
        
        logDebug('⬜ Plano base agregado', 'info');
        
        // Crear nodos AR
        for (let i = 0; i < 8; i++) {
          const nodo = document.createElement('a-sphere');
          nodo.id = `nodo-ar-${i + 1}`;
          nodo.setAttribute('position', `${posicionesOriginales[i][0]} ${posicionesOriginales[i][1]} 0`);
          nodo.setAttribute('radius', '0.3');
          nodo.setAttribute('color', '#ff4444');
          nodo.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 12000');
          nodo.setAttribute('shadow', 'cast: true');
          
          // Agregar texto del número
          const texto = document.createElement('a-text');
          texto.setAttribute('value', (i + 1).toString());
          texto.setAttribute('position', '0 0.8 0');
          texto.setAttribute('align', 'center');
          texto.setAttribute('color', '#ffffff');
          texto.setAttribute('scale', '3 3 3');
          texto.setAttribute('geometry', 'primitive: plane; width: auto; height: auto');
          texto.setAttribute('material', 'color: #000000; transparent: true; opacity: 0.7');
          nodo.appendChild(texto);
          
          estructuraAR.appendChild(nodo);
          logDebug(`🔴 Nodo ${i+1} creado en (${posicionesOriginales[i][0]}, ${posicionesOriginales[i][1]})`, 'info');
        }
        
        // Agregar estructura a la escena
        const scene = document.querySelector('a-scene');
        if (scene) {
          scene.appendChild(estructuraAR);
          logDebug('✅ Estructura agregada a la escena', 'success');
        } else {
          logDebug('❌ No se encontró la escena A-Frame', 'error');
          return;
        }
        
        estructuraColocada = true;
        
        // Ocultar cursor y actualizar UI
        document.getElementById('ar-cursor').classList.remove('show');
        actualizarEstadoAR('✅ Estructura colocada exitosamente');
        document.getElementById('btn-deformacion').disabled = false;
        document.getElementById('deform-status').textContent = '¡Listo para deformar!';
        document.getElementById('reset-button').classList.add('show');
        
        logDebug('🎮 UI actualizada - controles habilitados', 'success');
        
        // Crear líneas después de un momento
        setTimeout(() => {
          actualizarLineas();
          logDebug('🔗 Líneas de conexión creadas', 'success');
        }, 500);
        
        // Pequeña animación de confirmación
        if (estructuraAR) {
          estructuraAR.setAttribute('animation', 'property: scale; from: 0.1 0.1 0.1; to: ' + ESCALA_AR + ' ' + ESCALA_AR + ' ' + ESCALA_AR + '; dur: 800; easing: easeOutBack');
          logDebug('🎬 Animación de colocación iniciada', 'info');
        }
        
        logDebug('🎉 Estructura AR colocada exitosamente!', 'success');
      }
      
      // Función para resetear estructura
      function resetearEstructura() {
        if (!modoAR) return;
        
        // Remover estructura existente
        if (estructuraAR) {
          estructuraAR.remove();
          estructuraAR = null;
        }
        
        // Limpiar líneas
        for (let i = 1; i <= 8; i++) {
          const linea = document.getElementById(`linea-${i}`);
          if (linea) linea.remove();
        }
        
        estructuraColocada = false;
        estructuraDeformada = false;
        
        // Actualizar UI
        document.getElementById('ar-cursor').classList.add('show');
        actualizarEstadoAR('Busca una superficie y toca para colocar');
        document.getElementById('btn-deformacion').disabled = true;
        document.getElementById('btn-deformacion').textContent = 'Mostrar Deformada';
        document.getElementById('btn-deformacion').style.backgroundColor = '#4488ff';
        document.getElementById('deform-status').textContent = 'Primero coloca la estructura';
        document.getElementById('reset-button').classList.remove('show');
        
        console.log('🔄 Estructura reseteada - Lista para nueva colocación');
      }
      
      // Función para actualizar estado AR
      function actualizarEstadoAR(mensaje) {
        const statusElement = document.getElementById('ar-status');
        if (statusElement) {
          statusElement.innerHTML = `<strong>Estado:</strong> ${mensaje}`;
        }
      }
      
      // Función para alternar deformación
      function toggleDeformacion() {
        if (!estructuraColocada) return;
        
        estructuraDeformada = !estructuraDeformada;
        const boton = document.getElementById('btn-deformacion');
        const debugInfo = document.getElementById('debug-info');
        
        let debugText = `<strong>Estado:</strong> ${estructuraDeformada ? 'DEFORMADA' : 'ORIGINAL'}<br>`;
        debugText += `<strong>Modo:</strong> ${modoAR ? 'AR' : '3D'}<br>`;
        debugText += `<strong>Factor:</strong> ${FACTOR_AMPLIFICACION}x<br><br>`;
        
        posicionesActuales = [];
        
        const prefijo = modoAR ? 'nodo-ar-' : 'nodo-';
        
        for (let i = 0; i < 8; i++) {
          const nodo = document.getElementById(`${prefijo}${i + 1}`);
          
          if (nodo) {
            let x, y;
            
            if (estructuraDeformada) {
              const desplX = desplazamientos[i].x * FACTOR_AMPLIFICACION;
              const desplY = desplazamientos[i].y * FACTOR_AMPLIFICACION;
              x = posicionesOriginales[i][0] + desplX;
              y = posicionesOriginales[i][1] + desplY;
              const rotZ = desplazamientos[i].rot * (180 / Math.PI) * FACTOR_AMPLIFICACION;
              
              nodo.setAttribute('position', {x: x, y: y, z: 0});
              nodo.setAttribute('rotation', {x: 0, y: 0, z: rotZ});
              nodo.setAttribute('material', 'color', '#ff8844');
              
              // Animación de deformación
              nodo.setAttribute('animation__deform', 'property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dur: 300; direction: alternate; loop: 2');
              
              if (Math.abs(desplX) > 0.001 || Math.abs(desplY) > 0.001 || Math.abs(rotZ) > 1) {
                debugText += `<span style="color: #ff8844;">N${i + 1}: Δ[${(desplX*1000).toFixed(1)}, ${(desplY*1000).toFixed(1)}]mm ∠${rotZ.toFixed(1)}°</span><br>`;
              } else {
                debugText += `N${i + 1}: Sin deformación significativa<br>`;
              }
            } else {
              x = posicionesOriginales[i][0];
              y = posicionesOriginales[i][1];
              
              nodo.setAttribute('position', {x: x, y: y, z: 0});
              nodo.setAttribute('rotation', {x: 0, y: 0, z: 0});
              nodo.setAttribute('material', 'color', '#ff4444');
              nodo.removeAttribute('animation__deform');
              
              debugText += `N${i + 1}: Posición original [${x}, ${y}]<br>`;
            }
            
            posicionesActuales[i] = {x: x, y: y};
          }
        }
        
        // Actualizar líneas con delay para animación
        setTimeout(() => {
          actualizarLineas();
        }, 200);
        
        if (debugInfo) {
          debugInfo.innerHTML = debugText;
        }
        
        if (boton) {
          boton.textContent = estructuraDeformada ? 'Mostrar Original' : 'Mostrar Deformada';
          boton.style.backgroundColor = estructuraDeformada ? '#ff6644' : '#4488ff';
        }
        
        actualizarEstadoAR(estructuraDeformada ? '🔧 Mostrando deformaciones' : '✅ Mostrando estructura original');
      }
      
      // Función para cambiar entre modo 3D y AR
      function cambiarModo(nuevoModoAR) {
        const btn3D = document.getElementById('btn-3d');
        const btnAR = document.getElementById('btn-ar');
        const modeInfo = document.getElementById('mode-info');
        const controlsText = document.getElementById('controls-text');
        const controlsDesc = document.getElementById('controls-desc');
        
        if (nuevoModoAR === modoAR) return;
        
        modoAR = nuevoModoAR;
        
        if (modoAR) {
          // Cambiar a modo AR
          if (!verificarHTTPS()) {
            modoAR = false;
            return;
          }
          
          // Verificar capacidades
          const capacidades = detectarCapacidades();
          if (!capacidades.getUserMedia) {
            mostrarError('Cámara no disponible', 'Tu navegador no soporta acceso a cámara');
            modoAR = false;
            return;
          }
          
          document.getElementById('permission-request').classList.add('show');
          
          // Actualizar UI
          document.body.classList.add('ar-mode');
          btn3D.classList.remove('active');
          btnAR.classList.add('active');
          modeInfo.innerHTML = '<strong>Modo:</strong> 📱 AR Superficie';
          controlsText.textContent = '🎮 Controles AR:';
          controlsDesc.textContent = 'Mueve el dispositivo y toca para colocar';
          
        } else {
          // Cambiar a modo 3D
          if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
          }
          
          // Limpiar video de fondo
          const video = document.getElementById('camera-feed');
          if (video) {
            video.remove();
          }
          
          // Restaurar escena 3D
          if (document.getElementById('ar-scene')) {
            location.reload();
            return;
          }
          
          // Actualizar UI
          document.body.classList.remove('ar-mode');
          btn3D.classList.add('active');
          btnAR.classList.remove('active');
          modeInfo.innerHTML = '<strong>Modo:</strong> 🖥️ 3D Normal';
          controlsText.textContent = '🎮 Controles 3D:';
          controlsDesc.textContent = 'Arrastra: Rotar • Pellizca: Zoom';
          
          // Ocultar popups
          document.getElementById('permission-request').classList.remove('show');
          document.getElementById('error-message').classList.remove('show');
          document.getElementById('loading').classList.remove('show');
          document.getElementById('ar-instructions').classList.remove('show');
          document.getElementById('reset-button').classList.remove('show');
          document.getElementById('ar-cursor').classList.remove('show');
          
          console.log('✅ Modo 3D activado');
        }
      }
      
      // Función para verificar soporte de AR
      function verificarSoporteAR() {
        const capacidades = detectarCapacidades();
        
        if (!capacidades.getUserMedia) {
          console.warn('⚠️ getUserMedia no soportado');
          return false;
        }
        
        if (!capacidades.https) {
          console.warn('⚠️ HTTPS requerido');
          return false;
        }
        
        return true;
      }
      
      // Inicialización principal
      window.addEventListener('DOMContentLoaded', function() {
        const estructura = document.getElementById('estructura-principal');
        const camara = document.getElementById('camara-principal');
        const boton = document.getElementById('btn-deformacion');
        const btn3D = document.getElementById('btn-3d');
        const btnAR = document.getElementById('btn-ar');
        
        console.log('🚀 Iniciando aplicación AR/3D...');
        
        // Detectar capacidades del dispositivo
        const capacidades = detectarCapacidades();
        
        // Verificar soporte AR
        if (!verificarSoporteAR()) {
          btnAR.disabled = true;
          btnAR.textContent = '❌ AR No Disponible';
          btnAR.style.background = '#666';
          btnAR.title = 'AR requiere HTTPS y cámara';
        }
        
        // Event listeners
        if (boton) {
          boton.addEventListener('click', toggleDeformacion);
        }
        
        if (btn3D) {
          btn3D.addEventListener('click', () => cambiarModo(false));
        }
        
        if (btnAR && !btnAR.disabled) {
          btnAR.addEventListener('click', () => cambiarModo(true));
        }
        
        // Configurar escena 3D
        estructura.setAttribute('scale', `${ESCALA} ${ESCALA} ${ESCALA}`);
        
        const Lv1 = 3, Lh1 = 4;
        const dimensionX = Lh1 * 2 * ESCALA;
        const dimensionY = Lv1 * 2 * ESCALA;
        const centroX = dimensionX / 2;
        const centroY = dimensionY / 2;
        const distanciaOptima = Math.max(dimensionX, dimensionY) * 3;
        const alturaOptima = dimensionY * 1.5;
        
        camara.setAttribute('position', `${centroX} ${alturaOptima} ${distanciaOptima}`);
        camara.setAttribute('look-at', `${centroX} ${centroY} 0`);
        
        // Crear líneas iniciales
        setTimeout(() => {
          actualizarLineas();
        }, 500);
        
        // Debug info inicial
        const debugInfo = document.getElementById('debug-info');
        if (debugInfo) {
          debugInfo.innerHTML = `
            <strong>Sistema:</strong> ${capacidades.mobile ? 'Móvil' : 'Desktop'}<br>
            <strong>Navegador:</strong> ${capacidades.chrome ? 'Chrome' : capacidades.safari ? 'Safari' : 'Otro'}<br>
            <strong>HTTPS:</strong> ${capacidades.https ? '✅' : '❌'}<br>
            <strong>Cámara:</strong> ${capacidades.getUserMedia ? '✅' : '❌'}<br>
            <strong>WebXR:</strong> ${capacidades.webxr ? '✅' : '❌'}
          `;
        }
        
        console.log('✅ Aplicación inicializada correctamente');
        console.log('📊 Capacidades:', capacidades);
      });
      
      // Limpieza al cerrar
      window.addEventListener('beforeunload', function() {
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
        }
      });
      
      // Prevenir zoom en iOS
      document.addEventListener('gesturestart', function (e) {
        e.preventDefault();
      });
      
      // Funciones globales
      window.reintentar = reintentar;
      window.solicitarPermisos = solicitarPermisos;
      window.cambiarModo = cambiarModo;
      window.cerrarInstrucciones = cerrarInstrucciones;
      window.resetearEstructura = resetearEstructura;
      window.colocarEstructuraManual = colocarEstructuraManual;
      window.toggleDebug = toggleDebug;
      window.clearDebugLog = clearDebugLog;
      
      // Variables globales para debug
      window.modoAR = false;
      window.estructuraColocada = false;
      window.arInitialized = false;
    </script>
  </body>
</html>

