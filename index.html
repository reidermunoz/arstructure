<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Estructura AR - Detección de Superficies</title>
    <meta name="description" content="AR con detección de planos usando WebXR y fallback a AR.js">
    
    <!-- A-Frame core -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        overflow: hidden;
        background: #000;
        touch-action: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
      
      .info {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 2000;
        max-width: 280px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        pointer-events: none;
      }
      
      .controls {
        position: fixed;
        bottom: 80px;
        left: 10px;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-size: 11px;
        z-index: 2000;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        pointer-events: none;
      }
      
      .deformation-control {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 2000;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        pointer-events: auto;
      }
      
      .deformation-control button {
        padding: 10px 18px;
        background: #4488ff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: bold;
        transition: all 0.3s ease;
        touch-action: manipulation;
        min-width: 140px;
        pointer-events: auto;
      }
      
      .mode-selector {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 2000;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        pointer-events: auto;
      }
      
      .mode-selector button {
        padding: 10px 14px;
        margin: 3px;
        background: #44ff44;
        color: black;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        touch-action: manipulation;
        transition: all 0.3s ease;
        min-width: 100px;
        pointer-events: auto;
      }
      
      .mode-selector button.active {
        background: #ffff44;
        color: black;
        transform: scale(1.05);
      }
      
      .ar-instructions {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,50,100,0.95);
        color: white;
        padding: 25px;
        border-radius: 12px;
        z-index: 3000;
        text-align: center;
        max-width: 85%;
        display: none;
        border: 2px solid #00aaff;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        pointer-events: auto;
      }
      
      .ar-instructions.show {
        display: block;
        animation: slideIn 0.5s ease-out;
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translate(-50%, -60%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
      }
      
      .ar-instructions button {
        padding: 12px 24px;
        background: #00aaff;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        margin: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        pointer-events: auto;
        touch-action: manipulation;
      }
      
      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.95);
        color: white;
        padding: 30px;
        border-radius: 12px;
        z-index: 3000;
        text-align: center;
        display: none;
        border: 1px solid #666;
        box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      }
      
      .loading.show {
        display: block;
      }
      
      .loading .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #333;
        border-top: 4px solid #00aaff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .error-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(150,0,0,0.95);
        color: white;
        padding: 25px;
        border-radius: 12px;
        z-index: 3000;
        text-align: center;
        display: none;
        max-width: 85%;
        border: 2px solid #ff4444;
        box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        pointer-events: auto;
      }
      
      .error-message.show {
        display: block;
      }
      
      .error-message button {
        padding: 10px 20px;
        background: #ff6666;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        margin: 8px;
        transition: all 0.3s ease;
        pointer-events: auto;
        touch-action: manipulation;
      }
      
      .permission-request {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,100,200,0.95);
        color: white;
        padding: 25px;
        border-radius: 12px;
        z-index: 3000;
        text-align: center;
        display: none;
        border: 2px solid #00aaff;
        box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        pointer-events: auto;
      }
      
      .permission-request.show {
        display: block;
      }
      
      .permission-request button {
        padding: 12px 24px;
        background: white;
        color: #0064c8;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        margin: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        pointer-events: auto;
        touch-action: manipulation;
      }
      
      .reset-button {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255,100,0,0.9);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        z-index: 2000;
        display: none;
        font-size: 14px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(255,100,0,0.3);
        pointer-events: auto;
        touch-action: manipulation;
      }
      
      .reset-button.show {
        display: block;
      }
      
      /* OVERLAY PRINCIPAL PARA CAPTURAR TOQUES */
      .ar-touch-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1500 !important;
        background: transparent !important;
        cursor: crosshair !important;
        display: none;
        touch-action: none !important;
        pointer-events: auto !important;
      }
      
      .ar-touch-overlay.active {
        display: block !important;
      }
      
      /* Indicador visual de toque */
      .touch-feedback {
        position: fixed;
        width: 60px;
        height: 60px;
        border: 4px solid #00ff00;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(0,255,0,0.3) 0%, transparent 70%);
        pointer-events: none;
        z-index: 2500;
        display: none;
        transform: translate(-50%, -50%);
        animation: touchPulse 0.6s ease-out;
      }
      
      .touch-feedback.show {
        display: block;
      }
      
      @keyframes touchPulse {
        0% { 
          opacity: 1; 
          transform: translate(-50%, -50%) scale(0.5); 
          border-color: #00ff00;
        }
        50% { 
          opacity: 0.8; 
          transform: translate(-50%, -50%) scale(1.2); 
          border-color: #44ff44;
        }
        100% { 
          opacity: 0; 
          transform: translate(-50%, -50%) scale(2); 
          border-color: #88ff88;
        }
      }
      
      /* Cursor AR */
      .ar-cursor {
        width: 50px;
        height: 50px;
        border: 3px solid #00ff00;
        border-radius: 50%;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 2000;
        display: none;
        background: rgba(0,255,0,0.1);
        animation: pulse 2s infinite;
      }
      
      .ar-cursor.show {
        display: block;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
        50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
      }
      
      /* Debug panel */
      .debug-panel {
        position: fixed;
        top: 200px;
        left: 10px;
        background: rgba(0,0,0,0.95);
        color: #00ff00;
        padding: 10px;
        border-radius: 5px;
        font-size: 9px;
        z-index: 2500;
        max-width: 300px;
        font-family: monospace;
        border: 1px solid #00ff00;
        display: none;
        max-height: 250px;
        overflow-y: auto;
        pointer-events: auto;
      }
      
      .debug-panel.show {
        display: block;
      }
      
      .debug-toggle {
        position: fixed;
        top: 120px;
        right: 10px;
        background: rgba(0,255,0,0.8);
        color: black;
        padding: 8px 12px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        z-index: 2500;
        width: 45px;
        height: 45px;
        pointer-events: auto;
        touch-action: manipulation;
      }
      
      .debug-entry {
        margin: 2px 0;
        padding: 2px 0;
        border-left: 2px solid #00ff00;
        padding-left: 5px;
        font-size: 8px;
      }
      
      .debug-error { color: #ff4444; border-left-color: #ff4444; }
      .debug-success { color: #44ff44; border-left-color: #44ff44; }
      .debug-info { color: #4444ff; border-left-color: #4444ff; }
      .debug-warning { color: #ffaa00; border-left-color: #ffaa00; }
      
      /* Video de cámara AR */
      .ar-camera-video {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        z-index: -1 !important;
        background: #000;
      }

      /* Estilos para elementos deshabilitados */
      button:disabled {
        background: #666 !important;
        cursor: not-allowed !important;
        opacity: 0.6;
      }
    </style>
  </head>
  <body>
    
    <!-- OVERLAY PRINCIPAL PARA CAPTURAR TOQUES -->
    <div id="ar-touch-overlay" class="ar-touch-overlay"></div>
    
    <!-- Feedback visual de toque -->
    <div id="touch-feedback" class="touch-feedback"></div>
    
    <div id="loading" class="loading">
      <h3>🚀 Iniciando AR</h3>
      <div class="spinner"></div>
      <p id="loading-text">Preparando cámara y detección de superficies...</p>
      <p><small>Esto puede tomar hasta 30 segundos</small></p>
    </div>
    
    <div id="error-message" class="error-message">
      <h3>❌ Error de AR</h3>
      <p id="error-text">No se pudo inicializar AR</p>
      <div id="error-details"></div>
      <button onclick="reintentar()">🔄 Reintentar</button>
      <button onclick="cambiarModo(false)">🖥️ Usar modo 3D</button>
    </div>
    
    <div id="permission-request" class="permission-request">
      <h3>🎥 Permisos de Cámara</h3>
      <p>Necesitamos acceso a tu cámara para AR</p>
      <p><small>Se usará para detectar superficies y colocar la estructura 3D</small></p>
      <button onclick="solicitarPermisos()">✅ Permitir Cámara</button>
      <button onclick="cambiarModo(false)">❌ Solo modo 3D</button>
    </div>
    
    <div id="ar-instructions" class="ar-instructions">
      <h3>🎯 AR Activado</h3>
      <p><strong>¡Listo para colocar estructura!</strong></p>
      <div style="text-align: left; margin: 15px 0;">
        <p>📱 <strong>Paso 1:</strong> Mantén el dispositivo estable</p>
        <p>👆 <strong>Paso 2:</strong> Toca CUALQUIER PARTE de la pantalla</p>
        <p>🏗️ <strong>Paso 3:</strong> La estructura aparecerá frente a ti</p>
      </div>
      <p><small><strong>Nota:</strong> Toca fuera de estos botones azules</small></p>
      <button onclick="cerrarInstrucciones()">¡Entendido!</button>
      <button onclick="colocarEstructuraManual()" style="background: #ff6600; margin-left: 10px;">🎯 Colocar Ahora</button>
    </div>
    
    <button id="debug-toggle" class="debug-toggle" onclick="toggleDebug()">🐛</button>
    
    <div id="debug-panel" class="debug-panel">
      <div style="border-bottom: 1px solid #00ff00; margin-bottom: 5px; padding-bottom: 3px;">
        <strong>🐛 DEBUG AR</strong>
        <button onclick="clearDebugLog()" style="float: right; background: #ff4444; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 8px;">Clear</button>
      </div>
      <div id="debug-log"></div>
    </div>
    
    <div id="ar-cursor" class="ar-cursor"></div>
    
    <div class="info">
      <h3>🏗️ Estructura de Nodos AR</h3>
      <p><strong>Nodos:</strong> 8 (esferas rojas)</p>
      <p><strong>Elementos:</strong> 8 (líneas azules)</p>
      <p id="mode-info"><strong>Modo:</strong> 3D Normal</p>
      <p id="ar-status"><strong>Estado:</strong> Esperando...</p>
      <div id="debug-info" style="margin-top: 8px; font-size: 9px; color: #bbb;">
        <strong>Sistema:</strong> Listo para usar
      </div>
    </div>
    
    <div class="deformation-control">
      <button id="btn-deformacion" disabled onclick="toggleDeformacion()">Mostrar Deformada</button>
      <p><small>Desplazamientos amplificados 5000x</small></p>
      <p><small id="deform-status">Primero coloca la estructura</small></p>
    </div>
    
    <div class="mode-selector">
      <p><strong>Modo de Vista:</strong></p>
      <button id="btn-3d" class="active" onclick="cambiarModo(false)">🖥️ 3D Normal</button>
      <button id="btn-ar" onclick="cambiarModo(true)">📱 AR Superficie</button>
    </div>
    
    <div class="controls">
      <strong id="controls-text">Controles 3D:</strong><br>
      <span id="controls-desc">Arrastra: Rotar • Pellizca: Zoom</span>
    </div>
    
    <button id="reset-button" class="reset-button" onclick="resetearEstructura()">
      🔄 Recolocar Estructura
    </button>

    <!-- Escena A-Frame -->
    <a-scene 
      id="main-scene"
      embedded 
      background="color: #f0f0f0"
      loading-screen="enabled: false"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      cursor="rayOrigin: mouse; downEvents: ; upEvents: ; clickEvents: ;"
      raycaster="far: 100; objects: .no-interaction">
      
      <!-- Iluminación -->
      <a-light type="ambient" color="#404040"></a-light>
      <a-light type="directional" position="2 4 2" color="#ffffff" intensity="0.8"></a-light>
      
      <!-- Entidad principal para modo 3D normal -->
      <a-entity id="estructura-principal">
        
        <!-- Plano de referencia (suelo) -->
        <a-plane id="suelo" 
                 position="4 -1 0" 
                 rotation="-90 0 0" 
                 width="12" 
                 height="8" 
                 color="#e8e8e8" 
                 opacity="0.7"
                 shadow="receive: true"></a-plane>
        
        <!-- Grid de referencia -->
        <a-entity id="grid">
          <a-cylinder position="0 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="8 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 0 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 6 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
        </a-entity>

        <!-- NODOS (Esferas) -->
        <a-sphere id="nodo-1" position="0 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="1" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-2" position="0 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="2" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-3" position="0 6 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="3" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-4" position="4 6 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="4" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-5" position="4 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="5" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-6" position="4 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="6" position="0 1 0" align="center" color="#ff0000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-7" position="8 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="7" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-8" position="8 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="8" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>

        <!-- Título informativo en 3D -->
        <a-text id="titulo-3d"
                position="4 8 0" 
                value="Estructura de Nodos y Elementos" 
                align="center" 
                color="#333333" 
                scale="6 6 6"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 20000"></a-text>
        
        <!-- Ejes de coordenadas -->
        <a-entity id="ejes" position="-2 -2 0">
          <a-cylinder position="1 0 0" radius="0.1" height="2" rotation="0 0 90" color="#ff0000"></a-cylinder>
          <a-text value="X" position="2.5 0 0" color="#ff0000" scale="4 4 4"></a-text>
          <a-cylinder position="0 1 0" radius="0.1" height="2" color="#00ff00"></a-cylinder>
          <a-text value="Y" position="0 2.5 0" color="#00ff00" scale="4 4 4"></a-text>
          <a-cylinder position="0 0 1" radius="0.1" height="2" rotation="90 0 0" color="#0000ff"></a-cylinder>
          <a-text value="Z" position="0 0 2.5" color="#0000ff" scale="4 4 4"></a-text>
        </a-entity>
      </a-entity>
      
      <!-- Cámara para modo 3D normal -->
      <a-camera id="camara-principal" 
                wasd-controls="acceleration: 5"
                look-controls="enabled: true; touchEnabled: true"
                cursor="rayOrigin: mouse"></a-camera>
    </a-scene>

    <script>
      // CONFIGURACIÓN GLOBAL
      const ESCALA = 3;
      const ESCALA_AR = 0.3; // CAMBIO CLAVE: Escala mucho más pequeña para AR
      
      // Estado de la aplicación
      let modoAR = false;
      let estructuraDeformada = false;
      let estructuraColocada = false;
      let arInitialized = false;
      let cameraStream = null;
      let estructuraAR = null;
      let touchOverlay = null;
      let debugVisible = false;
      let debugLog = [];
      
      // Datos de desplazamientos
      const desplazamientos = [
        {x: 0, y: 0, rot: 0},
        {x: -0.000214334467084222, y: -2.92585497916779e-05, rot: 0.000299282917049326},
        {x: -4.51228548254704e-05, y: -5.91445463001043e-05, rot: -0.00125414567113917},
        {x: -5.26077882706616e-05, y: -7.62472910434113e-05, rot: 0.00121519336768121},
        {x: -0.000205459371218351, y: -4.61332875518377e-05, rot: -0.000475039410395658},
        {x: 0, y: 0, rot: 0},
        {x: -0.000209509318349148, y: -1.46081626564844e-05, rot: 0.000595291931114151},
        {x: 0, y: 0, rot: 0}
      ];
      
      const FACTOR_AMPLIFICACION = 5000;
      
      // Conectividad de elementos
      const conectividad = [
        [0, 1], [1, 2], [2, 3], [3, 4], [1, 4], [4, 5], [4, 6], [6, 7]
      ];
      
      // Posiciones originales
      const posicionesOriginales = [
        [0, 0], [0, 3], [0, 6], [4, 6], [4, 3], [4, 0], [8, 3], [8, 0]
      ];
      
      // Sistema de debug
      function logDebug(mensaje, tipo = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const entry = { mensaje: `[${timestamp}] ${mensaje}`, tipo };
        debugLog.push(entry);
        
        if (debugLog.length > 100) debugLog.shift();
        
        console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
        
        if (debugVisible) actualizarDebugPanel();
      }
      
      function actualizarDebugPanel() {
        const panel = document.getElementById('debug-log');
        if (!panel) return;
        
        panel.innerHTML = debugLog.map(entry => 
          `<div class="debug-entry debug-${entry.tipo}">${entry.mensaje}</div>`
        ).join('');
        panel.scrollTop = panel.scrollHeight;
      }
      
      function toggleDebug() {
        debugVisible = !debugVisible;
        const panel = document.getElementById('debug-panel');
        const button = document.getElementById('debug-toggle');
        
        if (debugVisible) {
          panel.classList.add('show');
          button.textContent = '❌';
          button.style.background = 'rgba(255,0,0,0.8)';
          actualizarDebugPanel();
        } else {
          panel.classList.remove('show');
          button.textContent = '🐛';
          button.style.background = 'rgba(0,255,0,0.8)';
        }
      }
      
      function clearDebugLog() {
        debugLog = [];
        actualizarDebugPanel();
        logDebug('Debug log limpiado', 'info');
      }
      
      // FUNCIÓN PRINCIPAL PARA CONFIGURAR DETECCIÓN DE TOQUES
      function configurarDeteccionToques() {
        touchOverlay = document.getElementById('ar-touch-overlay');
        
        if (!touchOverlay) {
          logDebug('❌ CRÍTICO: No se encontró el overlay de toque', 'error');
          return false;
        }
        
        // Limpiar listeners existentes clonando el elemento
        const nuevoOverlay = touchOverlay.cloneNode(true);
        touchOverlay.parentNode.replaceChild(nuevoOverlay, touchOverlay);
        touchOverlay = nuevoOverlay;
        
        logDebug('🔧 Configurando detección de toques...', 'info');
        
        // Configurar múltiples tipos de eventos para máxima compatibilidad
        const eventos = ['touchstart', 'click', 'pointerdown'];
        
        let eventosConfigurados = 0;
        
        eventos.forEach(evento => {
          try {
            touchOverlay.addEventListener(evento, function(e) {
              logDebug(`🎯 Evento ${evento} capturado`, 'success');
              procesarToqueAR(e);
            }, {
              passive: false,
              capture: true
            });
            eventosConfigurados++;
          } catch (error) {
            logDebug(`⚠️ Error configurando evento ${evento}: ${error.message}`, 'warning');
          }
        });
        
        logDebug(`✅ ${eventosConfigurados} eventos configurados`, 'success');
        return true;
      }
      
      // FUNCIÓN PARA PROCESAR TOQUES EN AR
      function procesarToqueAR(event) {
        logDebug('🎯 TOQUE DETECTADO! Procesando...', 'success');
        
        // Mostrar feedback visual
        let x = window.innerWidth / 2;
        let y = window.innerHeight / 2;
        
        if (event.type === 'touchstart' && event.touches && event.touches.length > 0) {
          x = event.touches[0].clientX;
          y = event.touches[0].clientY;
        } else if (event.clientX !== undefined && event.clientY !== undefined) {
          x = event.clientX;
          y = event.clientY;
        }
        
        mostrarFeedbackToque(x, y);
        
        // Prevenir comportamiento por defecto
        try {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
        } catch (e) {
          logDebug(`⚠️ Error previniendo eventos: ${e.message}`, 'warning');
        }
        
        // Verificaciones de estado
        if (!modoAR) {
          logDebug('❌ No estamos en modo AR', 'error');
          return;
        }
        
        if (estructuraColocada) {
          logDebug('❌ Estructura ya colocada', 'warning');
          return;
        }
        
        if (!arInitialized) {
          logDebug('❌ AR no inicializado', 'error');
          return;
        }
        
        logDebug('🚀 Todas las validaciones pasaron! Colocando estructura...', 'success');
        
        // Calcular posición 3D más cercana a la cámara
        const posicion = {
          x: 0,
          y: 0,
          z: -2  // CAMBIO CLAVE: Más cerca de la cámara
        };
        
        colocarEstructuraAR(posicion);
      }
      
      // Función para mostrar feedback visual del toque
      function mostrarFeedbackToque(x, y) {
        const feedback = document.getElementById('touch-feedback');
        if (feedback) {
          feedback.style.left = x + 'px';
          feedback.style.top = y + 'px';
          feedback.classList.add('show');
          
          setTimeout(() => {
            feedback.classList.remove('show');
          }, 600);
        }
      }
      
      // Función para verificar HTTPS
      function verificarHTTPS() {
        const esSeguro = location.protocol === 'https:' || 
                        location.hostname === 'localhost' || 
                        location.hostname === '127.0.0.1';
        
        if (!esSeguro) {
          mostrarError('HTTPS requerido', 'AR requiere conexión segura (HTTPS) o localhost');
          return false;
        }
        return true;
      }
      
      // Función para detectar capacidades
      function detectarCapacidades() {
        const caps = {
          getUserMedia: !!(navigator.mediaDevices?.getUserMedia),
          https: window.isSecureContext,
          mobile: /Mobi|Android/i.test(navigator.userAgent),
          iOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
          chrome: /Chrome/.test(navigator.userAgent),
          safari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)
        };
        
        logDebug(`Capacidades: ${JSON.stringify(caps)}`, 'info');
        return caps;
      }
      
      // Función para solicitar permisos de cámara
      async function solicitarPermisos() {
        const permissionDiv = document.getElementById('permission-request');
        const loadingDiv = document.getElementById('loading');
        
        permissionDiv.classList.remove('show');
        loadingDiv.classList.add('show');
        
        try {
          logDebug('Solicitando permisos de cámara...', 'info');
          
          const constraints = {
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280, min: 640 },
              height: { ideal: 720, min: 480 }
            }
          };
          
          cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
          logDebug('✅ Permisos de cámara obtenidos', 'success');
          
          await inicializarAR();
          
        } catch (error) {
          logDebug(`❌ Error permisos: ${error.name} - ${error.message}`, 'error');
          loadingDiv.classList.remove('show');
          
          let mensaje = 'Error obteniendo permisos de cámara';
          let detalles = '';
          
          switch (error.name) {
            case 'NotAllowedError':
              mensaje = 'Permisos de cámara denegados';
              detalles = 'Por favor, permite el acceso a la cámara y recarga la página';
              break;
            case 'NotFoundError':
              mensaje = 'No se encontró cámara';
              detalles = 'Verifica que tu dispositivo tenga una cámara disponible';
              break;
            case 'NotSupportedError':
              mensaje = 'Navegador no compatible';
              detalles = 'Usa Chrome o Safari en dispositivo móvil';
              break;
            default:
              detalles = error.message;
          }
          
          mostrarError(mensaje, detalles);
        }
      }
      
      // Función para inicializar AR
      async function inicializarAR() {
        const loading = document.getElementById('loading');
        
        try {
          logDebug('🚀 Inicializando AR...', 'info');
          
          // Crear video de fondo
          const video = document.createElement('video');
          video.id = 'ar-camera-video';
          video.className = 'ar-camera-video';
          video.autoplay = true;
          video.muted = true;
          video.playsInline = true;
          
          if (cameraStream) {
            video.srcObject = cameraStream;
            await video.play();
            logDebug('📹 Video de cámara iniciado', 'success');
          }
          
          document.body.appendChild(video);
          
          // CAMBIO CLAVE: Modificar la escena existente en lugar de crear nueva
          const scene = document.getElementById('main-scene');
          scene.setAttribute('background', 'color: transparent');
          
          // Ocultar elementos 3D existentes
          const estructura3D = document.getElementById('estructura-principal');
          if (estructura3D) {
            estructura3D.setAttribute('visible', 'false');
          }
          
          // Configurar cámara AR
          const camera = document.getElementById('camara-principal');
          if (camera) {
            camera.setAttribute('look-controls', 'enabled: false');
            camera.setAttribute('wasd-controls', 'enabled: false');
            camera.setAttribute('position', '0 1.6 0');
          }
          
          // Configurar sistema de toques
          configurarDeteccionToques();
          
          // Finalizar inicialización
          setTimeout(() => {
            loading.classList.remove('show');
            document.getElementById('ar-instructions').classList.add('show');
            arInitialized = true;
            actualizarEstadoAR('✅ Listo - Toca la pantalla para colocar');
            logDebug('🎉 AR inicializado correctamente', 'success');
          }, 2000);
          
        } catch (error) {
          logDebug(`❌ Error inicializando AR: ${error.message}`, 'error');
          loading.classList.remove('show');
          mostrarError('Error inicializando AR', error.message);
        }
      }
      
      // Función para mostrar errores
      function mostrarError(titulo, detalles = '') {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const errorDetails = document.getElementById('error-details');
        
        document.getElementById('loading').classList.remove('show');
        errorText.textContent = titulo;
        errorDetails.innerHTML = detalles ? `<p><small>${detalles}</small></p>` : '';
        errorDiv.classList.add('show');
        
        logDebug(`ERROR: ${titulo} - ${detalles}`, 'error');
      }
      
      // Función para cerrar instrucciones
      function cerrarInstrucciones() {
        logDebug('📋 Cerrando instrucciones...', 'info');
        
        document.getElementById('ar-instructions').classList.remove('show');
        document.getElementById('ar-cursor').classList.add('show');
        
        // Activar overlay de toque
        if (touchOverlay) {
          touchOverlay.classList.add('active');
          logDebug('✅ Overlay de toque ACTIVADO', 'success');
        }
        
        actualizarEstadoAR('🎯 TOCA LA PANTALLA para colocar estructura');
      }
      
      // Función para colocar estructura manualmente
      function colocarEstructuraManual() {
        logDebug('🔧 COLOCACIÓN MANUAL FORZADA', 'warning');
        
        if (!modoAR) {
          modoAR = true;
        }
        
        if (!arInitialized) {
          arInitialized = true;
        }
        
        if (estructuraColocada) {
          if (estructuraAR) {
            estructuraAR.remove();
            estructuraAR = null;
          }
          estructuraColocada = false;
        }
        
        const posicion = { x: 0, y: 0, z: -2 };
        colocarEstructuraAR(posicion);
      }
      
      // Función para crear líneas entre nodos - VERSIÓN MEJORADA
      function crearLinea(id, punto1, punto2, color = '#4488ff') {
        const lineaExistente = document.getElementById(id);
        if (lineaExistente) lineaExistente.remove();
        
        // CAMBIO CLAVE: Usar a-cylinder para líneas más visibles
        const linea = document.createElement('a-cylinder');
        linea.id = id;
        
        // Calcular posición central y rotación
        const dx = punto2.x - punto1.x;
        const dy = punto2.y - punto1.y;
        const dz = (punto2.z || 0) - (punto1.z || 0);
        const distancia = Math.sqrt(dx*dx + dy*dy + dz*dz);
        
        const centroX = (punto1.x + punto2.x) / 2;
        const centroY = (punto1.y + punto2.y) / 2;
        const centroZ = ((punto1.z || 0) + (punto2.z || 0)) / 2;
        
        // Calcular rotación
        const rotacionY = Math.atan2(dx, dz) * (180 / Math.PI);
        const rotacionZ = -Math.atan2(dy, Math.sqrt(dx*dx + dz*dz)) * (180 / Math.PI);
        
        linea.setAttribute('position', `${centroX} ${centroY} ${centroZ}`);
        linea.setAttribute('rotation', `0 ${rotacionY} ${rotacionZ}`);
        linea.setAttribute('radius', '0.02');
        linea.setAttribute('height', distancia);
        linea.setAttribute('color', color);
        linea.setAttribute('opacity', '0.9');
        
        const contenedor = estructuraAR || document.querySelector('a-scene');
        if (contenedor) contenedor.appendChild(linea);
      }
      
      // Función para actualizar líneas
      function actualizarLineas() {
        for (let i = 0; i < conectividad.length; i++) {
          const [nodo1Idx, nodo2Idx] = conectividad[i];
          const lineaId = `linea-${i + 1}`;
          
          const prefijo = modoAR ? 'nodo-ar-' : 'nodo-';
          const nodo1 = document.getElementById(`${prefijo}${nodo1Idx + 1}`);
          const nodo2 = document.getElementById(`${prefijo}${nodo2Idx + 1}`);
          
          if (nodo1 && nodo2) {
            const pos1 = nodo1.getAttribute('position');
            const pos2 = nodo2.getAttribute('position');
            const color = estructuraDeformada ? '#ff8844' : '#4488ff';
            crearLinea(lineaId, pos1, pos2, color);
          }
        }
      }
      
      // FUNCIÓN PRINCIPAL PARA COLOCAR ESTRUCTURA EN AR - VERSIÓN MEJORADA
      function colocarEstructuraAR(posicion) {
        logDebug('🏗️ INICIANDO colocación de estructura AR...', 'success');
        logDebug(`📍 Posición: (${posicion.x}, ${posicion.y}, ${posicion.z})`, 'info');
        
        if (estructuraColocada && estructuraAR) {
          estructuraAR.remove();
          estructuraAR = null;
        }
        
        try {
          // Crear contenedor principal
          estructuraAR = document.createElement('a-entity');
          estructuraAR.id = 'estructura-ar';
          estructuraAR.setAttribute('position', `${posicion.x} ${posicion.y} ${posicion.z}`);
          estructuraAR.setAttribute('scale', `${ESCALA_AR} ${ESCALA_AR} ${ESCALA_AR}`);
          
          // CAMBIO CLAVE: Plano base más visible
          const plano = document.createElement('a-plane');
          plano.setAttribute('position', '4 -0.5 0');
          plano.setAttribute('rotation', '-90 0 0');
          plano.setAttribute('width', '12');
          plano.setAttribute('height', '8');
          plano.setAttribute('color', '#ffffff');
          plano.setAttribute('opacity', '0.3');
          plano.setAttribute('transparent', true);
          plano.setAttribute('material', 'side: double');
          estructuraAR.appendChild(plano);
          
          // Crear nodos con mejor visibilidad
          for (let i = 0; i < 8; i++) {
            const nodo = document.createElement('a-sphere');
            nodo.id = `nodo-ar-${i + 1}`;
            nodo.setAttribute('position', `${posicionesOriginales[i][0]} ${posicionesOriginales[i][1]} 0`);
            nodo.setAttribute('radius', '0.3'); // Más grande
            nodo.setAttribute('color', '#ff4444');
            nodo.setAttribute('material', 'metalness: 0.1; roughness: 0.3'); // Material más visible
            nodo.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 15000');
            
            // Texto del nodo más visible
            const texto = document.createElement('a-text');
            texto.setAttribute('value', (i + 1).toString());
            texto.setAttribute('position', '0 0.8 0');
            texto.setAttribute('align', 'center');
            texto.setAttribute('color', '#ffffff');
            texto.setAttribute('scale', '3 3 3');
            texto.setAttribute('geometry', 'primitive: plane; width: auto; height: auto');
            texto.setAttribute('material', 'color: #000000; transparent: true; opacity: 0.9');
            nodo.appendChild(texto);
            
            estructuraAR.appendChild(nodo);
          }
          
          // Agregar a la escena
          const scene = document.querySelector('a-scene');
          if (scene) {
            scene.appendChild(estructuraAR);
            logDebug('🎬 Estructura agregada a la escena', 'success');
          }
          
          // MARCAR COMO COLOCADA
          estructuraColocada = true;
          
          // Desactivar overlay
          if (touchOverlay) {
            touchOverlay.classList.remove('active');
          }
          
          // Actualizar UI
          document.getElementById('ar-cursor').classList.remove('show');
          document.getElementById('btn-deformacion').disabled = false;
          document.getElementById('deform-status').textContent = '¡Listo para deformar!';
          document.getElementById('reset-button').classList.add('show');
          actualizarEstadoAR('✅ Estructura colocada exitosamente');
          
          // Crear líneas después de un momento
          setTimeout(() => {
            try {
              actualizarLineas();
              logDebug('🔗 Líneas creadas', 'success');
            } catch (error) {
              logDebug(`⚠️ Error creando líneas: ${error.message}`, 'warning');
            }
          }, 500);
          
          // Animación de aparición
          estructuraAR.setAttribute('animation', 
            `property: scale; from: 0.05 0.05 0.05; to: ${ESCALA_AR} ${ESCALA_AR} ${ESCALA_AR}; dur: 1000; easing: easeOutBack`);
          
          logDebug('🎉 ESTRUCTURA AR COLOCADA EXITOSAMENTE!', 'success');
          
        } catch (error) {
          logDebug(`❌ ERROR colocando estructura: ${error.message}`, 'error');
        }
      }
      
      // Función para resetear estructura
      function resetearEstructura() {
        if (!modoAR) return;
        
        logDebug('🔄 Reseteando estructura...', 'info');
        
        if (estructuraAR) {
          estructuraAR.remove();
          estructuraAR = null;
        }
        
        // Limpiar líneas
        for (let i = 1; i <= 8; i++) {
          const linea = document.getElementById(`linea-${i}`);
          if (linea) linea.remove();
        }
        
        estructuraColocada = false;
        estructuraDeformada = false;
        
        // Reactivar overlay
        if (touchOverlay) {
          touchOverlay.classList.add('active');
        }
        
        // Actualizar UI
        document.getElementById('ar-cursor').classList.add('show');
        document.getElementById('btn-deformacion').disabled = true;
        document.getElementById('btn-deformacion').textContent = 'Mostrar Deformada';
        document.getElementById('btn-deformacion').style.backgroundColor = '#4488ff';
        document.getElementById('deform-status').textContent = 'Primero coloca la estructura';
        document.getElementById('reset-button').classList.remove('show');
        actualizarEstadoAR('Toca la pantalla para colocar estructura');
      }
      
      // Función para alternar deformación
      function toggleDeformacion() {
        if (!estructuraColocada) return;
        
        estructuraDeformada = !estructuraDeformada;
        const boton = document.getElementById('btn-deformacion');
        
        logDebug(`🔧 ${estructuraDeformada ? 'Aplicando' : 'Removiendo'} deformación`, 'info');
        
        const prefijo = modoAR ? 'nodo-ar-' : 'nodo-';
        
        for (let i = 0; i < 8; i++) {
          const nodo = document.getElementById(`${prefijo}${i + 1}`);
          if (!nodo) continue;
          
          let x, y;
          
          if (estructuraDeformada) {
            const desplX = desplazamientos[i].x * FACTOR_AMPLIFICACION;
            const desplY = desplazamientos[i].y * FACTOR_AMPLIFICACION;
            x = posicionesOriginales[i][0] + desplX;
            y = posicionesOriginales[i][1] + desplY;
            const rotZ = desplazamientos[i].rot * (180 / Math.PI) * FACTOR_AMPLIFICACION;
            
            nodo.setAttribute('position', {x, y, z: 0});
            nodo.setAttribute('rotation', {x: 0, y: 0, z: rotZ});
            nodo.setAttribute('material', 'color', '#ff8844');
            nodo.setAttribute('animation__deform', 'property: scale; from: 1 1 1; to: 1.3 1.3 1.3; dur: 400; direction: alternate; loop: 2');
          } else {
            x = posicionesOriginales[i][0];
            y = posicionesOriginales[i][1];
            
            nodo.setAttribute('position', {x, y, z: 0});
            nodo.setAttribute('rotation', {x: 0, y: 0, z: 0});
            nodo.setAttribute('material', 'color', '#ff4444');
            nodo.removeAttribute('animation__deform');
          }
        }
        
        // Actualizar líneas
        setTimeout(() => actualizarLineas(), 300);
        
        // Actualizar botón
        if (boton) {
          boton.textContent = estructuraDeformada ? 'Mostrar Original' : 'Mostrar Deformada';
          boton.style.backgroundColor = estructuraDeformada ? '#ff6644' : '#4488ff';
        }
        
        actualizarEstadoAR(estructuraDeformada ? '🔧 Mostrando deformaciones' : '✅ Estructura original');
      }
      
      // Función para actualizar estado AR
      function actualizarEstadoAR(mensaje) {
        const statusElement = document.getElementById('ar-status');
        if (statusElement) {
          statusElement.innerHTML = `<strong>Estado:</strong> ${mensaje}`;
        }
      }
      
      // Función para cambiar modo
      function cambiarModo(nuevoModoAR) {
        if (nuevoModoAR === modoAR) return;
        
        logDebug(`🔄 Cambiando a modo ${nuevoModoAR ? 'AR' : '3D'}`, 'info');
        
        const btn3D = document.getElementById('btn-3d');
        const btnAR = document.getElementById('btn-ar');
        
        modoAR = nuevoModoAR;
        
        if (modoAR) {
          if (!verificarHTTPS()) {
            modoAR = false;
            return;
          }
          
          const caps = detectarCapacidades();
          if (!caps.getUserMedia) {
            mostrarError('Cámara no disponible', 'Tu navegador no soporta acceso a cámara');
            modoAR = false;
            return;
          }
          
          // Activar modo AR
          document.getElementById('permission-request').classList.add('show');
          btn3D.classList.remove('active');
          btnAR.classList.add('active');
          document.getElementById('mode-info').innerHTML = '<strong>Modo:</strong> 📱 AR Superficie';
          document.getElementById('controls-text').textContent = '🎮 Controles AR:';
          document.getElementById('controls-desc').textContent = 'Mueve el dispositivo y toca para colocar';
          
        } else {
          // Activar modo 3D
          if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
          }
          
          const video = document.getElementById('ar-camera-video');
          if (video) video.remove();
          
          if (touchOverlay) {
            touchOverlay.classList.remove('active');
          }
          
          // Recargar para volver al modo 3D
          location.reload();
        }
      }
      
      // Función para reintentar
      function reintentar() {
        document.getElementById('error-message').classList.remove('show');
        if (modoAR) {
          if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
          }
          arInitialized = false;
          estructuraColocada = false;
          solicitarPermisos();
        }
      }
      
      // Inicialización principal
      window.addEventListener('DOMContentLoaded', function() {
        logDebug('🚀 Iniciando aplicación AR/3D', 'success');
        
        const caps = detectarCapacidades();
        
        // Verificar soporte AR
        const btnAR = document.getElementById('btn-ar');
        if (!caps.getUserMedia || !caps.https) {
          btnAR.disabled = true;
          btnAR.textContent = '❌ AR No Disponible';
          btnAR.style.background = '#666';
        }
        
        // Configurar escena 3D inicial
        const estructura = document.getElementById('estructura-principal');
        const camara = document.getElementById('camara-principal');
        
        if (estructura) {
          estructura.setAttribute('scale', `${ESCALA} ${ESCALA} ${ESCALA}`);
        }
        
        if (camara) {
          const Lv1 = 3, Lh1 = 4;
          const dimensionX = Lh1 * 2 * ESCALA;
          const dimensionY = Lv1 * 2 * ESCALA;
          const centroX = dimensionX / 2;
          const centroY = dimensionY / 2;
          const distanciaOptima = Math.max(dimensionX, dimensionY) * 3;
          const alturaOptima = dimensionY * 1.5;
          
          camara.setAttribute('position', `${centroX} ${alturaOptima} ${distanciaOptima}`);
          camara.setAttribute('look-at', `${centroX} ${centroY} 0`);
        }
        
        // Crear líneas iniciales después de un momento
        setTimeout(() => {
          actualizarLineas();
        }, 1000);
        
        // Actualizar debug info
        const debugInfo = document.getElementById('debug-info');
        if (debugInfo) {
          debugInfo.innerHTML = `
            <strong>Sistema:</strong> ${caps.mobile ? 'Móvil' : 'Desktop'}<br>
            <strong>Navegador:</strong> ${caps.chrome ? 'Chrome' : caps.safari ? 'Safari' : 'Otro'}<br>
            <strong>HTTPS:</strong> ${caps.https ? '✅' : '❌'}<br>
            <strong>Cámara:</strong> ${caps.getUserMedia ? '✅' : '❌'}
          `;
        }
        
        logDebug('✅ Aplicación inicializada correctamente', 'success');
      });
      
      // Limpieza al cerrar
      window.addEventListener('beforeunload', function() {
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
        }
      });
      
      // Prevenir gestos del navegador
      document.addEventListener('gesturestart', e => e.preventDefault());
      document.addEventListener('touchmove', function(e) {
        if (modoAR && e.target.closest('#ar-touch-overlay')) {
          e.preventDefault();
        }
      }, { passive: false });
      
      // Prevenir double-tap zoom
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
      
      // Funciones globales
      window.solicitarPermisos = solicitarPermisos;
      window.cambiarModo = cambiarModo;
      window.cerrarInstrucciones = cerrarInstrucciones;
      window.resetearEstructura = resetearEstructura;
      window.colocarEstructuraManual = colocarEstructuraManual;
      window.toggleDeformacion = toggleDeformacion;
      window.toggleDebug = toggleDebug;
      window.clearDebugLog = clearDebugLog;
      window.reintentar = reintentar;
      
      // Variables globales para debug
      window.modoAR = false;
      window.estructuraColocada = false;
      window.arInitialized = false;
      window.logDebug = logDebug;
      
      logDebug('🎯 Sistema de toques AR configurado y listo', 'success');
