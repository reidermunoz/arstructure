<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Estructura de Nodos y Elementos • A-Frame</title>
    <meta name="description" content="Visualización 3D de estructura con nodos y elementos conectados">
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
      }
      .info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 15px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 1000;
        max-width: 300px;
      }
      .controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 11px;
        z-index: 1000;
      }
      .deformation-control {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 15px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 1000;
        text-align: center;
      }
      .deformation-control button {
        padding: 10px 20px;
        background: #4488ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      .deformation-control button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
      .debug-info {
        margin-top: 10px;
        font-size: 10px;
        color: #ccc;
        max-height: 150px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="info">
      <h3>Estructura de Nodos y Elementos</h3>
      <p><strong>Nodos:</strong> 8 (esferas rojas)</p>
      <p><strong>Elementos:</strong> 8 (líneas azules)</p>
      <p><strong>Escala:</strong> 0.3 (30% del tamaño original)</p>
      <p><strong>Dimensiones escaladas:</strong> 2.4m × 1.8m</p>
      <p><strong>Amplificación:</strong> 50,000x</p>
      <div id="debug-info" class="debug-info">
        <strong>Debug:</strong> Presiona el botón para ver deformaciones...
      </div>
    </div>
    
    <div class="deformation-control">
      <button id="btn-deformacion">Mostrar Deformada</button>
      <p><small>Los desplazamientos están amplificados para visualización</small></p>
    </div>
    
    <div class="controls">
      <strong>Controles:</strong><br>
      Mouse: Rotar vista | WASD: Moverse | VR: Botón inferior derecho
    </div>

    <a-scene background="color: #f0f0f0" cursor="rayOrigin: mouse">
      
      <!-- Iluminación -->
      <a-light type="ambient" color="#404040"></a-light>
      <a-light type="directional" position="2 4 2" color="#ffffff" intensity="0.8"></a-light>
      
      <!-- Entidad principal que contiene toda la estructura -->
      <a-entity id="estructura-principal">
        
        <!-- Plano de referencia (suelo) -->
        <a-plane position="4 -1 0" 
                 rotation="-90 0 0" 
                 width="12" 
                 height="8" 
                 color="#e8e8e8" 
                 opacity="0.7"
                 shadow="receive: true"></a-plane>
        
        <!-- Grid de referencia -->
        <a-entity id="grid">
          <!-- Líneas verticales -->
          <a-cylinder position="0 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="8 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <!-- Líneas horizontales -->
          <a-cylinder position="4 0 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 6 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
        </a-entity>

        <!-- NODOS (Esferas) -->
        <!-- Nodo 1: [0,0] -->
        <a-sphere id="nodo-1" position="0 0 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="1" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 2: [0,3] -->
        <a-sphere id="nodo-2" position="0 3 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="2" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 3: [0,6] -->
        <a-sphere id="nodo-3" position="0 6 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="3" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 4: [4,6] -->
        <a-sphere id="nodo-4" position="4 6 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="4" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 5: [4,3] -->
        <a-sphere id="nodo-5" position="4 3 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="5" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 6: [4,0] -->
        <a-sphere id="nodo-6" position="4 0 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="6" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 7: [8,3] -->
        <a-sphere id="nodo-7" position="8 3 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="7" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <!-- Nodo 8: [8,0] -->
        <a-sphere id="nodo-8" position="8 0 0" 
                  radius="0.4" 
                  color="#ff4444" 
                  shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="8" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>

        <!-- ELEMENTOS (Líneas conectando nodos) -->
        <!-- Las líneas se crearán dinámicamente en JavaScript para seguir a los nodos -->

        <!-- Texto informativo en 3D -->
        <a-text position="4 8 0" 
                value="Estructura de Nodos y Elementos" 
                align="center" 
                color="#333333" 
                scale="6 6 6"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 20000"></a-text>
        
        <!-- Ejes de coordenadas -->
        <a-entity id="ejes" position="-2 -2 0">
          <!-- Eje X (rojo) -->
          <a-cylinder position="1 0 0" radius="0.1" height="2" rotation="0 0 90" color="#ff0000"></a-cylinder>
          <a-text value="X" position="2.5 0 0" color="#ff0000" scale="4 4 4"></a-text>
          
          <!-- Eje Y (verde) -->
          <a-cylinder position="0 1 0" radius="0.1" height="2" color="#00ff00"></a-cylinder>
          <a-text value="Y" position="0 2.5 0" color="#00ff00" scale="4 4 4"></a-text>
          
          <!-- Eje Z (azul) -->
          <a-cylinder position="0 0 1" radius="0.1" height="2" rotation="90 0 0" color="#0000ff"></a-cylinder>
          <a-text value="Z" position="0 0 2.5" color="#0000ff" scale="4 4 4"></a-text>
        </a-entity>
      </a-entity>
      
      <!-- Cámara posicionada dinámicamente -->
      <a-camera id="camara-principal" wasd-controls="acceleration: 5"></a-camera>
    </a-scene>

    <script>
      // ESCALA DE LA ESTRUCTURA - Cambiar aquí para escalar toda la estructura
      const ESCALA = 0.3; // Factor de escala (0.3 = 30% del tamaño original)
      
      // Datos de desplazamientos (X, Y en metros, Rotación en radianes)
      // Copiados exactamente del código Unity Vector3[] nodeDisplacements
      const desplazamientos = [
        {x: 0, y: 0, rot: 0}, // Nodo 1 - new Vector3(0f, 0f, 0f)
        {x: -0.000214334467084222, y: -2.92585497916779e-05, rot: 0.000299282917049326}, // Nodo 2
        {x: -4.51228548254704e-05, y: -5.91445463001043e-05, rot: -0.00125414567113917}, // Nodo 3
        {x: -5.26077882706616e-05, y: -7.62472910434113e-05, rot: 0.00121519336768121}, // Nodo 4
        {x: -0.000205459371218351, y: -4.61332875518377e-05, rot: -0.000475039410395658}, // Nodo 5
        {x: 0, y: 0, rot: 0}, // Nodo 6 - new Vector3(0f, 0f, 0f)
        {x: -0.000209509318349148, y: -1.46081626564844e-05, rot: 0.000595291931114151}, // Nodo 7
        {x: 0, y: 0, rot: 0} // Nodo 8 - new Vector3(0f, 0f, 0f)
      ];
      
      // Factor de amplificación para hacer visibles los desplazamientos microscópicos
      const FACTOR_AMPLIFICACION = 5000; // 50,000x amplificación
      
      let estructuraDeformada = false;
      
      // Conectividad de elementos (qué nodos conecta cada elemento)
      const conectividad = [
        [0, 1], // Elemento 1: Nodo 1-2
        [1, 2], // Elemento 2: Nodo 2-3
        [2, 3], // Elemento 3: Nodo 3-4
        [3, 4], // Elemento 4: Nodo 4-5
        [1, 4], // Elemento 5: Nodo 2-5
        [4, 5], // Elemento 6: Nodo 5-6
        [4, 6], // Elemento 7: Nodo 5-7
        [6, 7]  // Elemento 8: Nodo 7-8
      ];
      
      // Función para crear una línea entre dos puntos
      function crearLinea(id, punto1, punto2, color = '#4488ff') {
        // Eliminar línea existente si existe
        const lineaExistente = document.getElementById(id);
        if (lineaExistente) {
          lineaExistente.remove();
        }
        
        // Crear nueva línea usando A-Frame line geometry
        const linea = document.createElement('a-entity');
        linea.setAttribute('id', id);
        linea.setAttribute('line', {
          start: `${punto1.x} ${punto1.y} ${punto1.z || 0}`,
          end: `${punto2.x} ${punto2.y} ${punto2.z || 0}`,
          color: color,
          opacity: 0.8
        });
        
        // Agregar la línea a la estructura principal
        const estructura = document.getElementById('estructura-principal');
        estructura.appendChild(linea);
        
        console.log(`Línea ${id} creada: [${punto1.x.toFixed(2)}, ${punto1.y.toFixed(2)}] -> [${punto2.x.toFixed(2)}, ${punto2.y.toFixed(2)}]`);
      }
      
      // Función para actualizar todas las líneas
      function actualizarLineas() {
        console.log('Actualizando todas las líneas...');
        
        for (let i = 0; i < conectividad.length; i++) {
          const nodo1Idx = conectividad[i][0];
          const nodo2Idx = conectividad[i][1];
          const lineaId = `linea-${i + 1}`;
          
          // Obtener nodos
          const nodo1 = document.getElementById(`nodo-${nodo1Idx + 1}`);
          const nodo2 = document.getElementById(`nodo-${nodo2Idx + 1}`);
          
          if (nodo1 && nodo2) {
            // Obtener posiciones reales
            const pos1 = nodo1.getAttribute('position');
            const pos2 = nodo2.getAttribute('position');
            
            // Crear línea
            const color = estructuraDeformada ? '#ff8844' : '#4488ff';
            crearLinea(lineaId, pos1, pos2, color);
          }
        }
      }
      
      // Posiciones originales de los nodos (coordenadas MATLAB)
      const posicionesOriginales = [
        [0, 0], [0, 3], [0, 6], [4, 6], [4, 3], [4, 0], [8, 3], [8, 0]
      ];
      
      // Array para almacenar posiciones actuales de los nodos
      let posicionesActuales = [];
      
      // FUNCIÓN para alternar entre estructura original y deformada
      function toggleDeformacion() {
        console.log('=== TOGGLE DEFORMACIÓN ===');
        estructuraDeformada = !estructuraDeformada;
        const boton = document.getElementById('btn-deformacion');
        const debugInfo = document.getElementById('debug-info');
        
        console.log(`Estado: ${estructuraDeformada ? 'DEFORMADA' : 'ORIGINAL'}`);
        console.log(`Factor de amplificación: ${FACTOR_AMPLIFICACION}x`);
        
        let debugText = `<strong>Estado:</strong> ${estructuraDeformada ? 'DEFORMADA' : 'ORIGINAL'}<br>`;
        debugText += `<strong>Amplificación:</strong> ${FACTOR_AMPLIFICACION}x<br><br>`;
        
        // Reinicializar array de posiciones actuales
        posicionesActuales = [];
        
        for (let i = 0; i < 8; i++) {
          const nodo = document.getElementById(`nodo-${i + 1}`);
          
          if (nodo) {
            let x, y;
            
            if (estructuraDeformada) {
              // Aplicar desplazamientos amplificados
              const desplX = desplazamientos[i].x * FACTOR_AMPLIFICACION;
              const desplY = desplazamientos[i].y * FACTOR_AMPLIFICACION;
              x = posicionesOriginales[i][0] + desplX;
              y = posicionesOriginales[i][1] + desplY;
              const rotZ = desplazamientos[i].rot * (180 / Math.PI) * FACTOR_AMPLIFICACION; // rad to deg
              
              console.log(`NODO ${i + 1}:`);
              console.log(`  Unity: [${desplazamientos[i].x}, ${desplazamientos[i].y}, ${desplazamientos[i].rot}]`);
              console.log(`  Amplificado: [${desplX.toFixed(3)}, ${desplY.toFixed(3)}, ${rotZ.toFixed(1)}°]`);
              console.log(`  Nueva pos: [${x.toFixed(3)}, ${y.toFixed(3)}]`);
              
              // Aplicar transformaciones usando A-Frame API
              nodo.setAttribute('position', {x: x, y: y, z: 0});
              nodo.setAttribute('rotation', {x: 0, y: 0, z: rotZ});
              nodo.setAttribute('material', 'color', '#ff8844'); // Color naranja para deformada
              
              if (desplX !== 0 || desplY !== 0 || rotZ !== 0) {
                debugText += `<span style="color: #ff8844;">N${i + 1}: [${x.toFixed(1)}, ${y.toFixed(1)}] rot:${rotZ.toFixed(0)}°</span><br>`;
              } else {
                debugText += `N${i + 1}: [${x}, ${y}] sin desplazamiento<br>`;
              }
              
            } else {
              // Restaurar posiciones originales
              x = posicionesOriginales[i][0];
              y = posicionesOriginales[i][1];
              
              nodo.setAttribute('position', {x: x, y: y, z: 0});
              nodo.setAttribute('rotation', {x: 0, y: 0, z: 0});
              nodo.setAttribute('material', 'color', '#ff4444'); // Color rojo original
              
              console.log(`NODO ${i + 1} restaurado: [${x}, ${y}]`);
              debugText += `N${i + 1}: [${x}, ${y}] original<br>`;
            }
            
            // Guardar posición actual para cálculo de elementos
            posicionesActuales[i] = {x: x, y: y};
            
          } else {
            console.error(`❌ No se encontró nodo-${i + 1}`);
            debugText += `<span style="color: #ff4444;">N${i + 1}: ERROR - No encontrado</span><br>`;
          }
        }
        
        // Actualizar líneas después de mover nodos
        setTimeout(() => {
          actualizarLineas();
        }, 150); // Delay para que A-Frame procese las posiciones
        
        // Actualizar info en pantalla
        if (debugInfo) {
          debugInfo.innerHTML = debugText;
        }
        
        // Actualizar botón
        if (boton) {
          boton.textContent = estructuraDeformada ? 'Mostrar Original' : 'Mostrar Deformada';
          boton.style.backgroundColor = estructuraDeformada ? '#ff6644' : '#4488ff';
        }
        
        console.log(`=== ${estructuraDeformada ? 'DEFORMACIÓN APLICADA' : 'ESTRUCTURA RESTAURADA'} ===`);
      }
      
      // Aplicar escala cuando cargue la página
      window.addEventListener('DOMContentLoaded', function() {
        const estructura = document.getElementById('estructura-principal');
        const camara = document.getElementById('camara-principal');
        const boton = document.getElementById('btn-deformacion');
        
        // Configurar event listener del botón
        if (boton) {
          boton.addEventListener('click', toggleDeformacion);
          console.log('✅ Botón de deformación configurado');
        }
        
        // Crear líneas iniciales
        setTimeout(() => {
          actualizarLineas();
        }, 500); // Delay inicial para que todo esté cargado
        
        // Aplicar la escala a la estructura
        estructura.setAttribute('scale', `${ESCALA} ${ESCALA} ${ESCALA}`);
        
        // Calcular posición de cámara basada en la escala
        const Lv1 = 3, Lh1 = 4;
        const dimensionX = Lh1 * 2 * ESCALA;
        const dimensionY = Lv1 * 2 * ESCALA;
        const centroX = dimensionX / 2;
        const centroY = dimensionY / 2;
        
        // Ajustar cámara para vista desde arriba y lejos
        const distanciaOptima = Math.max(dimensionX, dimensionY) * 3;
        const alturaOptima = dimensionY * 1.5;
        
        camara.setAttribute('position', `${centroX} ${alturaOptima} ${distanciaOptima}`);
        camara.setAttribute('look-at', `${centroX} ${centroY} 0`);
        
        console.log(`Escala aplicada: ${ESCALA}`);
        console.log(`Dimensiones escaladas: ${dimensionX.toFixed(3)} x ${dimensionY.toFixed(3)}`);
        console.log(`Posición cámara: [${centroX.toFixed(3)}, ${alturaOptima.toFixed(3)}, ${distanciaOptima.toFixed(3)}]`);
        console.log('🚀 Sistema de deformación listo');
      });
    </script>
  </body>
</html>
