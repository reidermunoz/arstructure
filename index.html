<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Estructura AR con Detecci√≥n de Superficies</title>
    <meta name="description" content="Visualizaci√≥n AR con detecci√≥n de planos y colocaci√≥n por tap">
    
    <!-- A-Frame core -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- AR.js con hit-testing -->
    <script src="https://cdn.jsdelivr.net/npm/ar.js@2.2.2/aframe/build/aframe-ar.min.js"></script>
    
    <!-- Componente de hit-testing -->
    <script>
      // Componente para detecci√≥n de superficies por tap
      AFRAME.registerComponent('ar-hit-test', {
        init: function () {
          this.el.addEventListener('click', this.onClick.bind(this));
          this.el.addEventListener('touchstart', this.onTouch.bind(this));
          this.intersected = false;
        },

        onClick: function (evt) {
          if (modoAR && !estructuraColocada) {
            this.placeStructure(evt);
          }
        },

        onTouch: function (evt) {
          evt.preventDefault();
          if (modoAR && !estructuraColocada) {
            this.placeStructure(evt);
          }
        },

        placeStructure: function (evt) {
          // Calcular posici√≥n del tap en el mundo 3D
          const camera = document.querySelector('[camera]');
          const canvas = document.querySelector('a-scene').canvas;
          
          let clientX, clientY;
          if (evt.touches) {
            clientX = evt.touches[0].clientX;
            clientY = evt.touches[0].clientY;
          } else {
            clientX = evt.clientX;
            clientY = evt.clientY;
          }
          
          // Normalizar coordenadas de pantalla
          const rect = canvas.getBoundingClientRect();
          const x = ((clientX - rect.left) / rect.width) * 2 - 1;
          const y = -((clientY - rect.top) / rect.height) * 2 + 1;
          
          // Crear un rayo desde la c√°mara
          const raycaster = new THREE.Raycaster();
          const mouse = new THREE.Vector2(x, y);
          
          if (camera && camera.object3D) {
            raycaster.setFromCamera(mouse, camera.object3D.children[0]);
            
            // Colocar estructura a 1 metro de distancia en direcci√≥n del rayo
            const direction = raycaster.ray.direction;
            const distance = 1.0; // 1 metro de distancia
            const position = raycaster.ray.origin.clone().add(direction.multiplyScalar(distance));
            
            // Ajustar altura para que est√© en el suelo
            position.y = -0.5;
            
            colocarEstructura(position);
          }
        }
      });

      // Componente para reticle/cursor AR
      AFRAME.registerComponent('ar-cursor', {
        init: function () {
          this.raycaster = new THREE.Raycaster();
          this.mouse = new THREE.Vector2();
          
          // Crear reticle visual
          const geometry = new THREE.RingGeometry(0.02, 0.04, 32);
          const material = new THREE.MeshBasicMaterial({ 
            color: 0x00ff00, 
            transparent: true, 
            opacity: 0.8,
            side: THREE.DoubleSide
          });
          this.reticle = new THREE.Mesh(geometry, material);
          this.reticle.rotation.x = -Math.PI / 2; // Horizontal
          this.el.object3D.add(this.reticle);
          
          this.visible = false;
        },

        tick: function () {
          if (!modoAR || estructuraColocada) {
            this.reticle.visible = false;
            return;
          }
          
          // Actualizar posici√≥n del reticle
          const camera = document.querySelector('[camera]');
          if (camera && camera.object3D) {
            const direction = new THREE.Vector3(0, 0, -1);
            direction.applyQuaternion(camera.object3D.quaternion);
            
            const distance = 1.0;
            const position = camera.object3D.position.clone().add(direction.multiplyScalar(distance));
            position.y = -0.5; // Altura del suelo
            
            this.reticle.position.copy(position);
            this.reticle.visible = true;
          }
        }
      });
    </script>
    
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        overflow: hidden;
        background: #000;
      }
      
      .info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 11px;
        z-index: 1000;
        max-width: 250px;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      .controls {
        position: absolute;
        bottom: 60px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px;
        border-radius: 5px;
        font-size: 10px;
        z-index: 1000;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      .deformation-control {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 11px;
        z-index: 1000;
        text-align: center;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      .deformation-control button {
        padding: 8px 16px;
        background: #4488ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.3s ease;
        touch-action: manipulation;
      }
      
      .deformation-control button:hover,
      .deformation-control button:active {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
      
      .deformation-control button:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
      }
      
      .mode-selector {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 11px;
        z-index: 1000;
        text-align: center;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      .mode-selector button {
        padding: 8px 12px;
        margin: 2px;
        background: #44ff44;
        color: black;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
        touch-action: manipulation;
      }
      
      .mode-selector button.active {
        background: #ffff44;
        color: black;
      }
      
      .mode-selector button:disabled {
        background: #666;
        color: #ccc;
        cursor: not-allowed;
      }
      
      .ar-instructions {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 1500;
        text-align: center;
        max-width: 80%;
        display: none;
        border: 2px solid #00ff00;
      }
      
      .ar-instructions.show {
        display: block;
      }
      
      .ar-instructions h3 {
        color: #00ff00;
        margin-top: 0;
      }
      
      .debug-info {
        margin-top: 8px;
        font-size: 9px;
        color: #ccc;
        max-height: 120px;
        overflow-y: auto;
      }
      
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 2000;
        text-align: center;
        display: none;
      }
      
      .loading.show {
        display: block;
      }
      
      .error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,0,0,0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 2001;
        text-align: center;
        display: none;
        max-width: 80%;
      }
      
      .error-message.show {
        display: block;
      }
      
      .permission-request {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,100,200,0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 2002;
        text-align: center;
        display: none;
        border: 2px solid #00aaff;
      }
      
      .permission-request.show {
        display: block;
      }
      
      .permission-request button {
        padding: 10px 20px;
        background: white;
        color: #0064c8;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        margin: 5px;
      }
      
      .reset-button {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255,100,0,0.9);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1000;
        display: none;
      }
      
      .reset-button.show {
        display: block;
      }
      
      /* Ocultar elementos no esenciales en AR */
      .ar-mode .info,
      .ar-mode .controls {
        opacity: 0.8;
        font-size: 9px;
      }
      
      .ar-mode .mode-selector {
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    
    <div id="loading" class="loading">
      <h3>Iniciando AR...</h3>
      <p>Preparando detecci√≥n de superficies</p>
    </div>
    
    <div id="error-message" class="error-message">
      <h3>Error de AR</h3>
      <p id="error-text">No se pudo inicializar AR</p>
      <button onclick="reintentar()">Reintentar</button>
      <button onclick="cambiarModo(false)">Usar modo 3D</button>
    </div>
    
    <div id="permission-request" class="permission-request">
      <h3>üé• Permisos de C√°mara</h3>
      <p>Esta aplicaci√≥n necesita acceso a la c√°mara para AR</p>
      <p><small>Se usar√° para detectar superficies y colocar la estructura</small></p>
      <button onclick="solicitarPermisos()">‚úÖ Permitir C√°mara</button>
      <button onclick="cambiarModo(false)">‚ùå Solo modo 3D</button>
    </div>
    
    <div id="ar-instructions" class="ar-instructions">
      <h3>üéØ AR Listo</h3>
      <p><strong>Instrucciones:</strong></p>
      <p>1. Mueve tu dispositivo lentamente</p>
      <p>2. Apunta a una superficie plana (mesa, suelo)</p>
      <p>3. Ver√°s un c√≠rculo verde (cursor)</p>
      <p>4. <strong>Toca la pantalla</strong> para colocar la estructura</p>
      <button onclick="cerrarInstrucciones()">Entendido</button>
    </div>
    
    <div class="info">
      <h3>üèóÔ∏è Estructura AR</h3>
      <p><strong>Nodos:</strong> 8 (esferas rojas)</p>
      <p><strong>Elementos:</strong> 8 (l√≠neas azules)</p>
      <p id="mode-info"><strong>Modo:</strong> 3D Normal</p>
      <p id="ar-status"><strong>Estado:</strong> Esperando...</p>
      <div id="debug-info" class="debug-info">
        <strong>Debug:</strong> Presiona deformaci√≥n para ver cambios...
      </div>
    </div>
    
    <div class="deformation-control">
      <button id="btn-deformacion" disabled>Mostrar Deformada</button>
      <p><small>Desplazamientos amplificados 5000x</small></p>
      <p><small id="deform-status">Coloca la estructura primero</small></p>
    </div>
    
    <div class="mode-selector">
      <p><strong>Modo de Vista:</strong></p>
      <button id="btn-3d" class="active">üñ•Ô∏è 3D Normal</button>
      <button id="btn-ar">üì± AR Superficie</button>
    </div>
    
    <div class="controls">
      <strong id="controls-text">Controles 3D:</strong><br>
      <span id="controls-desc">Toca y arrastra: Rotar | Pellizca: Zoom</span>
    </div>
    
    <button id="reset-button" class="reset-button" onclick="resetearEstructura()">
      üîÑ Recolocar Estructura
    </button>

    <!-- Escena A-Frame -->
    <a-scene 
      id="main-scene"
      embedded 
      background="color: #f0f0f0"
      cursor="rayOrigin: mouse"
      loading-screen="enabled: false"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false">
      
      <!-- Iluminaci√≥n -->
      <a-light type="ambient" color="#404040"></a-light>
      <a-light type="directional" position="2 4 2" color="#ffffff" intensity="0.8"></a-light>
      
      <!-- Entidad principal para modo 3D normal -->
      <a-entity id="estructura-principal">
        
        <!-- Plano de referencia (suelo) -->
        <a-plane id="suelo" 
                 position="4 -1 0" 
                 rotation="-90 0 0" 
                 width="12" 
                 height="8" 
                 color="#e8e8e8" 
                 opacity="0.7"
                 shadow="receive: true"></a-plane>
        
        <!-- Grid de referencia -->
        <a-entity id="grid">
          <a-cylinder position="0 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="8 3 -0.1" radius="0.05" height="6" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 0 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 3 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
          <a-cylinder position="4 6 -0.1" radius="0.05" height="8" rotation="0 0 90" color="#cccccc" opacity="0.3"></a-cylinder>
        </a-entity>

        <!-- NODOS (Esferas) -->
        <a-sphere id="nodo-1" position="0 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="1" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-2" position="0 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="2" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-3" position="0 6 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="3" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-4" position="4 6 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="4" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-5" position="4 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="5" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-6" position="4 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="6" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-7" position="8 3 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="7" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>
        
        <a-sphere id="nodo-8" position="8 0 0" radius="0.4" color="#ff4444" shadow="cast: true"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
          <a-text value="8" position="0 1 0" align="center" color="#000" scale="4 4 4"></a-text>
        </a-sphere>

        <!-- T√≠tulo informativo en 3D -->
        <a-text id="titulo-3d"
                position="4 8 0" 
                value="Estructura de Nodos y Elementos" 
                align="center" 
                color="#333333" 
                scale="6 6 6"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 20000"></a-text>
        
        <!-- Ejes de coordenadas -->
        <a-entity id="ejes" position="-2 -2 0">
          <a-cylinder position="1 0 0" radius="0.1" height="2" rotation="0 0 90" color="#ff0000"></a-cylinder>
          <a-text value="X" position="2.5 0 0" color="#ff0000" scale="4 4 4"></a-text>
          <a-cylinder position="0 1 0" radius="0.1" height="2" color="#00ff00"></a-cylinder>
          <a-text value="Y" position="0 2.5 0" color="#00ff00" scale="4 4 4"></a-text>
          <a-cylinder position="0 0 1" radius="0.1" height="2" rotation="90 0 0" color="#0000ff"></a-cylinder>
          <a-text value="Z" position="0 0 2.5" color="#0000ff" scale="4 4 4"></a-text>
        </a-entity>
      </a-entity>
      
      <!-- C√°mara para modo 3D normal -->
      <a-camera id="camara-principal" 
                wasd-controls="acceleration: 5"
                look-controls="enabled: true; touchEnabled: true"
                cursor="rayOrigin: mouse"></a-camera>
    </a-scene>

    <script>
      // CONFIGURACI√ìN
      const ESCALA = 0.3;
      const ESCALA_AR = 0.08; // Escala m√°s peque√±a para AR
      
      // Estado de la aplicaci√≥n
      let modoAR = false;
      let estructuraDeformada = false;
      let estructuraColocada = false;
      let arInitialized = false;
      let cameraStream = null;
      let estructuraAR = null;
      
      // Datos de desplazamientos (id√©nticos al original)
      const desplazamientos = [
        {x: 0, y: 0, rot: 0},
        {x: -0.000214334467084222, y: -2.92585497916779e-05, rot: 0.000299282917049326},
        {x: -4.51228548254704e-05, y: -5.91445463001043e-05, rot: -0.00125414567113917},
        {x: -5.26077882706616e-05, y: -7.62472910434113e-05, rot: 0.00121519336768121},
        {x: -0.000205459371218351, y: -4.61332875518377e-05, rot: -0.000475039410395658},
        {x: 0, y: 0, rot: 0},
        {x: -0.000209509318349148, y: -1.46081626564844e-05, rot: 0.000595291931114151},
        {x: 0, y: 0, rot: 0}
      ];
      
      const FACTOR_AMPLIFICACION = 5000;
      
      // Conectividad de elementos
      const conectividad = [
        [0, 1], [1, 2], [2, 3], [3, 4], [1, 4], [4, 5], [4, 6], [6, 7]
      ];
      
      // Posiciones originales
      const posicionesOriginales = [
        [0, 0], [0, 3], [0, 6], [4, 6], [4, 3], [4, 0], [8, 3], [8, 0]
      ];
      
      let posicionesActuales = [];
      
      // Funci√≥n para verificar HTTPS
      function verificarHTTPS() {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          mostrarError('HTTPS requerido', 'AR requiere HTTPS o localhost');
          return false;
        }
        return true;
      }
      
      // Funci√≥n para solicitar permisos de c√°mara
      async function solicitarPermisos() {
        const permissionRequest = document.getElementById('permission-request');
        const loading = document.getElementById('loading');
        
        permissionRequest.classList.remove('show');
        loading.classList.add('show');
        
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });
          
          cameraStream = stream;
          console.log('‚úÖ Permisos de c√°mara obtenidos');
          
          inicializarAR();
          
        } catch (error) {
          console.error('‚ùå Error al solicitar permisos:', error);
          loading.classList.remove('show');
          
          let mensaje = 'No se pudieron obtener los permisos de c√°mara.';
          if (error.name === 'NotAllowedError') {
            mensaje = 'Permisos denegados. Permite el acceso y recarga.';
          } else if (error.name === 'NotFoundError') {
            mensaje = 'No se encontr√≥ una c√°mara.';
          }
          
          mostrarError('Error de permisos', mensaje);
        }
      }
      
      // Funci√≥n para mostrar errores
      function mostrarError(titulo, mensaje) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        document.getElementById('loading').classList.remove('show');
        errorText.textContent = mensaje;
        errorDiv.classList.add('show');
      }
      
      // Funci√≥n para reintentar
      function reintentar() {
        document.getElementById('error-message').classList.remove('show');
        if (modoAR) {
          solicitarPermisos();
        }
      }
      
      // Funci√≥n para cerrar instrucciones
      function cerrarInstrucciones() {
        document.getElementById('ar-instructions').classList.remove('show');
      }
      
      // Funci√≥n para crear l√≠nea
      function crearLinea(id, punto1, punto2, color = '#4488ff') {
        const lineaExistente = document.getElementById(id);
        if (lineaExistente) {
          lineaExistente.remove();
        }
        
        const linea = document.createElement('a-entity');
        linea.setAttribute('id', id);
        linea.setAttribute('line', {
          start: `${punto1.x} ${punto1.y} ${punto1.z || 0}`,
          end: `${punto2.x} ${punto2.y} ${punto2.z || 0}`,
          color: color,
          linewidth: 15,
          opacity: 0.8
        });
        
        // Agregar a la estructura AR si existe, sino a la principal
        const contenedor = estructuraAR || document.getElementById('estructura-principal');
        contenedor.appendChild(linea);
      }
      
      // Funci√≥n para actualizar l√≠neas
      function actualizarLineas() {
        for (let i = 0; i < conectividad.length; i++) {
          const nodo1Idx = conectividad[i][0];
          const nodo2Idx = conectividad[i][1];
          const lineaId = `linea-${i + 1}`;
          
          const prefijo = modoAR ? 'nodo-ar-' : 'nodo-';
          const nodo1 = document.getElementById(`${prefijo}${nodo1Idx + 1}`);
          const nodo2 = document.getElementById(`${prefijo}${nodo2Idx + 1}`);
          
          if (nodo1 && nodo2) {
            const pos1 = nodo1.getAttribute('position');
            const pos2 = nodo2.getAttribute('position');
            const color = estructuraDeformada ? '#ff8844' : '#4488ff';
            crearLinea(lineaId, pos1, pos2, color);
          }
        }
      }
      
      // Funci√≥n para colocar estructura en posici√≥n espec√≠fica
      function colocarEstructura(position) {
        if (estructuraColocada) return;
        
        console.log('üéØ Colocando estructura en:', position);
        
        // Crear contenedor de estructura AR
        estructuraAR = document.createElement('a-entity');
        estructuraAR.id = 'estructura-ar';
        estructuraAR.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
        estructuraAR.setAttribute('scale', `${ESCALA_AR} ${ESCALA_AR} ${ESCALA_AR}`);
        
        // Crear plano base transl√∫cido
        const planoBase = document.createElement('a-plane');
        planoBase.setAttribute('position', '4 -0.1 0');
        planoBase.setAttribute('rotation', '-90 0 0');
        planoBase.setAttribute('width', '12');
        planoBase.setAttribute('height', '8');
        planoBase.setAttribute('color', '#ffffff');
        planoBase.setAttribute('opacity', '0.3');
        planoBase.setAttribute('transparent', true);
        estructuraAR.appendChild(planoBase);
        
        // Crear nodos AR
        for (let i = 0; i < 8; i++) {
          const nodo = document.createElement('a-sphere');
          nodo.id = `nodo-ar-${i + 1}`;
          nodo.setAttribute('position', `${posicionesOriginales[i][0]} ${posicionesOriginales[i][1]} 0`);
          nodo.setAttribute('radius', '0.4');
          nodo.setAttribute('color', '#ff4444');
          nodo.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 10000');
          
          // Agregar texto del n√∫mero
          const texto = document.createElement('a-text');
          texto.setAttribute('value', (i + 1).toString());
          texto.setAttribute('position', '0 1 0');
          texto.setAttribute('align', 'center');
          texto.setAttribute('color', '#000');
          texto.setAttribute('scale', '4 4 4');
          nodo.appendChild(texto);
          
          estructuraAR.appendChild(nodo);
        }
        
        // Agregar estructura a la escena
        const scene = document.querySelector('a-scene');
        scene.appendChild(estructuraAR);
        
        estructuraColocada = true;
        
        // Actualizar UI
        actualizarEstadoAR('Estructura colocada');
        document.getElementById('btn-deformacion').disabled = false;
        document.getElementById('deform-status').textContent = 'Listo para deformar';
        document.getElementById('reset-button').classList.add('show');
        
        // Crear l√≠neas despu√©s de un momento
        setTimeout(() => {
          actualizarLineas();
        }, 500);
        
        console.log('‚úÖ Estructura AR colocada exitosamente');
      }
      
      // Funci√≥n para resetear estructura
      function resetearEstructura() {
        if (!modoAR) return;
        
        // Remover estructura existente
        if (estructuraAR) {
          estructuraAR.remove();
          estructuraAR = null;
        }
        
        // Limpiar l√≠neas
        for (let i = 1; i <= 8; i++) {
          const linea = document.getElementById(`linea-${i}`);
          if (linea) linea.remove();
        }
        
        estructuraColocada = false;
        estructuraDeformada = false;
        
        // Actualizar UI
        actualizarEstadoAR('Busca una superficie y toca para colocar');
        document.getElementById('btn-deformacion').disabled = true;
        document.getElementById('btn-deformacion').textContent = 'Mostrar Deformada';
        document.getElementById('btn-deformacion').style.backgroundColor = '#4488ff';
        document.getElementById('deform-status').textContent = 'Coloca la estructura primero';
        document.getElementById('reset-button').classList.remove('show');
        
        console.log('üîÑ Estructura reseteada');
      }
      
      // Funci√≥n para actualizar estado AR
      function actualizarEstadoAR(mensaje) {
        const statusElement = document.getElementById('ar-status');
        if (statusElement) {
          statusElement.innerHTML = `<strong>Estado:</strong> ${mensaje}`;
        }
      }
      
      // Funci√≥n para inicializar AR
      async function inicializarAR() {
        const loading = document.getElementById('loading');
        
        try {
          console.log('üöÄ Inicializando AR...');
          
          // Crear nueva escena AR
          const arScene = document.createElement('a-scene');
          arScene.id = 'ar-scene';
          arScene.setAttribute('embedded', true);
          arScene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; trackingMethod: best; sourceWidth: 1280; sourceHeight: 720; displayWidth: 1280; displayHeight: 720;');
          arScene.setAttribute('background', 'color: transparent');
          arScene.setAttribute('loading-screen', 'enabled: false');
          arScene.setAttribute('vr-mode-ui', 'enabled: false');
          arScene.setAttribute('device-orientation-permission-ui', 'enabled: false');
          
          // Agregar componentes de hit-test y cursor
          arScene.setAttribute('ar-hit-test', '');
          
          // Crear c√°mara AR
          const cameraAR = document.createElement('a-entity');
          cameraAR.setAttribute('camera', 'active: true');
          cameraAR.setAttribute('ar-cursor', '');
          arScene.appendChild(cameraAR);
          
          // Agregar iluminaci√≥n
          const ambientLight = document.createElement('a-light');
          ambientLight.setAttribute('type', 'ambient');
          ambientLight.setAttribute('color', '#666666');
          arScene.appendChild(ambientLight);
          
          const directionalLight = document.createElement('a-light');
          directionalLight.setAttribute('type', 'directional');
          directionalLight.setAttribute('position', '1 4 2');
          directionalLight.setAttribute('color', '#ffffff');
          directionalLight.setAttribute('intensity', '0.8');
          arScene.appendChild(directionalLight);
          
          // Event listeners para AR
          arScene.addEventListener('arjs-video-loaded', function() {
            console.log('üìπ C√°mara AR cargada');
            loading.classList.remove('show');
            document.getElementById('ar-instructions').classList.add('show');
            arInitialized = true;
            actualizarEstadoAR('Busca una superficie y toca para colocar');
          });
          
          // Reemplazar escena
          const oldScene = document.getElementById('main-scene');
          oldScene.parentNode.replaceChild(arScene, oldScene);
          
          // Timeout de seguridad
          setTimeout(() => {
            if (!arInitialized) {
              loading.classList.remove('show');
              mostrarError('Timeout AR', 'AR tard√≥ demasiado en cargar');
            }
          }, 15000);
          
        } catch (error) {
          console.error('‚ùå Error inicializando AR:', error);
          loading.classList.remove('show');
          mostrarError('Error AR', 'Error al inicializar: ' + error.message);
        }
      }
      
      // Funci√≥n para alternar deformaci√≥n
      function toggleDeformacion() {
        if (!estructuraColocada) return;
        
        estructuraDeformada = !estructuraDeformada;
        const boton = document.getElementById('btn-deformacion');
        const debugInfo = document.getElementById('debug-info');
        
        let debugText = `<strong>Estado:</strong> ${estructuraDeformada ? 'DEFORMADA' : 'ORIGINAL'}<br>`;
        debugText += `<strong>Modo:</strong> ${modoAR ? 'AR' : '3D'}<br>`;
        debugText += `<strong>Amplificaci√≥n:</strong> ${FACTOR_AMPLIFICACION}x<br><br>`;
        
        posicionesActuales = [];
        
        const prefijo = modoAR ? 'nodo-ar-' : 'nodo-';
        
        for (let i = 0; i < 8; i++) {
          const nodo = document.getElementById(`${prefijo}${i + 1}`);
          
          if (nodo) {
            let x, y;
            
            if (estructuraDeformada) {
              const desplX = desplazamientos[i].x * FACTOR_AMPLIFICACION;
              const desplY = desplazamientos[i].y * FACTOR_AMPLIFICACION;
              x = posicionesOriginales[i][0] + desplX;
              y = posicionesOriginales[i][1] + desplY;
              const rotZ = desplazamientos[i].rot * (180 / Math.PI) * FACTOR_AMPLIFICACION;
              
              nodo.setAttribute('position', {x: x, y: y, z: 0});
              nodo.setAttribute('rotation', {x: 0, y: 0, z: rotZ});
              nodo.setAttribute('material', 'color', '#ff8844');
              
              if (desplX !== 0 || desplY !== 0 || rotZ !== 0) {
                debugText += `<span style="color: #ff8844;">N${i + 1}: Œî[${desplX.toFixed(3)}, ${desplY.toFixed(3)}] ${rotZ.toFixed(1)}¬∞</span><br>`;
              } else {
                debugText += `N${i + 1}: Sin desplazamiento<br>`;
              }
            } else {
              x = posicionesOriginales[i][0];
              y = posicionesOriginales[i][1];
              
              nodo.setAttribute('position', {x: x, y: y, z: 0});
              nodo.setAttribute('rotation', {x: 0, y: 0, z: 0});
              nodo.setAttribute('material', 'color', '#ff4444');
              
              debugText += `N${i + 1}: Original [${x}, ${y}]<br>`;
            }
            
            posicionesActuales[i] = {x: x, y: y};
          }
        }
        
        // Actualizar l√≠neas
        setTimeout(() => {
          actualizarLineas();
        }, 150);
        
        if (debugInfo) {
          debugInfo.innerHTML = debugText;
        }
        
        if (boton) {
          boton.textContent = estructuraDeformada ? 'Mostrar Original' : 'Mostrar Deformada';
          boton.style.backgroundColor = estructuraDeformada ? '#ff6644' : '#4488ff';
        }
        
        actualizarEstadoAR(estructuraDeformada ? 'Mostrando deformaci√≥n' : 'Mostrando original');
      }
      
      // Funci√≥n para cambiar entre modo 3D y AR
      function cambiarModo(nuevoModoAR) {
        const btn3D = document.getElementById('btn-3d');
        const btnAR = document.getElementById('btn-ar');
        const modeInfo = document.getElementById('mode-info');
        const controlsText = document.getElementById('controls-text');
        const controlsDesc = document.getElementById('controls-desc');
        
        if (nuevoModoAR === modoAR) return;
        
        modoAR = nuevoModoAR;
        
        if (modoAR) {
          // Cambiar a modo AR
          if (!verificarHTTPS()) {
            modoAR = false;
            return;
          }
          
          document.getElementById('permission-request').classList.add('show');
          
          // Actualizar UI
          document.body.classList.add('ar-mode');
          btn3D.classList.remove('active');
          btnAR.classList.add('active');
          modeInfo.innerHTML = '<strong>Modo:</strong> AR Superficie';
          controlsText.textContent = 'Controles AR:';
          controlsDesc.textContent = 'Mueve el dispositivo y toca para colocar';
          
        } else {
          // Cambiar a modo 3D
          if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
          }
          
          // Restaurar escena 3D
          if (document.getElementById('ar-scene')) {
            location.reload();
            return;
          }
          
          // Actualizar UI
          document.body.classList.remove('ar-mode');
          btn3D.classList.add('active');
          btnAR.classList.remove('active');
          modeInfo.innerHTML = '<strong>Modo:</strong> 3D Normal';
          controlsText.textContent = 'Controles 3D:';
          controlsDesc.textContent = 'Toca y arrastra: Rotar | Pellizca: Zoom';
          
          // Ocultar popups
          document.getElementById('permission-request').classList.remove('show');
          document.getElementById('error-message').classList.remove('show');
          document.getElementById('loading').classList.remove('show');
          document.getElementById('ar-instructions').classList.remove('show');
          document.getElementById('reset-button').classList.remove('show');
          
          console.log('‚úÖ Modo 3D activado');
        }
      }
      
      // Funci√≥n para verificar soporte de AR
      function verificarSoporteAR() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          console.warn('‚ö†Ô∏è getUserMedia no soportado');
          return false;
        }
        
        if (!window.isSecureContext) {
          console.warn('‚ö†Ô∏è Contexto no seguro');
          return false;
        }
        
        return true;
      }
      
      // Inicializaci√≥n principal
      window.addEventListener('DOMContentLoaded', function() {
        const estructura = document.getElementById('estructura-principal');
        const camara = document.getElementById('camara-principal');
        const boton = document.getElementById('btn-deformacion');
        const btn3D = document.getElementById('btn-3d');
        const btnAR = document.getElementById('btn-ar');
        
        // Verificar soporte AR
        if (!verificarSoporteAR()) {
          btnAR.disabled = true;
          btnAR.textContent = '‚ùå AR No Disponible';
          btnAR.style.background = '#666';
        }
        
        // Event listeners
        if (boton) {
          boton.addEventListener('click', toggleDeformacion);
        }
        
        if (btn3D) {
          btn3D.addEventListener('click', () => cambiarModo(false));
        }
        
        if (btnAR && !btnAR.disabled) {
          btnAR.addEventListener('click', () => cambiarModo(true));
        }
        
        // Configurar escena 3D
        estructura.setAttribute('scale', `${ESCALA} ${ESCALA} ${ESCALA}`);
        
        const Lv1 = 3, Lh1 = 4;
        const dimensionX = Lh1 * 2 * ESCALA;
        const dimensionY = Lv1 * 2 * ESCALA;
        const centroX = dimensionX / 2;
        const centroY = dimensionY / 2;
        const distanciaOptima = Math.max(dimensionX, dimensionY) * 3;
        const alturaOptima = dimensionY * 1.5;
        
        camara.setAttribute('position', `${centroX} ${alturaOptima} ${distanciaOptima}`);
        camara.setAttribute('look-at', `${centroX} ${centroY} 0`);
        
        // Crear l√≠neas iniciales
        setTimeout(() => {
          actualizarLineas();
        }, 500);
        
        console.log('üöÄ Sistema AR/3D inicializado');
        console.log('üîí HTTPS:', location.protocol === 'https:');
        console.log('üì± M√≥vil:', /Mobi|Android/i.test(navigator.userAgent));
        console.log('üé• getUserMedia:', !!navigator.mediaDevices?.getUserMedia);
      });
      
      // Limpieza al cerrar
      window.addEventListener('beforeunload', function() {
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
        }
      });
      
      // Funciones globales
      window.reintentar = reintentar;
      window.solicitarPermisos = solicitarPermisos;
      window.cambiarModo = cambiarModo;
      window.cerrarInstrucciones = cerrarInstrucciones;
      window.resetearEstructura = resetearEstructura;
      
      // Variables globales para componentes AR
      window.modoAR = false;
      window.estructuraColocada = false;
      window.colocarEstructura = colocarEstructura;
    </script>
  </body>
</html>
