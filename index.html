<!DOCTYPE html>
<html>
<head>
    <title>AR Detecci√≥n de Superficies</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        .info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            font-size: 11px;
            max-width: 280px;
            line-height: 1.4;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 15px;
            z-index: 100;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 0 5px;
            font-size: 12px;
            cursor: pointer;
        }
        .status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
            text-align: center;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    
    <div class="info">
        <strong>DETECCI√ìN DE SUPERFICIES:</strong><br>
        1. Mueve lentamente el celular<br>
        2. Apunta a superficies planas (mesa, piso)<br>
        3. Toca "Colocar" cuando detecte superficie<br>
        4. Los objetos se anclan autom√°ticamente
    </div>
    
    <div class="status" id="status">
        üîç Analizando superficies...
    </div>
    
    <div class="controls">
        <button onclick="placeObject()">üìç Colocar Objeto</button>
        <button onclick="clearObjects()">üßπ Limpiar</button>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
        vr-mode-ui="enabled: false"
        surface-detector
        id="scene">
        
        <!-- Contenedor para objetos anclados a superficies -->
        <a-entity id="surface-objects">
            <!-- Los objetos se anclan aqu√≠ cuando se detectan superficies -->
        </a-entity>
        
        <!-- Indicador visual de superficie detectada -->
        <a-entity id="surface-indicator">
            <a-ring 
                position="0 -1 -2" 
                radius-inner="0.8" 
                radius-outer="1" 
                color="#00ff00" 
                opacity="0"
                animation__pulse="property: scale; to: 1.2 1.2 1.2; direction: alternate; loop: true; dur: 800">
            </a-ring>
        </a-entity>
        
        <!-- C√°mara AR -->
        <a-camera 
            id="camera"
            look-controls-enabled="true"
            wasd-controls-enabled="false"
            cursor="rayOrigin: mouse">
        </a-camera>
    </a-scene>

    <script>
        let surfaceDetected = false;
        let objectCount = 0;
        let surfacePosition = {x: 0, y: -1, z: -2};
        
        // Componente para detectar superficies
        AFRAME.registerComponent('surface-detector', {
            init: function() {
                this.tick = AFRAME.utils.throttleTick(this.tick, 100, this);
                this.camera = document.querySelector('#camera');
                this.indicator = document.querySelector('#surface-indicator');
                this.status = document.getElementById('status');
                this.lastDetection = 0;
            },
            
            tick: function(time) {
                // Simular detecci√≥n de superficie basada en movimiento de c√°mara
                const cameraPosition = this.camera.getAttribute('position');
                const cameraRotation = this.camera.getAttribute('rotation');
                
                // Detectar si la c√°mara est√° apuntando hacia abajo (superficie horizontal)
                const isPointingDown = cameraRotation.x > -45 && cameraRotation.x < 45;
                const isStable = Math.abs(cameraRotation.x - this.lastRotationX || 0) < 2;
                
                if (isPointingDown && isStable && (time - this.lastDetection > 1000)) {
                    this.detectSurface(cameraPosition, cameraRotation);
                    this.lastDetection = time;
                }
                
                this.lastRotationX = cameraRotation.x;
            },
            
            detectSurface: function(camPos, camRot) {
                // Calcular posici√≥n de superficie frente a la c√°mara
                const distance = 2;
                const radY = (camRot.y * Math.PI) / 180;
                const radX = (camRot.x * Math.PI) / 180;
                
                surfacePosition = {
                    x: camPos.x + Math.sin(radY) * distance,
                    y: camPos.y - Math.sin(radX) * distance - 1,
                    z: camPos.z - Math.cos(radY) * distance
                };
                
                // Mostrar indicador de superficie
                this.indicator.setAttribute('position', surfacePosition);
                this.indicator.children[0].setAttribute('opacity', '0.6');
                
                if (!surfaceDetected) {
                    surfaceDetected = true;
                    this.status.innerHTML = '‚úÖ Superficie detectada!<br>Toca "Colocar" para anclar objetos';
                    this.status.style.background = 'rgba(0,150,0,0.8)';
                    
                    setTimeout(() => {
                        this.status.style.display = 'none';
                    }, 3000);
                    
                    console.log('Superficie detectada en:', surfacePosition);
                }
            }
        });
        
        // Funci√≥n para colocar objetos en la superficie detectada
        function placeObject() {
            if (!surfaceDetected) {
                alert('Primero detecta una superficie moviendo lentamente el celular');
                return;
            }
            
            const container = document.querySelector('#surface-objects');
            const shapes = ['box', 'sphere', 'cylinder', 'octahedron'];
            const colors = ['#4CC3D9', '#EF2D5E', '#FFC65D', '#7BC8A4', '#A55EEA', '#FF6B9D'];
            
            const randomShape = shapes[Math.floor(Math.random() * shapes.length)];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            // Crear objeto anclado a la superficie
            const entity = document.createElement('a-entity');
            entity.setAttribute('id', `surface-obj-${objectCount++}`);
            entity.setAttribute('geometry', {
                primitive: randomShape,
                radius: randomShape === 'sphere' ? 0.3 : undefined,
                width: randomShape === 'box' ? 0.4 : undefined,
                height: randomShape === 'box' ? 0.4 : undefined,
                depth: randomShape === 'box' ? 0.4 : undefined
            });
            entity.setAttribute('material', {color: randomColor, opacity: 0.9});
            
            // Posici√≥n ANCLADA a la superficie detectada
            entity.setAttribute('position', {
                x: surfacePosition.x + (Math.random() - 0.5) * 2,
                y: surfacePosition.y + 0.2,
                z: surfacePosition.z + (Math.random() - 0.5) * 2
            });
            
            // Animaci√≥n sutil
            entity.setAttribute('animation', {
                property: 'rotation',
                to: '0 360 0',
                loop: true,
                dur: Math.random() * 3000 + 2000
            });
            
            container.appendChild(entity);
            console.log(`Objeto ${objectCount} anclado a superficie en:`, entity.getAttribute('position'));
        }
        
        // Limpiar objetos
        function clearObjects() {
            const container = document.querySelector('#surface-objects');
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            objectCount = 0;
            
            // Resetear detecci√≥n
            surfaceDetected = false;
            document.querySelector('#surface-indicator').children[0].setAttribute('opacity', '0');
            document.getElementById('status').innerHTML = 'üîç Analizando superficies...';
            document.getElementById('status').style.display = 'block';
            document.getElementById('status').style.background = 'rgba(0,0,0,0.8)';
        }
        
        // Inicializaci√≥n
        window.addEventListener('load', function() {
            console.log('Sistema de detecci√≥n de superficies iniciado');
            
            setTimeout(() => {
                console.log('Mueve el celular lentamente para detectar superficies');
            }, 2000);
        });
    </script>
</body>
</html>
